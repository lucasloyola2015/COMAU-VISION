<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vision System</title>
  <link rel="stylesheet" href="/static/styles.css">
  <script src="/static/common.js"></script>
  <style>
    body {
      padding: 24px;
      background: var(--bg-primary);
    }
    
    .model-item {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      padding: var(--space-md);
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      margin-bottom: var(--space-md);
    }
    
    .model-label {
      flex: 0 0 150px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .model-path {
      flex: 1;
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      font-family: 'Consolas', monospace;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .model-status {
      flex: 0 0 auto;
      padding: 4px 12px;
      border-radius: var(--radius-sm);
      font-size: var(--font-size-xs);
      font-weight: 600;
    }
    
    .status-loaded {
      background: rgba(40, 167, 69, 0.2);
      color: #28a745;
    }
    
    .status-not-loaded {
      background: rgba(220, 53, 69, 0.2);
      color: #dc3545;
    }
  </style>
</head>
<body>
  <!-- Header con título y botón de guardar -->
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
    <h1 style="color: var(--text-primary); margin: 0;">Vision System</h1>
    <button id="btnSaveAll" class="btn btn-primary">
      Guardar
    </button>
  </div>
  
  <!-- Card de Configuración -->
  <div class="card">
    <h2 style="font-size: var(--font-size-md); margin-bottom: var(--space-xs); font-weight: 600; color: var(--text-primary);">
      Configuración
    </h2>
    
    <!-- Checkboxes en 2 columnas -->
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-sm);">
      <div style="display: flex; align-items: center; gap: var(--space-sm);">
        <input type="checkbox" id="chkUseBaseFrame" style="width: 16px; height: 16px; cursor: pointer; accent-color: var(--brand-red);">
        <label for="chkUseBaseFrame" style="font-size: var(--font-size-xs); color: var(--text-primary); cursor: pointer; user-select: none;">
          Usar BaseFrame Guardado
        </label>
      </div>
      
      <div style="display: flex; align-items: center; gap: var(--space-sm);">
        <input type="checkbox" id="chkUseToolFrame" style="width: 16px; height: 16px; cursor: pointer; accent-color: var(--brand-red);">
        <label for="chkUseToolFrame" style="font-size: var(--font-size-xs); color: var(--text-primary); cursor: pointer; user-select: none;">
          Usar ToolFrame Guardado
        </label>
      </div>
      
      <div style="display: flex; align-items: center; gap: var(--space-sm);">
        <input type="checkbox" id="chkUseROI" style="width: 16px; height: 16px; cursor: pointer; accent-color: var(--brand-red);">
        <label for="chkUseROI" style="font-size: var(--font-size-xs); color: var(--text-primary); cursor: pointer; user-select: none;">
          Usar ROI
        </label>
      </div>
      
      <div style="display: flex; align-items: center; gap: var(--space-sm);">
        <input type="checkbox" id="chkUseBoundingBox" style="width: 16px; height: 16px; cursor: pointer; accent-color: var(--brand-red);">
        <label for="chkUseBoundingBox" style="font-size: var(--font-size-xs); color: var(--text-primary); cursor: pointer; user-select: none;">
          Usar BoundingBox Junta
        </label>
      </div>
    </div>
  </div>
  
  <div class="card" style="margin-top: var(--space-sm);">
    <h2 style="font-size: var(--font-size-md); margin-bottom: var(--space-xs); font-weight: 600; color: var(--text-primary);">
      Vision Server
    </h2>
    
    <div class="model-item" style="padding: var(--space-xs) var(--space-sm);">
      <div class="model-label" style="flex: 0 0 120px; font-size: var(--font-size-xs);">IP Servidor</div>
      <input type="text" id="visionServerIpInput" placeholder="127.0.0.1"
             style="flex: 0 0 160px; padding: 4px 8px; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: var(--font-size-xs); font-family: 'Consolas', monospace;">
      <div class="model-label" style="flex: 0 0 60px; font-size: var(--font-size-xs); margin-left: var(--space-xs);">Puerto</div>
      <input type="number" id="visionServerPortInput" placeholder="8000" min="1000" max="65535"
             style="flex: 0 0 80px; padding: 4px 8px; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: var(--font-size-xs); font-family: 'Consolas', monospace;">
      <div class="model-status status-not-loaded" id="visionServerStatus" style="font-size: var(--font-size-xs); padding: 1px 6px;">Offline</div>
    </div>
    
    <div style="margin-top: var(--space-sm); padding: var(--space-sm); background: var(--bg-secondary); border-radius: var(--radius-sm); border: 1px solid var(--border);">
      <div style="display: flex; gap: var(--space-xs);">
        <button class="btn btn-primary btn-sm" id="btnTestServer" style="padding: 4px 12px; font-size: var(--font-size-xs);">
          Probar conexión
        </button>
      </div>
    </div>
    
    <input type="file" id="fileInputVisionServer" accept=".py" style="display: none;">
  </div>
  
  <!-- Card de Region de Interés (ROI) -->
  <div class="card" style="margin-top: var(--space-sm);">
    <h2 style="font-size: var(--font-size-md); margin-bottom: var(--space-xs); font-weight: 600; color: var(--text-primary);">
      Region de Interés
    </h2>
    
    
    <!-- Controles ROI en grid 4 columnas compacto -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-xs) var(--space-sm);">
      <div style="display: flex; flex-direction: column; gap: 2px;">
        <label for="inputOffsetX" style="font-size: var(--font-size-xs); color: var(--text-primary); font-weight: 500;">
          Offset X (mm)
        </label>
        <input type="number" id="inputOffsetX" step="0.1" min="0" max="100" value="0.0" 
               style="padding: 4px 6px; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: var(--font-size-xs);">
      </div>
      
      <div style="display: flex; flex-direction: column; gap: 2px;">
        <label for="inputOffsetY" style="font-size: var(--font-size-xs); color: var(--text-primary); font-weight: 500;">
          Offset Y (mm)
        </label>
        <input type="number" id="inputOffsetY" step="0.1" min="0" max="100" value="0.0" 
               style="padding: 4px 6px; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: var(--font-size-xs);">
      </div>
      
      <div style="display: flex; flex-direction: column; gap: 2px;">
        <label for="inputZoomX" style="font-size: var(--font-size-xs); color: var(--text-primary); font-weight: 500;">
          Zoom X (%)
        </label>
        <input type="number" id="inputZoomX" step="1" min="10" max="500" value="150" 
               style="padding: 4px 6px; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: var(--font-size-xs);">
      </div>
      
      <div style="display: flex; flex-direction: column; gap: 2px;">
        <label for="inputZoomY" style="font-size: var(--font-size-xs); color: var(--text-primary); font-weight: 500;">
          Zoom Y (%)
        </label>
        <input type="number" id="inputZoomY" step="1" min="10" max="500" value="150" 
               style="padding: 4px 6px; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: var(--font-size-xs);">
      </div>
      
    </div>
  </div>
  
  <!-- Card de Resolución de Análisis -->
  <div class="card" style="margin-top: var(--space-sm);">
    <h2 style="font-size: var(--font-size-md); margin-bottom: var(--space-xs); font-weight: 600; color: var(--text-primary);">
      Resolución de Análisis
    </h2>
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-xs) var(--space-sm);">
      <div style="display: flex; flex-direction: column; gap: 2px;">
        <label for="resolutionAruco" style="font-size: var(--font-size-xs); color: var(--text-primary); font-weight: 500;">
          ArUco (%)
        </label>
        <input type="number" id="resolutionAruco" name="resolution_scale_aruco" min="10" max="100" step="5" value="100"
               style="padding: 4px 6px; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: var(--font-size-xs);">
      </div>
      <div style="display: flex; flex-direction: column; gap: 2px;">
        <label for="resolutionYolo" style="font-size: var(--font-size-xs); color: var(--text-primary); font-weight: 500;">
          YOLO (%)
        </label>
        <input type="number" id="resolutionYolo" name="resolution_scale_yolo" min="10" max="100" step="5" value="100"
               style="padding: 4px 6px; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: var(--font-size-xs);">
      </div>
      <div style="display: flex; flex-direction: column; gap: 2px;">
        <label for="resolutionOpencv" style="font-size: var(--font-size-xs); color: var(--text-primary); font-weight: 500;">
          OpenCV (%)
        </label>
        <input type="number" id="resolutionOpencv" name="resolution_scale_opencv" min="10" max="100" step="5" value="100"
               style="padding: 4px 6px; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: var(--font-size-xs);">
      </div>
    </div>
  </div>

  <!-- Card de Visualización -->
  <div class="card" style="margin-top: var(--space-lg);">
    <h2 style="font-size: var(--font-size-lg); margin-bottom: var(--space-sm); font-weight: 600; color: var(--text-primary);">
      Visualización
    </h2>
    
          <!-- Lista compacta en 2 columnas -->
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-sm) var(--space-lg);">
            
            <!-- Ejes ArUco Base -->
            <div style="display: flex; align-items: center; gap: var(--space-sm);">
              <div style="width: 20px; height: 20px; background: linear-gradient(135deg, #00d4ff, #0099cc); border-radius: 50%; box-shadow: 0 2px 4px rgba(0,212,255,0.3); border: 2px solid rgba(255,255,255,0.8);"></div>
              <input type="checkbox" id="chkShowArucoBase" style="width: 16px; height: 16px; cursor: pointer; accent-color: var(--brand-red);">
              <label for="chkShowArucoBase" style="font-size: var(--font-size-sm); color: var(--text-primary); cursor: pointer; user-select: none;">
                Ejes ArUco Base
              </label>
            </div>
            
            <!-- Ejes ArUco Tool -->
            <div style="display: flex; align-items: center; gap: var(--space-sm);">
              <div style="width: 20px; height: 20px; background: linear-gradient(135deg, #ff4444, #cc0000); border-radius: 50%; box-shadow: 0 2px 4px rgba(255,68,68,0.3); border: 2px solid rgba(255,255,255,0.8);"></div>
              <input type="checkbox" id="chkShowArucoTool" style="width: 16px; height: 16px; cursor: pointer; accent-color: var(--brand-red);">
              <label for="chkShowArucoTool" style="font-size: var(--font-size-sm); color: var(--text-primary); cursor: pointer; user-select: none;">
                Ejes ArUco Tool
              </label>
            </div>
            
            <!-- Centro Troqueladora -->
            <div style="display: flex; align-items: center; gap: var(--space-sm);">
              <div style="width: 20px; height: 20px; background: linear-gradient(135deg, #ffdd00, #ffaa00); border-radius: 50%; box-shadow: 0 2px 4px rgba(255,221,0,0.3); border: 2px solid rgba(255,255,255,0.8);"></div>
              <input type="checkbox" id="chkShowCentroTroquel" style="width: 16px; height: 16px; cursor: pointer; accent-color: var(--brand-red);">
              <label for="chkShowCentroTroquel" style="font-size: var(--font-size-sm); color: var(--text-primary); cursor: pointer; user-select: none;">
                Centro Troqueladora
              </label>
            </div>
            
            <!-- Cuadro ROI -->
            <div style="display: flex; align-items: center; gap: var(--space-sm);">
              <div style="width: 20px; height: 20px; background: linear-gradient(135deg, #ff44ff, #cc00cc); border-radius: 50%; box-shadow: 0 2px 4px rgba(255,68,255,0.3); border: 2px solid rgba(255,255,255,0.8);"></div>
              <input type="checkbox" id="chkShowROI" style="width: 16px; height: 16px; cursor: pointer; accent-color: var(--brand-red);">
              <label for="chkShowROI" style="font-size: var(--font-size-sm); color: var(--text-primary); cursor: pointer; user-select: none;">
                Cuadro ROI
              </label>
            </div>
            
            <!-- Boundingbox YOLO Junta -->
            <div style="display: flex; align-items: center; gap: var(--space-sm);">
              <div style="width: 20px; height: 20px; background: linear-gradient(135deg, #44ff44, #00cc00); border-radius: 50%; box-shadow: 0 2px 4px rgba(68,255,68,0.3); border: 2px solid rgba(255,255,255,0.8);"></div>
              <input type="checkbox" id="chkShowBboxJunta" style="width: 16px; height: 16px; cursor: pointer; accent-color: var(--brand-red);">
              <label for="chkShowBboxJunta" style="font-size: var(--font-size-sm); color: var(--text-primary); cursor: pointer; user-select: none;">
                Boundingbox YOLO Junta
              </label>
            </div>
            
            <!-- Boundingbox YOLO Holes -->
            <div style="display: flex; align-items: center; gap: var(--space-sm);">
              <div style="width: 20px; height: 20px; background: linear-gradient(135deg, #ff8844, #ff6600); border-radius: 50%; box-shadow: 0 2px 4px rgba(255,136,68,0.3); border: 2px solid rgba(255,255,255,0.8);"></div>
              <input type="checkbox" id="chkShowBboxHoles" style="width: 16px; height: 16px; cursor: pointer; accent-color: var(--brand-red);">
              <label for="chkShowBboxHoles" style="font-size: var(--font-size-sm); color: var(--text-primary); cursor: pointer; user-select: none;">
                Boundingbox YOLO Holes
              </label>
            </div>
            
            <!-- Elipses OpenCV -->
            <div style="display: flex; align-items: center; gap: var(--space-sm);">
              <div style="width: 20px; height: 20px; background: linear-gradient(135deg, #44ff88, #00cc44); border-radius: 50%; box-shadow: 0 2px 4px rgba(68,255,136,0.3); border: 2px solid rgba(255,255,255,0.8);"></div>
              <input type="checkbox" id="chkShowElipses" style="width: 16px; height: 16px; cursor: pointer; accent-color: var(--brand-red);">
              <label for="chkShowElipses" style="font-size: var(--font-size-sm); color: var(--text-primary); cursor: pointer; user-select: none;">
                Elipses OpenCV
              </label>
            </div>
            
            <!-- Segmento y Centro Junta -->
            <div style="display: flex; align-items: center; gap: var(--space-sm);">
              <div style="width: 20px; height: 20px; background: linear-gradient(135deg, #8844ff, #6600cc); border-radius: 50%; box-shadow: 0 2px 4px rgba(136,68,255,0.3); border: 2px solid rgba(255,255,255,0.8);"></div>
              <input type="checkbox" id="chkShowSegmentoJunta" style="width: 16px; height: 16px; cursor: pointer; accent-color: var(--brand-red);">
              <label for="chkShowSegmentoJunta" style="font-size: var(--font-size-sm); color: var(--text-primary); cursor: pointer; user-select: none;">
                Segmento y Centro Junta
              </label>
            </div>
            
          </div>
  </div>
  
  <!-- Card de Umbrales de Validación -->
  <div class="card" style="margin-top: var(--space-sm);">
    <h2 style="font-size: var(--font-size-md); margin-bottom: var(--space-xs); font-weight: 600; color: var(--text-primary);">
      Umbrales de Validación de Calidad
    </h2>
    
    <!-- Controles en grid 4 columnas compacto -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-xs) var(--space-sm);">
      <div style="display: flex; flex-direction: column; gap: 2px;">
        <label for="inputDistanciaTol" style="font-size: var(--font-size-xs); color: var(--text-primary); font-weight: 500;">
          Tolerancia Distancia (%)
        </label>
        <input type="number" id="inputDistanciaTol" min="90" max="100" step="0.1" value="98.0" 
               style="padding: 4px 6px; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: var(--font-size-xs);">
      </div>
      
      <div style="display: flex; flex-direction: column; gap: 2px;">
        <label for="inputCentrosMm" style="font-size: var(--font-size-xs); color: var(--text-primary); font-weight: 500;">
          Divergencia Centros (mm)
        </label>
        <input type="number" id="inputCentrosMm" min="0" max="10" step="0.1" value="3.0" 
               style="padding: 4px 6px; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: var(--font-size-xs);">
      </div>
      
      <div style="display: flex; flex-direction: column; gap: 2px;">
        <label for="inputColinealidadMm" style="font-size: var(--font-size-xs); color: var(--text-primary); font-weight: 500;">
          Desviación Linealidad (mm)
        </label>
        <input type="number" id="inputColinealidadMm" min="0" max="10" step="0.1" value="2.0" 
               style="padding: 4px 6px; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: var(--font-size-xs);">
      </div>
      
      <div style="display: flex; flex-direction: column; gap: 2px;">
        <label for="inputEspaciadoCV" style="font-size: var(--font-size-xs); color: var(--text-primary); font-weight: 500;">
          Espaciado Uniforme (CV máx)
        </label>
        <input type="number" id="inputEspaciadoCV" min="0" step="0.01" value="0.05" 
               style="padding: 4px 6px; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: var(--font-size-xs);">
      </div>
      
    </div>
  </div>
  
  
  <!-- Mensaje general (compartido por ambos cards) -->
  <div id="message" style="margin-top: var(--space-lg);"></div>

  <script>
    // Vision Server elements
    const visionServerIpInput = document.getElementById('visionServerIpInput');
    const visionServerPortInput = document.getElementById('visionServerPortInput');
    const visionServerStatus = document.getElementById('visionServerStatus');
    const btnTestServer = document.getElementById('btnTestServer');
    
    const btnSaveAll = document.getElementById('btnSaveAll');
    const messageDiv = document.getElementById('message');
    const inputDistanciaTol = document.getElementById('inputDistanciaTol');
    const inputCentrosMm = document.getElementById('inputCentrosMm');
    const inputColinealidadMm = document.getElementById('inputColinealidadMm');
    const inputEspaciadoCV = document.getElementById('inputEspaciadoCV');
    
    // Elementos de Resolución
    const resolutionAruco = document.getElementById('resolutionAruco');
    const resolutionYolo = document.getElementById('resolutionYolo');
    const resolutionOpencv = document.getElementById('resolutionOpencv');

    // Elementos de Configuración
    const chkUseBaseFrame = document.getElementById('chkUseBaseFrame');
    const chkUseToolFrame = document.getElementById('chkUseToolFrame');
    const chkUseROI = document.getElementById('chkUseROI');
    const chkUseBoundingBox = document.getElementById('chkUseBoundingBox');
    
    // Elementos ROI
    const inputOffsetX = document.getElementById('inputOffsetX');
    const inputOffsetY = document.getElementById('inputOffsetY');
    const inputZoomX = document.getElementById('inputZoomX');
    const inputZoomY = document.getElementById('inputZoomY');
    
    // Elementos de Visualización
    const chkShowArucoBase = document.getElementById('chkShowArucoBase');
    const chkShowArucoTool = document.getElementById('chkShowArucoTool');
    const chkShowCentroTroquel = document.getElementById('chkShowCentroTroquel');
    const chkShowROI = document.getElementById('chkShowROI');
    const chkShowBboxJunta = document.getElementById('chkShowBboxJunta');
    const chkShowBboxHoles = document.getElementById('chkShowBboxHoles');
    const chkShowElipses = document.getElementById('chkShowElipses');
    const chkShowSegmentoJunta = document.getElementById('chkShowSegmentoJunta');
    
    let currentVisionServerIp = '127.0.0.1';
    let currentVisionServerPort = 8000;
    let visionServerProcess = null;
    let visionServerCheckInterval = null;
    
    // ============================================================
    // FUNCIONES DE UI
    // ============================================================
    function showMessage(text, type = 'info') {
      messageDiv.textContent = text;
      messageDiv.style.padding = 'var(--space-sm) var(--space-md)';
      messageDiv.style.borderRadius = 'var(--radius-sm)';
      messageDiv.style.fontSize = 'var(--font-size-sm)';
      
      if (type === 'success') {
        messageDiv.style.background = 'rgba(40, 167, 69, 0.1)';
        messageDiv.style.color = '#28a745';
        messageDiv.style.border = '1px solid #28a745';
      } else if (type === 'error') {
        messageDiv.style.background = 'rgba(220, 53, 69, 0.1)';
        messageDiv.style.color = '#dc3545';
        messageDiv.style.border = '1px solid #dc3545';
      } else {
        messageDiv.style.background = 'rgba(23, 162, 184, 0.1)';
        messageDiv.style.color = '#17a2b8';
        messageDiv.style.border = '1px solid #17a2b8';
      }
    }
    
    function updateVisionServerStatus(status) {
      visionServerStatus.textContent = status === 'online' ? 'Online' : 'Offline';
      visionServerStatus.className = status === 'online' ? 'model-status status-loaded' : 'model-status status-not-loaded';
    }
    
    // Actualizar la IP cuando el usuario escriba en el input
    visionServerIpInput.addEventListener('input', (e) => {
      const ip = e.target.value.trim();
      currentVisionServerIp = ip || '127.0.0.1';
      console.log('[visionSystem] 📝 IP actualizada:', currentVisionServerIp);
    });
    
    // Actualizar el puerto cuando el usuario escriba en el input
    visionServerPortInput.addEventListener('input', (e) => {
      const port = parseInt(e.target.value);
      if (port && port >= 1000 && port <= 65535) {
        currentVisionServerPort = port;
        console.log('[visionSystem] 📝 Puerto actualizado:', currentVisionServerPort);
      }
    });
    
    // ============================================================
    // FUNCIONES DEL VISION SERVER
    // ============================================================
    async function checkVisionServerStatus() {
      try {
        const response = await fetch('/api/vision_icon_status');
        const data = await response.json();
        
        if (data.ok && data.status === 'success') {
          updateVisionServerStatus('online');
        } else {
          updateVisionServerStatus('offline');
        }
      } catch (e) {
        updateVisionServerStatus('offline');
      }
    }
    
    // No hay controles de inicio/detención/reinicio; sólo prueba de conexión
    
    // ============================================================
    // GUARDAR CONFIGURACIÓN COMPLETA
    // ============================================================
    async function saveAllConfig() {
      try {
        btnSaveAll.disabled = true;
        showMessage('Guardando toda la configuración...', 'info');
        
        console.log('[visionSystem] 🚀 Guardando TODA la configuración...');
        console.log('[visionSystem] 📊 Datos a guardar:', {
          // Configuración
          use_baseframe: chkUseBaseFrame.checked,
          use_toolframe: chkUseToolFrame.checked,
          use_roi: chkUseROI.checked,
          use_boundingbox: chkUseBoundingBox.checked,
          
          // Vision Server
          vision_server_ip: visionServerIpInput.value.trim() || '127.0.0.1',
          vision_server_port: parseInt(visionServerPortInput.value) || 8000,
          
          // Umbrales de validación
          umbral_distancia_tolerancia: parseFloat(inputDistanciaTol.value),
          umbral_centros_mm: parseFloat(inputCentrosMm.value),
          umbral_colinealidad_mm: parseFloat(inputColinealidadMm.value),
          umbral_espaciado_cv: parseFloat(inputEspaciadoCV.value),
          
          // Resolución
          resolution_scale_aruco: parseInt(resolutionAruco.value),
          resolution_scale_yolo: parseInt(resolutionYolo.value),
          resolution_scale_opencv: parseInt(resolutionOpencv.value),

          // Configuración ROI
          roi_offset_x_mm: parseFloat(inputOffsetX.value),
          roi_offset_y_mm: parseFloat(inputOffsetY.value),
          roi_zoom_x_percent: parseFloat(inputZoomX.value),
          roi_zoom_y_percent: parseFloat(inputZoomY.value),
          
          // Configuración de Visualización
          aruco_base_show: chkShowArucoBase.checked,
          aruco_tool_show: chkShowArucoTool.checked,
          centro_troquel_show: chkShowCentroTroquel.checked,
          roi_show: chkShowROI.checked,
          bbox_junta_show: chkShowBboxJunta.checked,
          bbox_holes_show: chkShowBboxHoles.checked,
          elipses_show: chkShowElipses.checked,
          segmento_junta_show: chkShowSegmentoJunta.checked
        });
        
        // Guardar configuración de modelos, visualización y umbrales
        const response1 = await Common.fetchWithTimeout('/api/vision/set_models', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            // Configuración general
            use_baseframe: chkUseBaseFrame.checked,
            use_toolframe: chkUseToolFrame.checked,
            use_roi: chkUseROI.checked,
            use_boundingbox: chkUseBoundingBox.checked,
            
            // Vision Server
            vision_server_ip: currentVisionServerIp,
            vision_server_port: currentVisionServerPort,
            
            // Umbrales de validación
            umbral_distancia_tolerancia: parseFloat(inputDistanciaTol.value),
            umbral_centros_mm: parseFloat(inputCentrosMm.value),
            umbral_colinealidad_mm: parseFloat(inputColinealidadMm.value),
            umbral_espaciado_cv: parseFloat(inputEspaciadoCV.value),
            
            // Resolución
            resolution_scale_aruco: parseInt(resolutionAruco.value),
            resolution_scale_yolo: parseInt(resolutionYolo.value),
            resolution_scale_opencv: parseInt(resolutionOpencv.value),

            // Configuración de Visualización
            aruco_base_show: chkShowArucoBase.checked,
            aruco_tool_show: chkShowArucoTool.checked,
            centro_troquel_show: chkShowCentroTroquel.checked,
            roi_show: chkShowROI.checked,
            bbox_junta_show: chkShowBboxJunta.checked,
            bbox_holes_show: chkShowBboxHoles.checked,
            elipses_show: chkShowElipses.checked,
            segmento_junta_show: chkShowSegmentoJunta.checked
          })
        });
        
        // Guardar configuración ROI
        const response2 = await Common.fetchWithTimeout('/api/vision/set_roi', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            roi_enabled: chkUseROI.checked,
            roi_offset_x_mm: parseFloat(inputOffsetX.value),
            roi_offset_y_mm: parseFloat(inputOffsetY.value),
            roi_zoom_x_percent: parseFloat(inputZoomX.value),
            roi_zoom_y_percent: parseFloat(inputZoomY.value)
          })
        });
        
        const data1 = await response1.json();
        const data2 = await response2.json();
        
        console.log('[visionSystem] 📥 Respuesta modelos:', data1);
        console.log('[visionSystem] 📥 Respuesta ROI:', data2);
        
        if (data1.ok && data2.ok) {
          showMessage('✓ Toda la configuración guardada correctamente', 'success');
          console.log('[visionSystem] ✅ Configuración completa guardada exitosamente');
          
          // Configurar ROI en el servidor de visión después de guardar
          try {
            const roiResponse = await fetch('/api/vision_server/configure_roi', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' }
            });
            
            const roiResult = await roiResponse.json();
            
            if (roiResult.ok) {
              console.log('[visionSystem] ✅ Configuración de ROI aplicada en servidor de visión');
            } else {
              console.warn('[visionSystem] ⚠️ Error configurando ROI en servidor de visión:', roiResult.mensaje);
            }
          } catch (e) {
            console.warn('[visionSystem] ⚠️ Error configurando ROI en servidor de visión:', e);
          }
        } else {
          const errors = [];
          if (!data1.ok) errors.push('Modelos/Umbrales: ' + (data1.error || 'Error'));
          if (!data2.ok) errors.push('ROI: ' + (data2.error || 'Error'));
          showMessage('Error guardando: ' + errors.join(', '), 'error');
          console.error('[visionSystem] ❌ Errores al guardar:', errors);
        }
        
      } catch (e) {
        console.error('[visionSystem] ❌ Error guardando:', e);
        showMessage('Error de conexión con el servidor', 'error');
      } finally {
        btnSaveAll.disabled = false;
      }
    }
    
    // ============================================================
    // CARGAR CONFIGURACIÓN COMPLETA
    // ============================================================
    async function loadConfig() {
      try {
        console.log('[visionSystem] 📥 Cargando TODA la configuración...');
        const response = await Common.fetchWithTimeout('/api/vision/config');
        const config = await response.json();
        
        console.log('[visionSystem] 📊 Configuración recibida:', config);
        
        if (config.vision) {
          // ============================================================
          // CARGAR CONFIGURACIÓN GENERAL
          // ============================================================
          chkUseBaseFrame.checked = config.vision.use_baseframe_guardado || false;
          chkUseToolFrame.checked = config.vision.use_toolframe_guardado || false;
          chkUseROI.checked = config.vision.use_roi || false;
          chkUseBoundingBox.checked = config.vision.use_boundingbox || false;
          
          console.log('[visionSystem] ✓ Configuración general cargada:', {
            use_baseframe: chkUseBaseFrame.checked,
            use_toolframe: chkUseToolFrame.checked,
            use_roi: chkUseROI.checked,
            use_boundingbox: chkUseBoundingBox.checked
          });
          
          // ============================================================
          // CARGAR VISION SERVER
          // ============================================================
          if (config.vision.vision_server_ip) {
            currentVisionServerIp = config.vision.vision_server_ip;
            visionServerIpInput.value = currentVisionServerIp;
            console.log('[visionSystem] ✓ IP del servidor cargada:', currentVisionServerIp);
          }
          if (config.vision.vision_server_port) {
            currentVisionServerPort = config.vision.vision_server_port;
            visionServerPortInput.value = currentVisionServerPort;
            console.log('[visionSystem] ✓ Puerto del servidor cargado:', currentVisionServerPort);
          }
          
          
          // ============================================================
          // CARGAR UMBRALES DE VALIDACIÓN
          // ============================================================
          inputDistanciaTol.value = config.vision.umbral_distancia_tolerancia || 98.0;
          inputCentrosMm.value = config.vision.umbral_centros_mm || 3.0;
          inputColinealidadMm.value = config.vision.umbral_colinealidad_mm || 2.0;
          inputEspaciadoCV.value = config.vision.umbral_espaciado_cv || 0.05;
          
          console.log('[visionSystem] ✓ Umbrales de validación cargados:', {
            distancia_tol: inputDistanciaTol.value,
            centros_mm: inputCentrosMm.value,
            colinealidad_mm: inputColinealidadMm.value,
            espaciado_cv: inputEspaciadoCV.value
          });
          
          // ============================================================
          // CARGAR RESOLUCIÓN
          // ============================================================
          resolutionAruco.value = config.vision.resolution_scale_aruco || 100;
          resolutionYolo.value = config.vision.resolution_scale_yolo || 100;
          resolutionOpencv.value = config.vision.resolution_scale_opencv || 100;

          console.log('[visionSystem] ✓ Resolución cargada:', {
            aruco: resolutionAruco.value,
            yolo: resolutionYolo.value,
            opencv: resolutionOpencv.value
          });

          // ============================================================
          // CARGAR CONFIGURACIÓN ROI
          // ============================================================
          inputOffsetX.value = config.vision.roi_offset_x_mm || 0.0;
          inputOffsetY.value = config.vision.roi_offset_y_mm || 0.0;
          inputZoomX.value = config.vision.roi_zoom_x_percent || 150;
          inputZoomY.value = config.vision.roi_zoom_y_percent || 150;
          
          console.log('[visionSystem] ✓ Configuración ROI cargada:', {
            offset_x: inputOffsetX.value,
            offset_y: inputOffsetY.value,
            zoom_x: inputZoomX.value,
            zoom_y: inputZoomY.value
          });
          
          // ============================================================
          // CARGAR CONFIGURACIÓN DE VISUALIZACIÓN
          // ============================================================
          // ArUco Base
          chkShowArucoBase.checked = config.vision.aruco_base_show || false;
          
          // ArUco Tool
          chkShowArucoTool.checked = config.vision.aruco_tool_show || false;
          
          // Centro Troqueladora
          chkShowCentroTroquel.checked = config.vision.centro_troquel_show || false;
          
          // ROI
          chkShowROI.checked = config.vision.roi_show || false;
          
          // Boundingbox Junta
          chkShowBboxJunta.checked = config.vision.bbox_junta_show || false;
          
          // Boundingbox Holes
          chkShowBboxHoles.checked = config.vision.bbox_holes_show || false;
          
          // Elipses
          chkShowElipses.checked = config.vision.elipses_show || false;
          
          // Segmento Junta
          chkShowSegmentoJunta.checked = config.vision.segmento_junta_show || false;
          
          console.log('[visionSystem] ✓ Configuración de visualización cargada:', {
            aruco_base: { show: chkShowArucoBase.checked },
            aruco_tool: { show: chkShowArucoTool.checked },
            centro_troquel: { show: chkShowCentroTroquel.checked },
            roi: { show: chkShowROI.checked },
            bbox_junta: { show: chkShowBboxJunta.checked },
            bbox_holes: { show: chkShowBboxHoles.checked },
            elipses: { show: chkShowElipses.checked },
            segmento_junta: { show: chkShowSegmentoJunta.checked }
          });
          
          console.log('[visionSystem] ✅ TODA la configuración cargada exitosamente');
        } else {
          console.log('[visionSystem] ⚠️ No hay configuración de visión disponible');
        }
        
      } catch (e) {
        console.error('[visionSystem] ❌ Error cargando configuración:', e);
        showMessage('Error cargando configuración', 'error');
      }
    }
    
    
    // ============================================================
    // EVENT LISTENERS
    // ============================================================
    btnSaveAll.addEventListener('click', saveAllConfig);
    btnTestServer.addEventListener('click', async () => {
      const result = await checkVisionServerStatus();
      if (result) {
        showMessage('Conexión exitosa con el servidor de visión', 'success');
      } else {
        showMessage('No se pudo conectar con el servidor de visión', 'error');
      }
    });
    
    // ============================================================
    // INICIALIZACIÓN
    // ============================================================
    (async function init() {
      await loadConfig();
    })();
  </script>
</body>
</html>
