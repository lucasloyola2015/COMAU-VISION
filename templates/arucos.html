<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configurar ArUcos</title>
  <link rel="stylesheet" href="/static/styles.css">
  <script src="/static/common.js"></script>
  <style>
    body {
      padding: 0;
      margin: 0;
      background: var(--bg-primary);
      height: 100vh;
      overflow: hidden;
    }
    
    .scroll-container {
      height: 100vh;
      overflow-y: auto;
      padding: 24px;
    }
    
    .form-group {
      margin-bottom: var(--space-lg);
    }
    
    .form-row {
      display: flex;
      align-items: center;
      gap: var(--space-md);
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      margin-top: var(--space-sm);
    }
    
    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: var(--brand-red);
    }
    
    .checkbox-label {
      font-size: var(--font-size-base);
      color: var(--text-primary);
      font-weight: 500;
      cursor: pointer;
      user-select: none;
    }
    
    /* Estilos consistentes para botones secundarios */
    .btn-secondary {
      padding: 12px 24px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-weight: 600;
      font-size: var(--font-size-base);
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-secondary:hover:not(:disabled) {
      background: var(--bg-primary);
      border-color: var(--accent-primary);
      transform: translateY(-1px);
    }
    
    .btn-secondary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-accent {
      padding: 12px 24px;
      background: var(--accent-primary);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-weight: 600;
      font-size: var(--font-size-base);
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-accent:hover:not(:disabled) {
      background: #1e88c7;
      transform: translateY(-1px);
    }
    
    .btn-accent:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="scroll-container">
    <h1 style="color: var(--text-primary); margin-bottom: var(--space-xl);">Configurar ArUcos</h1>
    
    <div class="card">
    <!-- Sección: Aruco_Tool -->
    <h2 style="font-size: var(--font-size-xl); margin-bottom: var(--space-xl); font-weight: 600; color: var(--text-primary);">
      Aruco_Tool (Herramienta)
    </h2>
    
    <div class="form-row" style="margin-bottom: var(--space-lg);">
      <div style="flex: 0 0 auto;">
        <label for="toolArucoCId">Aruco_Tool_ID</label>
        <input type="number" 
               id="toolArucoCId" 
               min="0" 
               max="1000" 
               value="0"
               style="width: 100px;">
      </div>
      
      <div style="flex: 0 0 auto;">
        <label for="toolArucoSize">Aruco_Tool_Tamaño (mm)</label>
        <div style="display: flex; align-items: center; gap: 8px;">
          <input type="number" 
                 id="toolArucoSize" 
                 min="1" 
                 max="500" 
                 step="0.1"
                 value="42.0"
                 style="width: 100px;">
          <div style="width: 16px; height: 16px; border-radius: 50%; background-color: #0066FF; flex-shrink: 0;" title="Tool"></div>
        </div>
      </div>
      
      <div style="flex: 0 0 auto; display: flex; align-items: center; gap: 8px;">
        <input type="checkbox" id="chkShowTool">
        <label for="chkShowTool" class="checkbox-label">Mostrar</label>
      </div>
    </div>
    
    <!-- Sección: Aruco_Frame -->
    <h2 style="font-size: var(--font-size-xl); margin-bottom: var(--space-xl); font-weight: 600; color: var(--text-primary);">
      Aruco_Frame (Troqueladora)
    </h2>
    
    <div class="form-row" style="margin-bottom: var(--space-lg);">
      <div style="flex: 0 0 auto;">
        <label for="frameArucoCId">Aruco_Frame_ID</label>
        <input type="number" 
               id="frameArucoCId" 
               min="0" 
               max="1000" 
               value="0"
               style="width: 100px;">
      </div>
      
      <div style="flex: 0 0 auto;">
        <label for="frameArucoSize">Aruco_Frame_Tamaño (mm)</label>
        <div style="display: flex; align-items: center; gap: 8px;">
          <input type="number" 
                 id="frameArucoSize" 
                 min="1" 
                 max="500" 
                 step="0.1"
                 value="42.0"
                 style="width: 100px;">
          <div style="width: 16px; height: 16px; border-radius: 50%; background-color: #FFD700; flex-shrink: 0;" title="Frame"></div>
        </div>
      </div>
      
      <div style="flex: 0 0 auto; display: flex; align-items: center; gap: 8px;">
        <input type="checkbox" id="chkShowFrame">
        <label for="chkShowFrame" class="checkbox-label">Mostrar</label>
      </div>
    </div>
    
    <!-- Checkboxes de configuración -->
    <div style="margin-bottom: var(--space-lg); padding-bottom: var(--space-lg); border-bottom: 1px solid var(--border-light);">
      <div class="checkbox-group" style="flex-direction: column; align-items: flex-start; gap: var(--space-md);">
        <div style="display: flex; align-items: center; gap: var(--space-sm);">
          <input type="checkbox" id="chkUseSaved">
          <label for="chkUseSaved" class="checkbox-label">Usar referencias guardadas (no detectar en tiempo real)</label>
        </div>
      </div>
    </div>
    
    <!-- Coordenadas del centro del troquel -->
    <h2 style="font-size: var(--font-size-xl); margin-bottom: var(--space-xl); font-weight: 600; color: var(--text-primary);">
      Coordenadas Centro Troquel
    </h2>
    
    <div class="form-row" style="margin-bottom: var(--space-lg);">
      <div style="flex: 0 0 auto;">
        <label for="centerX" style="font-size: var(--font-size-xs); color: var(--text-muted);">X (mm)</label>
        <input type="number" 
               id="centerX" 
               step="0.1"
               value="0"
               style="width: 120px;">
      </div>
      
      <div style="flex: 0 0 auto;">
        <label for="centerY" style="font-size: var(--font-size-xs); color: var(--text-muted);">Y (mm)</label>
        <input type="number" 
               id="centerY" 
               step="0.1"
               value="0"
               style="width: 120px;">
      </div>
      
      <div style="flex: 0 0 auto; display: flex; align-items: center; gap: 8px;">
        <div style="width: 16px; height: 16px; border-radius: 50%; background-color: #00FFFF; flex-shrink: 0;" title="Centro Troquel"></div>
      </div>
      
      <div style="flex: 0 0 auto; display: flex; align-items: center; gap: 8px;">
        <input type="checkbox" id="chkShowCenter">
        <label for="chkShowCenter" class="checkbox-label">Mostrar</label>
      </div>
    </div>
    
    <!-- Sección: Referencia Guardada -->
    <div style="margin-bottom: var(--space-lg); padding: var(--space-md); background: var(--bg-secondary); border-radius: var(--radius-md); border: 1px solid var(--border);">
      <h3 style="font-size: var(--font-size-md); margin-bottom: var(--space-md); font-weight: 600; color: var(--text-primary);">
        Referencia Guardada
      </h3>
      
      <div id="savedRefInfo" style="font-size: var(--font-size-sm); color: var(--text-secondary);">
        <div style="margin-bottom: 4px;">
          <strong style="color: var(--text-primary);">Calibración:</strong> <span id="savedPxPerMm">-</span> px/mm
        </div>
        <div style="margin-bottom: 4px;">
          <strong style="color: var(--text-primary);">Ángulo:</strong> <span id="savedAngle">-</span>°
        </div>
        <div style="font-size: var(--font-size-xs); color: var(--text-muted);">
          <strong>Capturada:</strong> <span id="savedTimestamp">-</span>
        </div>
      </div>
    </div>
    
    <!-- Botones finales -->
    <div style="display: flex; gap: var(--space-md); margin-bottom: var(--space-lg);">
      <button id="btnShow" class="btn btn-primary">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
          <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
          <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
        </svg>
        <span>Mostrar Overlay</span>
      </button>
      
      <button id="btnApply" class="btn btn-primary">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
          <path d="M13.485 1.929a.75.75 0 0 1 .086 1.057l-7.25 8a.75.75 0 0 1-1.094.03L2.43 8.28a.75.75 0 1 1 1.06-1.06l2.3 2.298 6.72-7.42a.75.75 0 0 1 .975-.168z"/>
        </svg>
        <span>Guardar</span>
      </button>
    </div>
    
    <div id="message" style="margin-bottom: var(--space-lg);"></div>
  </div>
  
  <div class="card" style="margin-top: var(--space-xl);">
    <p style="font-size: var(--font-size-sm); color: var(--text-secondary); margin: 0; line-height: 1.6;">
      <strong style="color: var(--text-primary);">Nota:</strong> Los ejes de referencia se visualizan en tiempo real en el Dashboard cuando se detecta el marcador ArUco con el ID especificado.
    </p>
  </div>

  <script>
    const frameArucoIdInput = document.getElementById('frameArucoCId');
    const frameArucoSizeInput = document.getElementById('frameArucoSize');
    const toolArucoIdInput = document.getElementById('toolArucoCId');
    const toolArucoSizeInput = document.getElementById('toolArucoSize');
    const centerXInput = document.getElementById('centerX');
    const centerYInput = document.getElementById('centerY');
    const chkShowFrame = document.getElementById('chkShowFrame');
    const chkShowTool = document.getElementById('chkShowTool');
    const chkShowCenter = document.getElementById('chkShowCenter');
    const chkUseSaved = document.getElementById('chkUseSaved');
    const btnApply = document.getElementById('btnApply');
    const btnShow = document.getElementById('btnShow');
    const messageDiv = document.getElementById('message');
    
    // ============================================================
    // FUNCIONES DE UI
    // ============================================================
    function showMessage(text, type = 'info') {
      messageDiv.textContent = text;
      messageDiv.style.padding = 'var(--space-sm) var(--space-md)';
      messageDiv.style.borderRadius = 'var(--radius-sm)';
      messageDiv.style.fontSize = 'var(--font-size-sm)';
      
      if (type === 'success') {
        messageDiv.style.background = 'rgba(40, 167, 69, 0.1)';
        messageDiv.style.color = '#28a745';
        messageDiv.style.border = '1px solid #28a745';
      } else if (type === 'error') {
        messageDiv.style.background = 'rgba(220, 53, 69, 0.1)';
        messageDiv.style.color = '#dc3545';
        messageDiv.style.border = '1px solid #dc3545';
      } else {
        messageDiv.style.background = 'rgba(23, 162, 184, 0.1)';
        messageDiv.style.color = '#17a2b8';
        messageDiv.style.border = '1px solid #17a2b8';
      }
    }
    
    // ============================================================
    // CARGAR CONFIGURACIÓN
    // ============================================================
    async function loadConfig() {
      try {
        const response = await Common.fetchWithTimeout('/api/aruco/config');
        const config = await response.json();
        
        if (config.aruco) {
          frameArucoIdInput.value = config.aruco.frame_aruco_id || 0;
          frameArucoSizeInput.value = config.aruco.frame_marker_size_mm || 42.0;
          toolArucoIdInput.value = config.aruco.tool_aruco_id || 0;
          toolArucoSizeInput.value = config.aruco.tool_marker_size_mm || 42.0;
          centerXInput.value = config.aruco.center_x_mm || 0;
          centerYInput.value = config.aruco.center_y_mm || 0;
          chkShowFrame.checked = config.aruco.show_frame || false;
          chkShowTool.checked = config.aruco.show_tool || false;
          chkShowCenter.checked = config.aruco.show_center || false;
          chkUseSaved.checked = config.aruco.use_saved_reference || false;
          
          // Mostrar datos de referencia guardada si existen
          if (config.aruco.saved_reference) {
            mostrarDatosGuardados(config.aruco.saved_reference);
          }
        }
        
        console.log('[arucos] Configuración cargada:', config);
      } catch (e) {
        console.error('[arucos] Error cargando config:', e);
      }
    }
    
    // ============================================================
    // MOSTRAR DATOS GUARDADOS
    // ============================================================
    function mostrarDatosGuardados(savedRef) {
      const infoDiv = document.getElementById('savedRefInfo');
      
      if (savedRef && savedRef.px_per_mm) {
        // Calcular ángulo en grados
        const angleDeg = savedRef.angle_rad ? (savedRef.angle_rad * 180 / Math.PI).toFixed(2) : '-';
        
        // Formatear timestamp
        let timestampText = '-';
        if (savedRef.timestamp) {
          try {
            const date = new Date(savedRef.timestamp);
            timestampText = date.toLocaleString('es-AR', { 
              year: 'numeric', 
              month: '2-digit', 
              day: '2-digit', 
              hour: '2-digit', 
              minute: '2-digit' 
            });
          } catch (e) {
            timestampText = savedRef.timestamp;
          }
        }
        
        // Actualizar UI
        document.getElementById('savedPxPerMm').textContent = savedRef.px_per_mm.toFixed(3);
        document.getElementById('savedAngle').textContent = angleDeg;
        document.getElementById('savedTimestamp').textContent = timestampText;
        
        infoDiv.style.display = 'block';
      } else {
        infoDiv.style.display = 'none';
      }
    }
    
    
    // ============================================================
    // GUARDAR CONFIGURACIÓN
    // ============================================================
    async function applyConfig() {
      const frameArucoId = parseInt(frameArucoIdInput.value);
      const frameMarkerSize = parseFloat(frameArucoSizeInput.value);
      const toolArucoId = parseInt(toolArucoIdInput.value);
      const toolMarkerSize = parseFloat(toolArucoSizeInput.value);
      const centerX = parseFloat(centerXInput.value);
      const centerY = parseFloat(centerYInput.value);
      const showFrame = chkShowFrame.checked;
      const showTool = chkShowTool.checked;
      const showCenter = chkShowCenter.checked;
      const useSavedReference = chkUseSaved.checked;
      
      try {
        btnApply.disabled = true;
        showMessage('Guardando configuración...', 'info');
        
        // Primero aplicar la configuración básica
        const setResponse = await Common.fetchWithTimeout('/api/aruco/set_reference', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            frame_aruco_id: frameArucoId,
            frame_marker_size_mm: frameMarkerSize,
            tool_aruco_id: toolArucoId,
            tool_marker_size_mm: toolMarkerSize,
            center_x_mm: centerX,
            center_y_mm: centerY,
            show_frame: showFrame,
            show_tool: showTool,
            show_center: showCenter,
            use_saved_reference: useSavedReference
          })
        });
        
        const setData = await setResponse.json();
        
        if (!setData.ok) {
          showMessage(setData.error || 'Error aplicando configuración', 'error');
          return;
        }
        
        // Luego guardar la configuración completa con objetos
        const saveResponse = await Common.fetchWithTimeout('/api/aruco/save_config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const saveData = await saveResponse.json();
        
        if (saveData.ok) {
          showMessage('✓ Configuración guardada correctamente', 'success');
          
          // Mostrar información adicional si está disponible
          if (saveData.data) {
            const { frame_detected, tool_detected, objects_saved } = saveData.data;
            let infoMessage = '';
            
            if (frame_detected) {
              infoMessage += 'Frame ArUco detectado y guardado. ';
            }
            if (tool_detected) {
              infoMessage += 'Tool ArUco detectado y guardado. ';
            }
            if (objects_saved && objects_saved.length > 0) {
              infoMessage += `${objects_saved.length} objetos de renderizado guardados.`;
            }
            
            if (infoMessage) {
              setTimeout(() => {
                showMessage('ℹ️ ' + infoMessage, 'info');
              }, 1000);
            }
          }
        } else {
          showMessage(saveData.error || 'Error guardando configuración', 'error');
        }
        
      } catch (e) {
        console.error('[arucos] Error guardando config:', e);
        showMessage('Error de conexión con el servidor', 'error');
      } finally {
        btnApply.disabled = false;
      }
    }
    
    // ============================================================
    // MOSTRAR OVERLAY DE ARUCO EN DASHBOARD (3 segundos)
    // ============================================================
    async function showOverlay() {
      try {
        btnShow.disabled = true;
        showMessage('Mostrando overlay en dashboard...', 'info');
        
        const response = await Common.fetchWithTimeout('/api/overlay/render', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (result.ok) {
          showMessage('✓ Overlay mostrado en dashboard por 3 segundos', 'success');
          
          // Mostrar información de detección
          if (result.detection_info && result.detection_info.messages) {
            const messages = result.detection_info.messages;
            messages.forEach((msg, index) => {
              setTimeout(() => {
                showMessage('ℹ️ ' + msg, 'info');
              }, (index + 1) * 200);
            });
          }
        } else {
          showMessage('❌ ' + (result.error || 'Error mostrando overlay'), 'error');
        }
        
      } catch (e) {
        console.error('[arucos] Error mostrando overlay:', e);
        showMessage('Error de conexión con el servidor', 'error');
      } finally {
        btnShow.disabled = false;
      }
    }
    
    function cleanupOnExit() {
      console.log('[arucos] Limpiando recursos al salir de la página');
    }
    
    // ============================================================
    // EVENT LISTENERS
    // ============================================================
    btnApply.addEventListener('click', applyConfig);
    btnShow.addEventListener('click', showOverlay);
    
    // Limpiar overlay al salir de la página
    window.addEventListener('beforeunload', cleanupOnExit);
    window.addEventListener('pagehide', cleanupOnExit);
    
    // ============================================================
    // INICIALIZACIÓN
    // ============================================================
    (async function init() {
      await loadConfig();
    })();
  </script>
</body>
</html>


