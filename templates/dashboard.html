<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <link rel="stylesheet" href="/static/styles.css">
  <script src="/static/common.js"></script>
  <style>
    body {
      margin: 0;
      padding: 24px;
      background: var(--bg-primary);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .video-container {
      flex: 1;
      background: #0b0b0c;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 0;
    }
    
    .video-placeholder {
      color: var(--text-muted);
      font-size: var(--font-size-lg);
    }
  </style>
</head>
<body>
  <h1>Dashboard en Vivo</h1>
  
  <div class="video-container" style="position: relative;">
    <img id="camStream" 
         alt="Stream de c√°mara" 
         src="/video_feed" 
         style="width: 100%; height: 100%; object-fit: contain; position: absolute; top: 0; left: 0;"
         onerror="this.style.display='none'; document.getElementById('camError').style.display='flex'">
    <img id="analyzedImage" 
         alt="Imagen analizada" 
         style="width: 100%; height: 100%; object-fit: contain; position: absolute; top: 0; left: 0; display: none;">
    <div id="camError" class="video-placeholder" style="display: none;">
      üìπ No hay c√°mara conectada
    </div>
  </div>
  
  <!-- Card de An√°lisis -->
  <div class="card" style="flex-shrink: 0; margin-top: 24px;">
    <h2 style="font-size: var(--font-size-xl); margin-bottom: var(--space-xl); font-weight: 600; color: var(--text-primary);">
      An√°lisis de Junta
    </h2>
       
    <div style="display: flex; gap: var(--space-md); align-items: center;">
      <button id="btnAnalyzeNew" class="btn btn-primary">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
          <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
        </svg>
        Analizar
      </button>
      <div id="analysisTime" style="display: none; padding: var(--space-sm) var(--space-md); background: var(--bg-secondary); border-radius: var(--radius-sm); font-size: var(--font-size-sm); color: var(--text-secondary);">
        <span style="color: var(--text-primary); font-weight: 500;">Tiempo:</span> <span id="timeValue">--</span>ms
      </div>
    </div>
    
    <div id="message" style="margin-top: var(--space-lg);"></div>
    
    <div id="results" style="margin-top: var(--space-xl); display: none;">
      <h3 style="font-size: var(--font-size-lg); margin-bottom: var(--space-md); font-weight: 600; color: var(--text-primary);">
        Resultados
      </h3>
      
      <div style="display: grid; gap: var(--space-md);">
        <div style="display: flex; justify-content: space-between; padding: var(--space-sm); background: var(--bg-secondary); border-radius: var(--radius-sm);">
          <span style="color: var(--text-secondary);">Relaci√≥n px/mm:</span>
          <span id="pxPerMm" style="color: var(--text-primary); font-weight: 500;">--</span>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Elementos del DOM
    const camStream = document.getElementById('camStream');
    const analyzedImage = document.getElementById('analyzedImage');
    const camError = document.getElementById('camError');
    const btnAnalyzeNew = document.getElementById('btnAnalyzeNew');
    const messageDiv = document.getElementById('message');
    const resultsDiv = document.getElementById('results');
    const pxPerMmSpan = document.getElementById('pxPerMm');
    const analysisTimeDiv = document.getElementById('analysisTime');
    const timeValueSpan = document.getElementById('timeValue');
    
    // Variable para controlar si hay junta seleccionada
    let juntaSeleccionada = false;
    
    // Verificar junta seleccionada al cargar
    async function verificarJuntaSeleccionada() {
      try {
        const response = await fetch('/api/juntas/selected');
        const result = await response.json();
        
        juntaSeleccionada = result.ok && result.junta;
        
        if (!juntaSeleccionada) {
          btnAnalyzeNew.disabled = true;
          showMessage('‚ö†Ô∏è Selecciona una junta en el Panel de Control para poder analizar', 'error');
          console.log('[dashboard] No hay junta seleccionada - solo an√°lisis nuevo habilitado');
        } else {
          btnAnalyzeNew.disabled = false;
          console.log('[dashboard] Junta seleccionada:', result.junta.nombre);
        }
      } catch (e) {
        console.error('[dashboard] Error verificando junta:', e);
        btnAnalyze.disabled = true;
        btnAnalyzeNew.disabled = false; // Mantener an√°lisis nuevo habilitado
      } finally { messageDiv.textContent = ''; }
    }
    
    // Escuchar mensajes del control cuando cambia la junta
    window.addEventListener('message', (event) => {
      if (event.data.type === 'JUNTA_CHANGED') {
        console.log('[dashboard] Junta cambi√≥, reverificando...');
        verificarJuntaSeleccionada();
      }
    });
    
    // Funci√≥n para mostrar mensajes
    function showMessage(text, type = 'info') {
      messageDiv.textContent = text;
      messageDiv.style.padding = 'var(--space-md)';
      messageDiv.style.borderRadius = 'var(--radius-md)';
      messageDiv.style.fontSize = 'var(--font-size-sm)';
      
      if (type === 'success') {
        messageDiv.style.background = 'rgba(34, 197, 94, 0.1)';
        messageDiv.style.color = '#22c55e';
        messageDiv.style.border = '1px solid #22c55e';
      } else if (type === 'error') {
        messageDiv.style.background = 'rgba(239, 68, 68, 0.1)';
        messageDiv.style.color = '#ef4444';
        messageDiv.style.border = '1px solid #ef4444';
      } else {
        messageDiv.style.background = 'rgba(23, 162, 184, 0.1)';
        messageDiv.style.color = '#17a2b8';
        messageDiv.style.border = '1px solid #17a2b8';
      }
    }
    
    // Funci√≥n para ejecutar an√°lisis nuevo (con OverlayManager)
    async function ejecutarAnalisisNuevo() {
      console.log('[dashboard] üîÑ ejecutarAnalisisNuevo() iniciado');
      showMessage('Analizando con nuevo sistema...', 'info');
      
      // Ocultar tiempo anterior
      analysisTimeDiv.style.display = 'none';
      
      try {
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Llamar al nuevo endpoint
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        console.log('[dashboard] üì§ Enviando petici√≥n a /api/analyze_new...');
        const response = await fetch('/api/analyze_new', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        console.log('[dashboard] üì• Respuesta recibida:', response.status, response.statusText);
        
        const result = await response.json();
        
        if (!result.ok) {
          // Error t√©cnico (c√°mara no conectada, etc.)
          showMessage('‚ùå Error t√©cnico: ' + (result.error || 'Desconocido'), 'error');
          return;
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Enviar datos al control para actualizar tabla
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        console.log('[dashboard] üì§ Enviando datos al panel de control...');
        console.log('[dashboard] üìä Datos a enviar:', result.data);
        
        window.parent.postMessage({ 
          type: 'ANALYSIS_READY',
          data: result.data || {}
        }, '*');
        
        if (result.analisis_exitoso) {
          // ‚úÖ An√°lisis exitoso - mostrar imagen y datos
          showMessage('‚úÖ An√°lisis completado exitosamente', 'success');
          
          // Mostrar tiempo de an√°lisis del servidor
          if (result.tiempo_total) {
            timeValueSpan.textContent = Math.round(result.tiempo_total);
            analysisTimeDiv.style.display = 'block';
          }
          
          // Mostrar imagen si est√° disponible
          if (result.imagen_base64) {
            analyzedImage.src = `data:image/jpeg;base64,${result.imagen_base64}`;
            analyzedImage.style.display = 'block';
            camStream.style.display = 'none';
          }
          
          // Enviar mensaje de √©xito al control panel
          window.parent.postMessage({ 
            type: 'ANALYSIS_SUCCESS'
          }, '*');
        } else {
          // ‚ö†Ô∏è An√°lisis fall√≥ - pero SIEMPRE enviar datos al control panel
          const errorMsg = result.error || 'Validaciones fallaron';
          
          // Mostrar tiempo de an√°lisis del servidor incluso si fall√≥
          if (result.tiempo_total) {
            timeValueSpan.textContent = Math.round(result.tiempo_total);
            analysisTimeDiv.style.display = 'block';
          }
          
          // Mensaje diferente seg√∫n si hay imagen o no
          if (result.data && (result.data.validaciones_geometricas || result.data.holes)) {
            // Hay datos parciales ‚Üí mostrar lo que se detect√≥
            const detalle = result.data.validacion_temprana 
              ? `Fall√≥ en validaci√≥n temprana: ${result.data.validacion_temprana}` 
              : 'Ver tabla de resultados';
            showMessage(`‚ö†Ô∏è ${errorMsg}. ${detalle}`, 'error');
          } else {
            showMessage(`‚ùå ${errorMsg}`, 'error');
          }
          
          // ‚ö†Ô∏è IMPORTANTE: Enviar ANALYSIS_READY con datos incluso si fall√≥
          // Esto permite que el control panel muestre los datos parciales
          window.parent.postMessage({ 
            type: 'ANALYSIS_READY',
            data: result.data || {}
          }, '*');
        }
        
      } catch (e) {
        console.error('[dashboard] Error en an√°lisis nuevo:', e);
        showMessage('‚ùå Error en an√°lisis: ' + e.message, 'error');
      }
    }
    
    // Bot√≥n de an√°lisis nuevo
    btnAnalyzeNew.addEventListener('click', async () => {
      // El an√°lisis nuevo no requiere junta seleccionada
      btnAnalyzeNew.disabled = true;
      
      try {
        await ejecutarAnalisisNuevo();
      } finally {
        setTimeout(() => { 
          btnAnalyzeNew.disabled = false; 
        }, 2500);
      }
    });
    
    // Verificar junta al cargar
    verificarJuntaSeleccionada();
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ESCUCHAR MENSAJES DEL PANEL DE CONTROL PARA AN√ÅLISIS AUTOM√ÅTICO
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    console.log('[dashboard] üîß Configurando listener de mensajes...');
    
    window.addEventListener('message', (event) => {
      console.log('[dashboard] üîî Mensaje recibido:', event.data.type, event.data);
      console.log('[dashboard] üîç Origen del mensaje:', event.origin);
      console.log('[dashboard] üîç Datos completos:', event.data);
      
      if (event.data.type === 'AUTO_ANALYZE') {
        console.log('[dashboard] ü§ñ An√°lisis autom√°tico solicitado por rutina de prueba');
        console.log('[dashboard] üîç juntaSeleccionada:', juntaSeleccionada);
        console.log('[dashboard] üîç btnAnalyze.disabled:', btnAnalyze.disabled);
        
        // Verificar que hay una junta seleccionada
        if (!juntaSeleccionada) {
          console.log('[dashboard] ‚ö†Ô∏è No hay junta seleccionada para an√°lisis autom√°tico');
          showMessage('‚ö†Ô∏è No hay junta seleccionada para el an√°lisis autom√°tico', 'error');
          return;
        }
        
        // Verificar que el bot√≥n no est√© deshabilitado
        if (btnAnalyzeNew.disabled) {
          console.log('[dashboard] ‚ö†Ô∏è Bot√≥n de an√°lisis ya est√° deshabilitado');
          return;
        }
        
        console.log('[dashboard] üéØ Ejecutando an√°lisis autom√°tico...');
        console.log('[dashboard] üîç Llamando directamente a ejecutarAnalisisConReintentos()...');
        showMessage('ü§ñ An√°lisis autom√°tico iniciado por rutina de prueba', 'info');
        
        // Llamar directamente a la funci√≥n de an√°lisis
        
        ejecutarAnalisisNuevo()
          .then(() => {
            console.log('[dashboard] ‚úÖ An√°lisis autom√°tico completado exitosamente');
          })
          .catch((error) => {
            console.log('[dashboard] ‚ùå Error en an√°lisis autom√°tico:', error);
            showMessage('‚ùå Error en an√°lisis autom√°tico: ' + error.message, 'error');
          });
      } else {
        console.log('[dashboard] üîç Mensaje no reconocido:', event.data.type);
      }
    });
  </script>
</body>
</html>
