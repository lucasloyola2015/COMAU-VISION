<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <link rel="stylesheet" href="/static/styles.css">
  <script src="/static/common.js"></script>
  <style>
    body {
      margin: 0;
      padding: 24px;
      background: var(--bg-primary);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .video-container {
      flex: 1;
      background: #0b0b0c;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 0;
    }
    
    .video-placeholder {
      color: var(--text-muted);
      font-size: var(--font-size-lg);
    }
  </style>
</head>
<body>
  <h1>Dashboard en Vivo</h1>
  
  <div class="video-container" style="position: relative;">
    <img id="camStream" 
         alt="Stream de cámara" 
         src="/video_feed" 
         style="width: 100%; height: 100%; object-fit: contain; position: absolute; top: 0; left: 0;"
         onerror="this.style.display='none'; document.getElementById('camError').style.display='flex'">
    <img id="analyzedImage" 
         alt="Imagen analizada" 
         style="width: 100%; height: 100%; object-fit: contain; position: absolute; top: 0; left: 0; display: none;">
    <div id="camError" class="video-placeholder" style="display: none;">
      📹 No hay cámara conectada
    </div>
  </div>
  
  <!-- Card de Análisis -->
  <div class="card" style="flex-shrink: 0; margin-top: 24px;">
    <h2 style="font-size: var(--font-size-xl); margin-bottom: var(--space-xl); font-weight: 600; color: var(--text-primary);">
      Análisis de Junta
    </h2>
       
    <div style="display: flex; gap: var(--space-md);">
      <button id="btnAnalyze" class="btn btn-primary">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
          <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
        </svg>
        Analizar Ahora
      </button>
      
      <button id="btnAnalyzeNew" class="btn btn-secondary">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
          <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
        </svg>
        Analizar
      </button>
    </div>
    
    <div id="message" style="margin-top: var(--space-lg);"></div>
    
    <div id="results" style="margin-top: var(--space-xl); display: none;">
      <h3 style="font-size: var(--font-size-lg); margin-bottom: var(--space-md); font-weight: 600; color: var(--text-primary);">
        Resultados
      </h3>
      
      <div style="display: grid; gap: var(--space-md);">
        <div style="display: flex; justify-content: space-between; padding: var(--space-sm); background: var(--bg-secondary); border-radius: var(--radius-sm);">
          <span style="color: var(--text-secondary);">Relación px/mm:</span>
          <span id="pxPerMm" style="color: var(--text-primary); font-weight: 500;">--</span>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Elementos del DOM
    const camStream = document.getElementById('camStream');
    const analyzedImage = document.getElementById('analyzedImage');
    const camError = document.getElementById('camError');
    const btnAnalyze = document.getElementById('btnAnalyze');
    const btnAnalyzeNew = document.getElementById('btnAnalyzeNew');
    const messageDiv = document.getElementById('message');
    const resultsDiv = document.getElementById('results');
    const pxPerMmSpan = document.getElementById('pxPerMm');
    
    // Variable para controlar si hay junta seleccionada
    let juntaSeleccionada = false;
    
    // Verificar junta seleccionada al cargar
    async function verificarJuntaSeleccionada() {
      try {
        const response = await fetch('/api/juntas/selected');
        const result = await response.json();
        
        juntaSeleccionada = result.ok && result.junta;
        
        if (!juntaSeleccionada) {
          btnAnalyze.disabled = true;
          btnAnalyzeNew.disabled = false; // Habilitar botón de análisis nuevo
          showMessage('⚠️ Selecciona una junta en el Panel de Control para análisis tradicional', 'error');
          console.log('[dashboard] No hay junta seleccionada - solo análisis nuevo habilitado');
        } else {
          btnAnalyze.disabled = false;
          btnAnalyzeNew.disabled = false;
          console.log('[dashboard] Junta seleccionada:', result.junta.nombre);
        }
      } catch (e) {
        console.error('[dashboard] Error verificando junta:', e);
        btnAnalyze.disabled = true;
        btnAnalyzeNew.disabled = false; // Mantener análisis nuevo habilitado
      }
    }
    
    // Escuchar mensajes del control cuando cambia la junta
    window.addEventListener('message', (event) => {
      if (event.data.type === 'JUNTA_CHANGED') {
        console.log('[dashboard] Junta cambió, reverificando...');
        verificarJuntaSeleccionada();
      }
    });
    
    // Función para mostrar mensajes
    function showMessage(text, type = 'info') {
      messageDiv.textContent = text;
      messageDiv.style.padding = 'var(--space-md)';
      messageDiv.style.borderRadius = 'var(--radius-md)';
      messageDiv.style.fontSize = 'var(--font-size-sm)';
      
      if (type === 'success') {
        messageDiv.style.background = 'rgba(34, 197, 94, 0.1)';
        messageDiv.style.color = '#22c55e';
        messageDiv.style.border = '1px solid #22c55e';
      } else if (type === 'error') {
        messageDiv.style.background = 'rgba(239, 68, 68, 0.1)';
        messageDiv.style.color = '#ef4444';
        messageDiv.style.border = '1px solid #ef4444';
      } else {
        messageDiv.style.background = 'rgba(23, 162, 184, 0.1)';
        messageDiv.style.color = '#17a2b8';
        messageDiv.style.border = '1px solid #17a2b8';
      }
    }
    
    // Función para ejecutar análisis (backend ya hace los reintentos)
    async function ejecutarAnalisisConReintentos() {
      console.log('[dashboard] 🔄 ejecutarAnalisisConReintentos() iniciado');
      showMessage('Analizando...', 'info');
      
      try {
        // ═══════════════════════════════════════════════════════════════
        // Llamar al backend (que internamente reintenta hasta 3 veces)
        // ═══════════════════════════════════════════════════════════════
        console.log('[dashboard] 📤 Enviando petición a /api/analyze...');
        const response = await fetch('/api/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        console.log('[dashboard] 📥 Respuesta recibida:', response.status, response.statusText);
        
        const result = await response.json();
        
        if (!result.ok) {
          // Error técnico (cámara no conectada, etc.)
          showMessage('❌ Error técnico: ' + (result.error || 'Desconocido'), 'error');
          return;
        }
        
        // ═══════════════════════════════════════════════════════════════
        // Enviar datos al control para actualizar tabla
        // ═══════════════════════════════════════════════════════════════
        console.log('[dashboard] 📤 Enviando datos al panel de control...');
        console.log('[dashboard] 📊 Datos a enviar:', result.data);
        
        window.parent.postMessage({ 
          type: 'ANALYSIS_READY', 
          data: result.data
        }, '*');
        
        console.log('[dashboard] ✅ Mensaje enviado al panel de control');
        
        // ═══════════════════════════════════════════════════════════════
        // Actualizar resultados en el dashboard
        // ═══════════════════════════════════════════════════════════════
        if (result.data.aruco && result.data.aruco.detected) {
          pxPerMmSpan.textContent = result.data.aruco.px_per_mm.toFixed(3) + ' px/mm';
          resultsDiv.style.display = 'block';
        }
        
        // ═══════════════════════════════════════════════════════════════
        // Mostrar imagen analizada (con o sin muescas según resultado)
        // ═══════════════════════════════════════════════════════════════
        try {
          const imgResponse = await fetch('/api/analyze_result');
          const imgData = await imgResponse.json();
          
          if (imgData.ok && imgData.image) {
            analyzedImage.src = imgData.image;
            camStream.style.display = 'none';
            analyzedImage.style.display = 'block';
            
            console.log('[dashboard] ✓ Mostrando imagen analizada');
            
            // Volver al video después de 5 segundos
            setTimeout(() => {
              analyzedImage.style.display = 'none';
              camStream.style.display = 'block';
              console.log('[dashboard] ✓ Volviendo a video en vivo');
            }, 5000);
          }
        } catch (e) {
          console.error('[dashboard] Error mostrando imagen:', e);
        }
        
        // ═══════════════════════════════════════════════════════════════
        // Mostrar mensaje según resultado
        // ═══════════════════════════════════════════════════════════════
        if (result.analisis_exitoso) {
          // ✅ Análisis exitoso (pasó todas las validaciones)
          showMessage('✅ Análisis completado exitosamente', 'success');
          
          window.parent.postMessage({ 
            type: 'ANALYSIS_SUCCESS'
          }, '*');
        } else {
          // ⚠️ Análisis falló - pero SIEMPRE enviar datos al control panel
          const errorMsg = result.error || 'Validaciones fallaron';
          
          // Mensaje diferente según si hay imagen o no
          if (result.data && (result.data.validaciones_geometricas || result.data.holes)) {
            // Hay datos parciales → mostrar lo que se detectó
            const detalle = result.data.validacion_temprana 
              ? `Falló en validación temprana: ${result.data.validacion_temprana}` 
              : 'Ver tabla de resultados';
            showMessage(`⚠️ ${errorMsg}. ${detalle}`, 'error');
          } else {
            showMessage(`❌ ${errorMsg}`, 'error');
          }
          
        // ⚠️ IMPORTANTE: Enviar ANALYSIS_READY con datos incluso si falló
        // Esto permite que el control panel muestre los datos parciales
        window.parent.postMessage({ 
          type: 'ANALYSIS_READY',
          data: result.data || {}
        }, '*');
        }
        
      } catch (e) {
        console.error('[dashboard] Error en análisis:', e);
        showMessage('❌ Error en análisis: ' + e.message, 'error');
      }
    }
    
    // Función para ejecutar análisis nuevo (con OverlayManager)
    async function ejecutarAnalisisNuevo() {
      console.log('[dashboard] 🔄 ejecutarAnalisisNuevo() iniciado');
      showMessage('Analizando con nuevo sistema...', 'info');
      
      try {
        // ═══════════════════════════════════════════════════════════════
        // Llamar al nuevo endpoint
        // ═══════════════════════════════════════════════════════════════
        console.log('[dashboard] 📤 Enviando petición a /api/analyze_new...');
        const response = await fetch('/api/analyze_new', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        console.log('[dashboard] 📥 Respuesta recibida:', response.status, response.statusText);
        
        const result = await response.json();
        
        if (!result.ok) {
          // Error técnico (cámara no conectada, etc.)
          showMessage('❌ Error técnico: ' + (result.error || 'Desconocido'), 'error');
          return;
        }
        
        // ═══════════════════════════════════════════════════════════════
        // Enviar datos al control para actualizar tabla
        // ═══════════════════════════════════════════════════════════════
        console.log('[dashboard] 📤 Enviando datos al panel de control...');
        console.log('[dashboard] 📊 Datos a enviar:', result.data);
        
        window.parent.postMessage({ 
          type: 'ANALYSIS_READY',
          data: result.data || {}
        }, '*');
        
        if (result.analisis_exitoso) {
          // ✅ Análisis exitoso - mostrar imagen y datos
          showMessage('✅ Análisis completado exitosamente', 'success');
          
          // Mostrar imagen si está disponible
          if (result.imagen_base64) {
            analyzedImage.src = `data:image/jpeg;base64,${result.imagen_base64}`;
            analyzedImage.style.display = 'block';
            camStream.style.display = 'none';
          }
          
          // Enviar mensaje de éxito al control panel
          window.parent.postMessage({ 
            type: 'ANALYSIS_SUCCESS'
          }, '*');
        } else {
          // ⚠️ Análisis falló - pero SIEMPRE enviar datos al control panel
          const errorMsg = result.error || 'Validaciones fallaron';
          
          // Mensaje diferente según si hay imagen o no
          if (result.data && (result.data.validaciones_geometricas || result.data.holes)) {
            // Hay datos parciales → mostrar lo que se detectó
            const detalle = result.data.validacion_temprana 
              ? `Falló en validación temprana: ${result.data.validacion_temprana}` 
              : 'Ver tabla de resultados';
            showMessage(`⚠️ ${errorMsg}. ${detalle}`, 'error');
          } else {
            showMessage(`❌ ${errorMsg}`, 'error');
          }
          
          // ⚠️ IMPORTANTE: Enviar ANALYSIS_READY con datos incluso si falló
          // Esto permite que el control panel muestre los datos parciales
          window.parent.postMessage({ 
            type: 'ANALYSIS_READY',
            data: result.data || {}
          }, '*');
        }
        
      } catch (e) {
        console.error('[dashboard] Error en análisis nuevo:', e);
        showMessage('❌ Error en análisis: ' + e.message, 'error');
      }
    }
    
    // Botón de análisis (original)
    btnAnalyze.addEventListener('click', async () => {
      // Verificar nuevamente antes de analizar
      if (!juntaSeleccionada) {
        showMessage('⚠️ Selecciona una junta en el Panel de Control primero', 'error');
        return;
      }
      
      btnAnalyze.disabled = true;
      
      try {
        await ejecutarAnalisisConReintentos();
      } finally {
        setTimeout(() => { 
          if (juntaSeleccionada) {
            btnAnalyze.disabled = false; 
          }
        }, 2500);
      }
    });
    
    // Botón de análisis nuevo
    btnAnalyzeNew.addEventListener('click', async () => {
      // El análisis nuevo no requiere junta seleccionada
      btnAnalyzeNew.disabled = true;
      
      try {
        await ejecutarAnalisisNuevo();
      } finally {
        setTimeout(() => { 
          btnAnalyzeNew.disabled = false; 
        }, 2500);
      }
    });
    
    // Verificar junta al cargar
    verificarJuntaSeleccionada();
    
    // ═══════════════════════════════════════════════════════════════
    // ESCUCHAR MENSAJES DEL PANEL DE CONTROL PARA ANÁLISIS AUTOMÁTICO
    // ═══════════════════════════════════════════════════════════════
    console.log('[dashboard] 🔧 Configurando listener de mensajes...');
    
    window.addEventListener('message', (event) => {
      console.log('[dashboard] 🔔 Mensaje recibido:', event.data.type, event.data);
      console.log('[dashboard] 🔍 Origen del mensaje:', event.origin);
      console.log('[dashboard] 🔍 Datos completos:', event.data);
      
      if (event.data.type === 'AUTO_ANALYZE') {
        console.log('[dashboard] 🤖 Análisis automático solicitado por rutina de prueba');
        console.log('[dashboard] 🔍 juntaSeleccionada:', juntaSeleccionada);
        console.log('[dashboard] 🔍 btnAnalyze.disabled:', btnAnalyze.disabled);
        
        // Verificar que hay una junta seleccionada
        if (!juntaSeleccionada) {
          console.log('[dashboard] ⚠️ No hay junta seleccionada para análisis automático');
          showMessage('⚠️ No hay junta seleccionada para análisis automático', 'error');
          return;
        }
        
        // Verificar que el botón no esté deshabilitado
        if (btnAnalyze.disabled) {
          console.log('[dashboard] ⚠️ Botón analizar ya está deshabilitado');
          return;
        }
        
        console.log('[dashboard] 🎯 Ejecutando análisis automático...');
        console.log('[dashboard] 🔍 Llamando directamente a ejecutarAnalisisConReintentos()...');
        showMessage('🤖 Análisis automático iniciado por rutina de prueba', 'info');
        
        // Llamar directamente a la función de análisis (solución elegante)
        console.log('[dashboard] 🎯 Llamando directamente a ejecutarAnalisisConReintentos()...');
        
        ejecutarAnalisisConReintentos()
          .then(() => {
            console.log('[dashboard] ✅ Análisis automático completado exitosamente');
          })
          .catch((error) => {
            console.log('[dashboard] ❌ Error en análisis automático:', error);
            showMessage('❌ Error en análisis automático: ' + error.message, 'error');
          });
      } else {
        console.log('[dashboard] 🔍 Mensaje no reconocido:', event.data.type);
      }
    });
  </script>
</body>
</html>

