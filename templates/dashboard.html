<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <link rel="stylesheet" href="/static/styles.css">
  <script src="/static/common.js"></script>
  <style>
    body {
      margin: 0;
      padding: 24px;
      background: var(--bg-primary);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .video-container {
      flex: 1;
      background: #0b0b0c;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 0;
    }
    
    .video-placeholder {
      color: var(--text-muted);
      font-size: var(--font-size-lg);
    }
  </style>
</head>
<body>
  <h1>Dashboard en Vivo</h1>
  
  <div class="video-container" style="position: relative;">
    <img id="camStream" 
         alt="Stream de c√°mara" 
         src="/video_feed" 
         style="width: 100%; height: 100%; object-fit: contain; position: absolute; top: 0; left: 0;"
         onerror="this.style.display='none'; document.getElementById('camError').style.display='flex'">
    <img id="analyzedImage" 
         alt="Imagen analizada" 
         style="width: 100%; height: 100%; object-fit: contain; position: absolute; top: 0; left: 0; display: none;">
    <div id="camError" class="video-placeholder" style="display: none;">
      üìπ No hay c√°mara conectada
    </div>
  </div>
  
  <!-- Indicadores de estado de detecci√≥n -->
  <div id="detectionIndicators" style="margin-top: var(--space-md); display: none; justify-content: space-between; align-items: center; width: 100%; max-width: 640px;">
    <div class="detection-indicator" id="juntaIndicator">
      <div class="indicator-circle"></div>
      <span class="indicator-text">Junta</span>
    </div>
    <div class="detection-indicator" id="arucoBaseIndicator">
      <div class="indicator-circle"></div>
      <span class="indicator-text">ArUco Base</span>
    </div>
    <div class="detection-indicator" id="arucoToolIndicator">
      <div class="indicator-circle"></div>
      <span class="indicator-text">ArUco Tool</span>
    </div>
  </div>
  
  <!-- Card de An√°lisis -->
  <div class="card" style="flex-shrink: 0; margin-top: 24px;">
    <h2 style="font-size: var(--font-size-xl); margin-bottom: var(--space-xl); font-weight: 600; color: var(--text-primary);">
      An√°lisis de Junta
    </h2>
       
    <div style="display: flex; gap: var(--space-md); align-items: center;">
      <button id="btnSeryerTest" class="btn btn-primary">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
          <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
        </svg>
        PROBAR
      </button>
    </div>
    
    <div id="message" style="margin-top: var(--space-lg);"></div>
    
    <!-- Contenedor de estado rojo/verde -->
    <div id="statusContainer" style="margin-top: var(--space-lg); padding: 12px; border-radius: var(--radius-sm); display: none; transition: all 0.3s ease; background-color: transparent;">
      <span id="statusText" style="font-weight: 500;">Procesando...</span>
    </div>
    
    <div id="results" style="margin-top: var(--space-xl); display: none;">
      <h3 style="font-size: var(--font-size-lg); margin-bottom: var(--space-md); font-weight: 600; color: var(--text-primary);">
        Resultados
      </h3>
      
      <div style="display: grid; gap: var(--space-md);">
        <div style="display: flex; justify-content: space-between; padding: var(--space-sm); background: var(--bg-secondary); border-radius: var(--radius-sm);">
          <span style="color: var(--text-secondary);">Relaci√≥n px/mm:</span>
          <span id="pxPerMm" style="color: var(--text-primary); font-weight: 500;">--</span>
        </div>
      </div>
    </div>
  </div>
  
  <style>
    /* Estilos para indicadores de detecci√≥n */
    .detection-indicator {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 6px;
    }
    
    .indicator-circle {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 1px solid #ffc107;
      background-color: #ffc107;
      transition: all 0.3s ease;
      flex-shrink: 0;
    }
    
    .indicator-text {
      font-size: 10px;
      font-weight: 500;
      color: var(--text-secondary);
      white-space: nowrap;
    }
    
    /* Estados de los indicadores */
    .indicator-circle.yellow {
      border-color: #ffc107;
      background-color: #ffc107;
    }
    
    .indicator-circle.green {
      border-color: #28a745;
      background-color: #28a745;
    }
    
    .indicator-circle.red {
      border-color: #dc3545;
      background-color: #dc3545;
    }
  </style>
  
  <script>
    // Elementos del DOM
    const camStream = document.getElementById('camStream');
    const analyzedImage = document.getElementById('analyzedImage');
    const camError = document.getElementById('camError');
    const btnSeryerTest = document.getElementById('btnSeryerTest');
    const messageDiv = document.getElementById('message');
    const resultsDiv = document.getElementById('results');
    const pxPerMmSpan = document.getElementById('pxPerMm');
    const statusContainer = document.getElementById('statusContainer');
    const statusText = document.getElementById('statusText');
    const detectionIndicators = document.getElementById('detectionIndicators');
    const juntaIndicator = document.getElementById('juntaIndicator');
    const arucoBaseIndicator = document.getElementById('arucoBaseIndicator');
    const arucoToolIndicator = document.getElementById('arucoToolIndicator');
    
    // Variable para controlar si hay junta seleccionada
    let juntaSeleccionada = false;
    
    // Variables para el cron√≥metro
    let timerStartTime = null;
    let timerInterval = null;
    
    // Verificar junta seleccionada al cargar
    async function verificarJuntaSeleccionada() {
      try {
        const response = await fetch('/api/juntas/selected');
        const result = await response.json();
        
        juntaSeleccionada = result.ok && result.junta;
        
        // Bot√≥n habilitado para server test
        btnSeryerTest.disabled = false;
        btnSeryerTest.textContent = 'PROBAR';
        btnSeryerTest.style.backgroundColor = '';
        btnSeryerTest.style.cursor = 'pointer';
        
        showMessage('‚úÖ Bot√≥n PROBAR habilitado', 'success');
        console.log('[dashboard] Bot√≥n PROBAR habilitado');
        
      } catch (e) {
        console.error('[dashboard] Error verificando junta:', e);
        btnSeryerTest.disabled = false;
        btnSeryerTest.textContent = 'PROBAR';
        btnSeryerTest.style.backgroundColor = '';
        btnSeryerTest.style.cursor = 'pointer';
        showMessage('‚úÖ Bot√≥n PROBAR habilitado', 'success');
      } finally { messageDiv.textContent = ''; }
    }
    
    // Escuchar mensajes del control cuando cambia la junta
    window.addEventListener('message', (event) => {
      if (event.data.type === 'JUNTA_CHANGED') {
        console.log('[dashboard] Junta cambi√≥, reverificando...');
        verificarJuntaSeleccionada();
      }
    });
    
    // Funci√≥n para mostrar mensajes
    function showMessage(text, type = 'info') {
      messageDiv.textContent = text;
      messageDiv.style.padding = 'var(--space-md)';
      messageDiv.style.borderRadius = 'var(--radius-md)';
      messageDiv.style.fontSize = 'var(--font-size-sm)';
      
      if (type === 'success') {
        messageDiv.style.background = 'rgba(34, 197, 94, 0.1)';
        messageDiv.style.color = '#22c55e';
        messageDiv.style.border = '1px solid #22c55e';
      } else if (type === 'error') {
        messageDiv.style.background = 'rgba(239, 68, 68, 0.1)';
        messageDiv.style.color = '#ef4444';
        messageDiv.style.border = '1px solid #ef4444';
      } else {
        messageDiv.style.background = 'rgba(23, 162, 184, 0.1)';
        messageDiv.style.color = '#17a2b8';
        messageDiv.style.border = '1px solid #17a2b8';
      }
    }
    
    // Funci√≥n para mostrar estado en el contenedor rojo/verde
    function showStatus(message, type = 'processing') {
      statusContainer.style.display = 'block';
      statusText.textContent = message;
      
      if (type === 'processing') {
        statusContainer.style.border = '2px solid #ffc107';
        statusContainer.style.color = '#856404';
      } else if (type === 'success') {
        statusContainer.style.border = '2px solid #28a745';
        statusContainer.style.color = '#155724';
      } else if (type === 'error') {
        statusContainer.style.border = '2px solid #dc3545';
        statusContainer.style.color = '#721c24';
      }
    }
    
    // Funci√≥n para ocultar el contenedor de estado
    function hideStatus() {
      statusContainer.style.display = 'none';
    }
    
    // Funci√≥n para iniciar el cron√≥metro
    function startTimer() {
      timerStartTime = Date.now();
      timerInterval = setInterval(() => {
        const elapsed = Date.now() - timerStartTime;
        const seconds = (elapsed / 1000).toFixed(1);
        showStatus(`Capturando frame y procesando... (${seconds}s)`, 'processing');
      }, 100);
    }
    
    // Funci√≥n para detener el cron√≥metro y mostrar tiempo final
    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      
      if (timerStartTime) {
        const elapsed = Date.now() - timerStartTime;
        const seconds = (elapsed / 1000).toFixed(1);
        return seconds;
      }
      return '0.0';
    }
    
    // Funci√≥n para mostrar indicadores de detecci√≥n
    function showDetectionIndicators() {
      detectionIndicators.style.display = 'flex';
    }
    
    // Funci√≥n para ocultar indicadores de detecci√≥n
    function hideDetectionIndicators() {
      detectionIndicators.style.display = 'none';
    }
    
    // Funci√≥n para establecer estado de un indicador
    function setIndicatorState(indicator, state) {
      const circle = indicator.querySelector('.indicator-circle');
      
      // Remover clases previas
      circle.classList.remove('yellow', 'green', 'red');
      
      if (state === 'yellow') {
        circle.classList.add('yellow');
      } else if (state === 'green') {
        circle.classList.add('green');
      } else if (state === 'red') {
        circle.classList.add('red');
      }
    }
    
    // Funci√≥n para actualizar indicadores con datos de respuesta
    function updateDetectionIndicators(data) {
      // Junta detectada
      setIndicatorState(juntaIndicator, data.junta_detectada ? 'green' : 'red');
      
      // ArUco Base
      setIndicatorState(arucoBaseIndicator, data.aruco_base_detectado ? 'green' : 'red');
      
      // ArUco Herramienta
      setIndicatorState(arucoToolIndicator, data.aruco_tool_detectado ? 'green' : 'red');
    }
    
    // Funci√≥n para establecer todos los indicadores en amarillo (consultando)
    function setIndicatorsConsulting() {
      setIndicatorState(juntaIndicator, 'yellow');
      setIndicatorState(arucoBaseIndicator, 'yellow');
      setIndicatorState(arucoToolIndicator, 'yellow');
    }
    
    
    
    // Funci√≥n para ejecutar server test
    async function ejecutarServerTest() {
      console.log('[dashboard] üß™ ejecutarServerTest() iniciado');
      
      // Iniciar cron√≥metro y mostrar estado de procesamiento
      startTimer();
      hideMessage();
      
      // Mostrar indicadores en estado de consulta (amarillo)
      showDetectionIndicators();
      setIndicatorsConsulting();
      
      try {
        console.log('[dashboard] üì§ Enviando petici√≥n a /api/server_test...');
        const response = await fetch('/api/server_test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        console.log('[dashboard] üì• Respuesta recibida:', response.status, response.statusText);
        
        const result = await response.json();
        
        if (result.ok) {
          const elapsedTime = stopTimer();
          showStatus(`${result.mensaje} (${elapsedTime}s)`, 'success');
          console.log('[dashboard] ‚úÖ Server test completado:', result.mensaje);
          
          // Actualizar indicadores de detecci√≥n con los datos recibidos
          if (result.data) {
            console.log('[dashboard] üîç Actualizando indicadores de detecci√≥n...');
            updateDetectionIndicators(result.data);
          }
          
          // Mostrar imagen de respuesta si est√° disponible
          if (result.overlay_image) {
            console.log('[dashboard] üñºÔ∏è Mostrando imagen de respuesta...');
            mostrarImagenRespuesta(result.overlay_image);
          }
          
          // Enviar datos de trayectoria al panel de control
          if (result.trajectory_vectors && result.trajectory_vectors.length > 0) {
            console.log('[dashboard] üìä Enviando datos de trayectoria al panel de control...');
            console.log('[dashboard] üìä trajectory_vectors recibidos:', result.trajectory_vectors);
            enviarDatosTrayectoria(result.trajectory_vectors, result.data);
        } else {
            console.log('[dashboard] ‚ö†Ô∏è No hay trajectory_vectors para enviar');
            console.log('[dashboard] üìä result completo:', result);
          }
          
          // Ocultar estado despu√©s de 3 segundos
          setTimeout(() => {
            hideStatus();
          }, 3000);
          
          } else {
          const elapsedTime = stopTimer();
          showStatus(`Error: ${result.error || 'Desconocido'} (${elapsedTime}s)`, 'error');
          console.log('[dashboard] ‚ùå Error en server test:', result.error);
          
          // Ocultar estado despu√©s de 5 segundos en caso de error
          setTimeout(() => {
            hideStatus();
          }, 5000);
        }
        
      } catch (e) {
        console.error('[dashboard] Error en server test:', e);
        const elapsedTime = stopTimer();
        showStatus(`Error: ${e.message} (${elapsedTime}s)`, 'error');
        
        // Ocultar estado despu√©s de 5 segundos en caso de error
        setTimeout(() => {
          hideStatus();
        }, 5000);
      }
    }
    
    // Funci√≥n para ocultar mensaje
    function hideMessage() {
      messageDiv.style.display = 'none';
    }
    
    // Funci√≥n para mostrar imagen de respuesta durante 3 segundos
    function mostrarImagenRespuesta(imageBase64) {
      // Ocultar streaming y mostrar imagen procesada
      camStream.style.display = 'none';
      analyzedImage.src = `data:image/png;base64,${imageBase64}`;
      analyzedImage.style.display = 'block';
      
      console.log('[dashboard] üñºÔ∏è Imagen mostrada, ocultando en 3 segundos...');
      
      // Restaurar streaming despu√©s de 3 segundos
      setTimeout(() => {
        analyzedImage.style.display = 'none';
        camStream.style.display = 'block';
        console.log('[dashboard] üîÑ Streaming restaurado');
      }, 3000);
    }
    
    // Funci√≥n para enviar datos de trayectoria al panel de control
    function enviarDatosTrayectoria(trajectoryVectors, detectionData = null) {
      console.log('[dashboard] üîÑ Procesando trajectory_vectors:', trajectoryVectors);
      console.log('[dashboard] üîÑ Datos de detecci√≥n:', detectionData);
      
      // Convertir trajectory_vectors a formato de muescas con offsets
      const centrosMuescas = trajectoryVectors.map((vector, index) => {
        console.log(`[dashboard] üîÑ Procesando vector ${index}:`, vector);
        
        // Verificar que el vector tenga la estructura esperada
        const vector_mm = vector.vector_mm || vector.centro_mm || [0, 0];
        const offset_x = vector_mm[0] || 0.0;
        const offset_y = vector_mm[1] || 0.0;
        
        return {
          id: index + 1,
          centro_mm: vector_mm,
          offset_x: offset_x,
          offset_y: offset_y
        };
      });
      
      console.log('[dashboard] üîÑ centrosMuescas procesados:', centrosMuescas);
      
      // Enviar datos al panel de control
      const messageData = {
        type: 'TRAJECTORY_DATA',
        data: {
          centros_muescas: centrosMuescas,
          trajectory_vectors: trajectoryVectors,
          // Agregar datos de detecci√≥n si est√°n disponibles
          ...(detectionData && {
            junta_segment_length_mm: detectionData.junta_segment_length_mm,
            holes_detectados: detectionData.holes_detectados
          })
        }
      };
      
      console.log('[dashboard] üì§ Enviando mensaje al panel de control:', messageData);
      window.parent.postMessage(messageData, '*');
      
      console.log('[dashboard] üì§ Datos de trayectoria enviados al panel de control');
    }
    
    // Event listener para el bot√≥n PROBAR
    btnSeryerTest.addEventListener('click', async () => {
      btnSeryerTest.disabled = true;
      
      try {
        await ejecutarServerTest();
      } finally {
        setTimeout(() => { 
          btnSeryerTest.disabled = false; 
        }, 1000);
      }
    });
    
    // Verificar junta al cargar
    verificarJuntaSeleccionada();
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ESCUCHAR MENSAJES DEL PANEL DE CONTROL PARA AN√ÅLISIS AUTOM√ÅTICO
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    console.log('[dashboard] üîß Configurando listener de mensajes...');
    
    window.addEventListener('message', (event) => {
      console.log('[dashboard] üîî Mensaje recibido:', event.data.type, event.data);
      console.log('[dashboard] üîç Origen del mensaje:', event.origin);
      console.log('[dashboard] üîç Datos completos:', event.data);
      
      if (event.data.type === 'AUTO_ANALYZE') {
        console.log('[dashboard] ü§ñ An√°lisis autom√°tico solicitado por rutina de prueba');
        console.log('[dashboard] üîç juntaSeleccionada:', juntaSeleccionada);
        console.log('[dashboard] üîç btnAnalyze.disabled:', btnAnalyze.disabled);
        
        // Verificar que hay una junta seleccionada
        if (!juntaSeleccionada) {
          console.log('[dashboard] ‚ö†Ô∏è No hay junta seleccionada para an√°lisis autom√°tico');
          showMessage('‚ö†Ô∏è No hay junta seleccionada para el an√°lisis autom√°tico', 'error');
          return;
        }
        
        // Verificar que el bot√≥n no est√© deshabilitado
        if (btnSeryerTest.disabled) {
          console.log('[dashboard] ‚ö†Ô∏è Bot√≥n PROBAR ya est√° deshabilitado');
          return;
        }
        
        console.log('[dashboard] üéØ Ejecutando server_test...');
        ejecutarServerTest();
      } else {
        console.log('[dashboard] üîç Mensaje no reconocido:', event.data.type);
      }
    });
  </script>
</body>
</html>
