<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Junta</title>
  <link rel="stylesheet" href="/static/styles.css">
  <script src="/static/common.js"></script>
  <script src="/static/js/parametros_manager.js"></script>
  <style>
    body {
      padding: 24px;
      background: var(--bg-primary);
      overflow-y: auto;
      overflow-x: hidden;
      height: 100vh;
    }
    
    /* Personalizar scrollbar */
    body::-webkit-scrollbar {
      width: 12px;
    }
    
    body::-webkit-scrollbar-track {
      background: var(--bg-secondary);
      border-radius: 10px;
    }
    
    body::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 10px;
      border: 2px solid var(--bg-secondary);
    }
    
    body::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }
    
    .form-container {
      max-width: 600px;
      margin: 0 auto;
      padding-bottom: 100px;
    }
    
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--space-xl);
    }
    
    .form-group {
      margin-bottom: var(--space-lg);
    }
    
    .form-group label {
      display: block;
      margin-bottom: var(--space-sm);
      font-weight: 500;
      color: var(--text-primary);
      font-size: var(--font-size-sm);
    }
    
    .form-group input {
      width: 100%;
      padding: var(--space-md);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: var(--font-size-md);
      transition: all 0.2s ease;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(212, 20, 20, 0.1);
    }
    
    /* Estilos para campos deshabilitados */
    .form-group input:disabled,
    .form-group select:disabled {
      background-color: var(--bg-secondary) !important;
      color: var(--text-secondary);
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    .form-group input:disabled::placeholder {
      color: var(--text-secondary);
    }
    
    /* Estilos para botones deshabilitados */
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }
    
    .form-group input:disabled {
      background: var(--bg-secondary);
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    .form-actions {
      display: flex;
      gap: var(--space-md);
      justify-content: flex-end;
      margin-top: var(--space-xl);
    }
    
    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }
    
    .btn-secondary:hover {
      background: var(--surface-hover);
      border-color: var(--border-light);
    }
    
    .header {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      margin-bottom: var(--space-xl);
    }
    
    .back-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      padding: var(--space-sm);
      color: var(--text-secondary);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .back-btn:hover {
      background: var(--surface);
      color: var(--text-primary);
    }
    
    .back-btn svg {
      width: 20px;
      height: 20px;
    }
  </style>
</head>
<body>
  <div class="form-container">
    <div class="header" style="display: flex; align-items: center; gap: 16px;">
      <button class="back-btn" onclick="volver()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
          <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8"/>
        </svg>
      </button>
      <h1 id="pageTitle" style="color: var(--text-primary); margin: 0; flex: 1;">Nueva Junta</h1>
      <div class="header-actions" style="display: flex; gap: 12px; align-items: center;">
        <button id="btnGuardar" class="btn btn-primary" type="submit" form="juntaForm" style="display: none; padding: 8px 16px; font-size: 14px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
            <path d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H9.5a1 1 0 0 0-1 1v7.293l2.646-2.647a.5.5 0 0 1 .708.708l-3.5 3.5a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L7.5 9.293V2a2 2 0 0 1 2-2H14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h2.5a.5.5 0 0 1 0 1z"/>
          </svg>
          <span>Guardar</span>
        </button>
        <button id="btnEditar" class="btn btn-primary" onclick="irAEditar()" style="display: none; padding: 8px 16px; font-size: 14px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
          <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
        </svg>
        <span>Editar</span>
      </button>
      </div>
    </div>

    <div class="card">
      <form id="juntaForm" enctype="multipart/form-data">
        <div class="form-group" id="seccion-datos">
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--space-md);">
            <div>
              <label for="nombre">Nombre *</label>
              <input type="text" id="nombre" name="nombre" required placeholder="TC" style="text-transform: uppercase;">
            </div>
            <div>
              <label for="modelo">Modelo *</label>
              <input type="text" id="modelo" name="modelo" required placeholder="441">
            </div>
            <div>
              <label for="version">Versi√≥n *</label>
              <input type="text" id="version" name="version" required placeholder="20">
            </div>
          </div>
        </div>

        <div class="form-group" id="seccion-imagen">
          <label>Imagen de Referencia</label>
          <div id="imagenContainer" style="position: relative; display: inline-block; margin-top: var(--space-sm);">
            <!-- Bot√≥n de selecci√≥n SIEMPRE visible -->
            <button type="button" id="selectImageBtn" style="position: absolute; top: 8px; right: 8px; background: #dc3545; border: none; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 10;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="white" viewBox="0 0 16 16">
                <path d="M9.828 3h3.982a2 2 0 0 1 1.992 2.181l-.637 7A2 2 0 0 1 13.174 14H2.825a2 2 0 0 1-1.991-1.819l-.637-7a2 2 0 0 1 .342-1.31L.5 3a2 2 0 0 1 2-2h3.672a2 2 0 0 1 1.414.586l.828.828A2 2 0 0 0 9.828 3M2.19 4a1 1 0 0 0-.996 1.09l.637 7a1 1 0 0 0 .995.91h10.348a1 1 0 0 0 .995-.91l.637-7A1 1 0 0 0 13.81 4zm4.69-1.707A1 1 0 0 0 6.172 2H2.5a1 1 0 0 0-1 .981l.006.139q.323-.119.684-.12h5.396z"/>
              </svg>
            </button>
            
            <div id="imagenPreview" style="display: none; position: relative; max-width: 100%; max-height: 200px;">
              <canvas id="imagenCanvas" style="max-width: 100%; max-height: 200px; border-radius: var(--radius-md); border: 1px solid var(--border); cursor: pointer;" title="Click para alternar imagen original/visualizaci√≥n"></canvas>
            </div>
            <div id="imagenPlaceholder" style="width: 200px; height: 120px; border: 2px dashed var(--border); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; color: var(--text-secondary); background: var(--bg-secondary);">
              <div style="text-align: center;">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 16 16" style="margin-bottom: var(--space-sm);">
                  <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0"/>
                  <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.126L1.002 12V3a1 1 0 0 1 1-1z"/>
                </svg>
                <div style="font-size: var(--font-size-sm);">Sin imagen</div>
              </div>
            </div>
          </div>
          <input type="file" id="imagen" name="imagen" accept="image/*" style="display: none;">
        </div>

        <div class="form-group" id="seccion-parametros" style="display: none;">
          <label style="font-weight: 600; color: var(--text-primary); margin-bottom: var(--space-md);">Par√°metros del Motor</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--space-md); margin-bottom: var(--space-md);">
            <div>
              <label for="cantidadCilindros">Cantidad Cilindros</label>
              <input type="number" id="cantidadCilindros" name="cantidadCilindros" min="0" step="1" readonly style="background: var(--bg-secondary);">
            </div>
            <div>
              <label for="diametroCilindro">Di√°metro Cilindro (mm)</label>
              <input type="number" id="diametroCilindro" name="diametroCilindro" min="0" step="0.01" data-ajustable="true" style="background: var(--bg-primary);">
            </div>
            <div>
              <label for="distanciaCilindrosExtremos">Distancia Extremos (mm)</label>
              <input type="number" id="distanciaCilindrosExtremos" name="distanciaCilindrosExtremos" min="0" step="0.01" data-ajustable="true" style="background: var(--bg-primary);">
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md);">
            <div>
              <label for="anchoJunta">Ancho de la Junta (mm)</label>
              <input type="number" id="anchoJunta" name="anchoJunta" min="0" step="0.01" data-ajustable="true" style="background: var(--bg-primary); width: 100%;">
            </div>
            <div>
              <label for="altoJunta">Alto de la Junta (mm)</label>
              <input type="number" id="altoJunta" name="altoJunta" min="0" step="0.01" data-ajustable="true" style="background: var(--bg-primary); width: 100%;">
            </div>
          </div>
        </div>

        <div class="form-group" id="seccion-elementos">
          <label style="font-weight: 600; color: var(--text-primary); margin-bottom: var(--space-md);">Elementos de Marcado</label>
          
          <!-- Tabla de elementos -->
          <table style="width: 100%; border-collapse: collapse; margin-top: var(--space-sm);">
            <thead>
              <tr style="border-bottom: 2px solid var(--border-color);">
                <th style="padding: var(--space-sm); text-align: center; font-size: var(--font-size-sm); color: var(--text-secondary); width: 60px;">Select</th>
                <th style="padding: var(--space-sm); text-align: left; font-size: var(--font-size-sm); color: var(--text-secondary);">Objeto</th>
                <th style="padding: var(--space-sm); text-align: left; font-size: var(--font-size-sm); color: var(--text-secondary);">Valor</th>
                <th style="padding: var(--space-sm); text-align: center; font-size: var(--font-size-sm); color: var(--text-secondary); width: 90px;">X (mm)</th>
                <th style="padding: var(--space-sm); text-align: center; font-size: var(--font-size-sm); color: var(--text-secondary); width: 90px;">Y (mm)</th>
                <th style="padding: var(--space-sm); text-align: center; font-size: var(--font-size-sm); color: var(--text-secondary); width: 70px;">Vertical</th>
              </tr>
            </thead>
            <tbody>
              <!-- Muescas -->
              <tr style="border-bottom: 1px solid var(--border-color);">
                <td style="padding: var(--space-sm); text-align: center;">
                  <input type="radio" id="radioMuescas" name="elementoActivo" value="muescas" checked style="width: auto; margin: 0;">
                </td>
                <td style="padding: var(--space-sm); color: var(--text-primary); font-weight: 500;">Muescas</td>
                <td style="padding: var(--space-sm);">
                  <input type="number" id="cantidadMuescas" name="cantidadMuescas" min="0" step="1" placeholder="0" style="width: 100%; padding: 6px; margin: 0;">
                </td>
                <td style="padding: var(--space-sm);">
                  <input type="number" id="muescaX" name="muescaX" step="0.1" placeholder="0.0" style="width: 100%; padding: 6px; margin: 0;">
                </td>
                <td style="padding: var(--space-sm);">
                  <input type="number" id="muescaY" name="muescaY" step="0.1" placeholder="0.0" style="width: 100%; padding: 6px; margin: 0;">
                </td>
                <td style="padding: var(--space-sm); text-align: center;">
                  <input type="checkbox" id="muescasVertical" name="muescasVertical" style="width: auto; margin: 0;">
                </td>
              </tr>
              
              <!-- Illinois -->
              <tr style="border-bottom: 1px solid var(--border-color);">
                <td style="padding: var(--space-sm); text-align: center;">
                  <input type="radio" id="radioIllinois" name="elementoActivo" value="illinois" style="width: auto; margin: 0;">
                </td>
                <td style="padding: var(--space-sm); color: var(--text-primary); font-weight: 500;">ILLINOIS</td>
                <td style="padding: var(--space-sm); color: var(--text-secondary); font-size: var(--font-size-sm);">266x4 mm</td>
                <td style="padding: var(--space-sm);">
                  <input type="number" id="illinoisX" name="illinoisX" step="0.1" placeholder="0.0" style="width: 100%; padding: 6px; margin: 0;">
                </td>
                <td style="padding: var(--space-sm);">
                  <input type="number" id="illinoisY" name="illinoisY" step="0.1" placeholder="0.0" style="width: 100%; padding: 6px; margin: 0;">
                </td>
                <td style="padding: var(--space-sm); text-align: center;">
                  <input type="checkbox" id="illinoisVertical" name="illinoisVertical" style="width: auto; margin: 0;">
                </td>
              </tr>
              
              <!-- C√≥digo -->
              <tr style="border-bottom: 1px solid var(--border-color);">
                <td style="padding: var(--space-sm); text-align: center;">
                  <input type="radio" id="radioCodigo" name="elementoActivo" value="codigo" style="width: auto; margin: 0;">
                </td>
                <td style="padding: var(--space-sm); color: var(--text-primary); font-weight: 500;">C√≥digo</td>
                <td style="padding: var(--space-sm); color: var(--text-secondary); font-size: var(--font-size-sm);">123456 (4mm)</td>
                <td style="padding: var(--space-sm);">
                  <input type="number" id="codigoX" name="codigoX" step="0.1" placeholder="0.0" style="width: 100%; padding: 6px; margin: 0;">
                </td>
                <td style="padding: var(--space-sm);">
                  <input type="number" id="codigoY" name="codigoY" step="0.1" placeholder="0.0" style="width: 100%; padding: 6px; margin: 0;">
                </td>
                <td style="padding: var(--space-sm); text-align: center;">
                  <input type="checkbox" id="codigoVertical" name="codigoVertical" style="width: auto; margin: 0;">
                </td>
              </tr>
              
              <!-- Lote -->
              <tr>
                <td style="padding: var(--space-sm); text-align: center;">
                  <input type="radio" id="radioLote" name="elementoActivo" value="lote" style="width: auto; margin: 0;">
                </td>
                <td style="padding: var(--space-sm); color: var(--text-primary); font-weight: 500;">Lote</td>
                <td style="padding: var(--space-sm); color: var(--text-secondary); font-size: var(--font-size-sm);">23-45 (4mm)</td>
                <td style="padding: var(--space-sm);">
                  <input type="number" id="loteX" name="loteX" step="0.1" placeholder="0.0" style="width: 100%; padding: 6px; margin: 0;">
                </td>
                <td style="padding: var(--space-sm);">
                  <input type="number" id="loteY" name="loteY" step="0.1" placeholder="0.0" style="width: 100%; padding: 6px; margin: 0;">
                </td>
                <td style="padding: var(--space-sm); text-align: center;">
                  <input type="checkbox" id="loteVertical" name="loteVertical" style="width: auto; margin: 0;">
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="form-actions" style="display: none;">
          <!-- Los botones se movieron al header -->
        </div>
      </form>
    </div>
    
    <!-- Secci√≥n de Parametrizaci√≥n -->
    <div class="form-group" style="margin-top: 32px; padding: 24px; background: var(--bg-secondary); border-radius: 8px; border: 2px solid #dc3545;">
      <h3 style="color: #dc3545; margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
          <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
        </svg>
        Parametrizaci√≥n Requerida
      </h3>
      
      <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 16px; margin-bottom: 16px;">
        <p style="margin: 0; color: #856404; font-weight: 500;">
          <strong>‚ö†Ô∏è Importante:</strong> No se puede guardar una junta si no ha sido parametrizada previamente. 
          La parametrizaci√≥n es necesaria para establecer las medidas y coordenadas de referencia.
        </p>
      </div>
      
      <div style="display: flex; justify-content: center;">
        <button type="button" class="btn btn-secondary" id="parametrizarBtn" style="background: #dc3545; color: white; border: 2px solid #dc3545; padding: 12px 24px; font-size: 16px; font-weight: 600; border-radius: 6px; display: flex; align-items: center; gap: 8px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
              <path d="M5.5 2A1.5 1.5 0 0 1 7 3.5v9A1.5 1.5 0 0 1 5.5 14h-3A1.5 1.5 0 0 1 1 12.5v-9A1.5 1.5 0 0 1 2.5 2zm6 0A1.5 1.5 0 0 1 13 3.5v9a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 7 12.5v-9A1.5 1.5 0 0 1 8.5 2z"/>
            </svg>
          <span>Parametrizar Imagen</span>
          </button>
        </div>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    let juntaId = urlParams.get('id');
    let mode = urlParams.get('mode'); // 'view' o 'edit'
    let currentJuntaId = juntaId; // Variable para tracking del ID actual
    
    // Funci√≥n para deshabilitar/habilitar campos seg√∫n el modo
    function toggleCamposEdicion() {
      const campos = [
        'nombre', 'modelo', 'version', 'cantidadCilindros', 'diametroCilindro', 
        'distanciaCilindrosExtremos', 'anchoJunta', 'altoJunta', 'cantidadMuescas',
        'muescaX', 'muescaY', 'illinoisX', 'illinoisY', 'codigoX', 'codigoY',
        'loteX', 'loteY'
      ];
      
      const checkboxes = [
        'muescasVertical', 'illinoisVertical', 'codigoVertical', 'loteVertical'
      ];
      
      const radios = [
        'radioMuescas', 'radioIllinois', 'radioCodigo', 'radioLote'
      ];
      
      const isDisabled = mode === 'view';
      
      // Deshabilitar/habilitar campos de texto y n√∫mero
      campos.forEach(id => {
        const campo = document.getElementById(id);
        if (campo) {
          campo.disabled = isDisabled;
        }
      });
      
      // Deshabilitar/habilitar checkboxes
      checkboxes.forEach(id => {
        const checkbox = document.getElementById(id);
        if (checkbox) {
          checkbox.disabled = isDisabled;
        }
      });
      
      // Deshabilitar/habilitar radio buttons
      radios.forEach(id => {
        const radio = document.getElementById(id);
        if (radio) {
          radio.disabled = isDisabled;
        }
      });
      
      // Deshabilitar/habilitar bot√≥n de subir imagen
      const imagenBtn = document.getElementById('imagen');
      if (imagenBtn) {
        imagenBtn.disabled = isDisabled;
      }
    }

    // Actualizar t√≠tulo con nombre compuesto
    function updateTitulo() {
      const nombre = document.getElementById('nombre').value.trim().toUpperCase();
      const modelo = document.getElementById('modelo').value.trim();
      const version = document.getElementById('version').value.trim();
      
      const titulo = document.getElementById('pageTitle');
      const baseText = juntaId ? (mode === 'view' ? 'Ver Junta' : 'Editar Junta') : 'Nueva Junta';
      
      if (nombre && modelo && version) {
        titulo.textContent = `${baseText} ${nombre}-${modelo}-${version}`;
      } else {
        titulo.textContent = baseText;
      }
      
      // Controlar estado de los campos seg√∫n el modo
      toggleCamposEdicion();
      
      // Mostrar botones seg√∫n el modo
      const btnEditar = document.getElementById('btnEditar');
      const btnGuardar = document.getElementById('btnGuardar');
      const parametrizarBtn = document.getElementById('parametrizarBtn');
      
      if (btnEditar) {
        btnEditar.style.display = mode === 'view' ? 'inline-flex' : 'none';
      }
      
      if (parametrizarBtn) {
        parametrizarBtn.style.display = mode === 'edit' ? 'flex' : 'none';
      }
      
      if (btnGuardar) {
        if (mode === 'edit') {
          btnGuardar.style.display = 'inline-flex';
          // Solo habilitar si est√° parametrizada
          if (parametrosManager.estaParametrizada()) {
            btnGuardar.disabled = false;
            btnGuardar.style.opacity = '1';
          } else {
            btnGuardar.disabled = true;
            btnGuardar.style.opacity = '0.5';
          }
        } else {
          btnGuardar.style.display = 'none';
        }
      }
    }
    
    // Listeners para actualizar t√≠tulo
    document.getElementById('nombre').addEventListener('input', updateTitulo);
    document.getElementById('modelo').addEventListener('input', updateTitulo);
    document.getElementById('version').addEventListener('input', updateTitulo);
    
    // Bot√≥n para seleccionar imagen
    document.getElementById('selectImageBtn').addEventListener('click', function() {
      document.getElementById('imagen').click();
    });
    
    // Variables globales para el sistema de overlay
    let datosAnalisis = null;     // Datos del an√°lisis completo
    let imagenOriginal = null;    // Imagen original {nombre}.jpg
    let imagenVisualizacion = null; // Imagen de an√°lisis {nombre}_visualizacion.jpg
    let mostrandoVisualizacion = false; // true = visualizaci√≥n, false = original
    let canvas = null;            // Referencia al canvas
    let ctx = null;               // Contexto del canvas
    
    // Variables para calibraci√≥n manual
    let valoresOriginales = {
      diametro_cilindro_px: null,     // Di√°metro en p√≠xeles (calculado del √°rea)
      distancia_extremos_px: null,    // Distancia en p√≠xeles
      ancho_junta_px: null,           // Ancho del bounding box en p√≠xeles
      alto_junta_px: null,            // Alto del bounding box en p√≠xeles
      mm_por_pixel: null              // Escala original
    };
    
    // Preview de imagen
    document.getElementById('imagen').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          // Crear imagen temporal para el canvas
          const img = new Image();
          img.onload = function() {
            imagenOriginal = img;
            inicializarCanvas();
            actualizarCanvas();
            document.getElementById('imagenPreview').style.display = 'block';
            document.getElementById('imagenPlaceholder').style.display = 'none';
          };
          img.src = e.target.result;
          
          // Mostrar bot√≥n Parametrizar solo en modo edici√≥n
          const parametrizarBtn = document.getElementById('parametrizarBtn');
          if (parametrizarBtn) {
            parametrizarBtn.style.display = mode === 'edit' ? 'flex' : 'none';
          }
          
          // Resetear im√°genes procesadas (ya no necesario con el nuevo sistema)
        };
        reader.readAsDataURL(file);
      } else {
        document.getElementById('imagenPreview').style.display = 'none';
        document.getElementById('imagenPlaceholder').style.display = 'flex';
        const parametrizarBtn = document.getElementById('parametrizarBtn');
        if (parametrizarBtn) {
          parametrizarBtn.style.display = mode === 'edit' ? 'flex' : 'none';
        }
      }
    });
    
    // Funci√≥n para parametrizar la imagen
    async function parametrizarImagen() {
      const btnParametrizar = document.getElementById('parametrizarBtn');
      btnParametrizar.disabled = true;
      btnParametrizar.textContent = 'Procesando...';
      
      try {
        // Obtener nombre compuesto para guardar la visualizaci√≥n
        const nombre = document.getElementById('nombre').value.trim().toUpperCase();
        const modelo = document.getElementById('modelo').value.trim();
        const version = document.getElementById('version').value.trim();
        const nombreCompuesto = `${nombre}-${modelo}-${version}`;
        
        const formData = new FormData();
        
        // Agregar nombre de la junta
        if (nombre && modelo && version) {
          formData.append('nombre_junta', nombreCompuesto);
        }
        
        // Agregar ID si estamos editando
        if (juntaId) {
          formData.append('junta_id', juntaId);
        }
        
        // Si ya hay una escala calibrada manualmente, enviarla al servidor
        if (valoresOriginales.mm_por_pixel && valoresOriginales.mm_por_pixel !== 0.1) {
          formData.append('mm_por_pixel_manual', valoresOriginales.mm_por_pixel);
          console.log(`[junta] Usando escala calibrada: ${valoresOriginales.mm_por_pixel.toFixed(4)} mm/px`);
        }
        
        // Verificar si hay un archivo nuevo seleccionado
        const imagenFile = document.getElementById('imagen').files[0];
        
        if (imagenFile) {
          // Caso 1: Nueva imagen seleccionada desde el input
          formData.append('imagen', imagenFile);
          console.log('[junta] Usando imagen nueva del input');
        } else if (imagenOriginalUrl) {
          // Caso 2: Usar SIEMPRE la imagen original del servidor (sin muescas/textos)
          console.log('[junta] Usando imagen ORIGINAL del servidor:', imagenOriginalUrl);
          const imgResponse = await fetch(imagenOriginalUrl);
          const imgBlob = await imgResponse.blob();
          formData.append('imagen', imgBlob, 'imagen.jpg');
        } else {
          alert('No hay imagen para parametrizar');
          return;
        }
        
        // Enviar al servidor para procesar
        const response = await fetch('/api/juntas/parametrizar', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (result.ok) {
          // Guardar datos del an√°lisis
          if (result.analisis && result.analisis.ok) {
            datosAnalisis = result.analisis;
            console.log('[junta] ‚úì An√°lisis completo guardado');
            console.log('[junta] Contorno principal:', datosAnalisis.contorno_principal);
            console.log('[junta] Total agujeros:', datosAnalisis.agujeros.length);
            console.log('[junta] Momentos de Hu:', datosAnalisis.momentos_hu);
            
            // Guardar imagen de visualizaci√≥n si viene en la respuesta
            if (result.imagen_visualizacion) {
              // Crear objeto Image desde los datos base64
              const img = new Image();
              img.onload = function() {
                imagenVisualizacion = img;
                console.log('[junta] ‚úì Imagen de visualizaci√≥n cargada');
              };
              img.src = `data:image/jpeg;base64,${result.imagen_visualizacion}`;
              console.log('[junta] üí° Haz click en la imagen para ver el overlay');
            } else {
              // Si no viene, solicitarla por separado (fallback)
              solicitarVisualizacion();
            }
            
            // Inicializar manager de par√°metros si no est√° inicializado
            if (!parametrosManager.junta) {
              parametrosManager.inicializar({
                id: juntaId,
                nombre: nombreCompuesto,
                parametrizado: false,
                px_mm: 1.0,
                parametros_proporcionales: null
              });
            }
            
            // Actualizar par√°metros del motor (esto habilitar√° los controles autom√°ticamente)
            actualizarParametrosMotor(datosAnalisis);
            
            // Actualizar t√≠tulo para refrescar estado del bot√≥n Guardar
            updateTitulo();
          } else {
            datosAnalisis = null;
            imagenVisualizacion = null;
            console.log('[junta] ‚ö†Ô∏è No se pudo completar el an√°lisis');
            ocultarParametrosMotor();
          }
          
          // Actualizar canvas con imagen procesada si viene en la respuesta
          if (result.imagen_fondo_negro) {
            const img = new Image();
            img.onload = function() {
              imagenOriginal = img;
              actualizarCanvas();
            };
            img.src = `data:image/jpeg;base64,${result.imagen_fondo_negro}`;
          }
          
          alert('‚úì Imagen procesada correctamente');
          console.log('[junta] Imagen procesada - Fondo detectado:', result.fondo_detectado);
        } else {
          alert('Error procesando imagen: ' + (result.error || 'Error desconocido'));
        }
      } catch (e) {
        console.error('Error parametrizando imagen:', e);
        alert('Error de conexi√≥n al parametrizar');
      } finally {
        btnParametrizar.disabled = false;
        btnParametrizar.style.background = '#495057';
        btnParametrizar.style.color = 'white';
        btnParametrizar.style.border = '2px solid #dc3545';
        btnParametrizar.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M5.5 2A1.5 1.5 0 0 1 7 3.5v9A1.5 1.5 0 0 1 5.5 14h-3A1.5 1.5 0 0 1 1 12.5v-9A1.5 1.5 0 0 1 2.5 2zm6 0A1.5 1.5 0 0 1 13 3.5v9a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 7 12.5v-9A1.5 1.5 0 0 1 8.5 2z"/>
          </svg>
          Parametrizar
        `;
      }
    }
    
    // Event listener para el bot√≥n Parametrizar
    document.getElementById('parametrizarBtn').addEventListener('click', parametrizarImagen);
    
    // Funci√≥n para solicitar la imagen de visualizaci√≥n
    async function solicitarVisualizacion() {
      if (!imagenFondoBlanco || !datosAnalisis) {
        console.log('[junta] No hay datos para generar visualizaci√≥n');
        return;
      }
      
      try {
        console.log('[junta] Solicitando imagen de visualizaci√≥n...');
        
        const response = await fetch('/api/juntas/visualizar', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            imagen_fondo_blanco: imagenFondoBlanco,
            analisis: datosAnalisis
          })
        });
        
        const result = await response.json();
        
        if (result.ok && result.imagen_visualizacion) {
          // Crear objeto Image desde los datos base64
          const img = new Image();
          img.onload = function() {
            imagenVisualizacion = img;
            console.log('[junta] ‚úì Imagen de visualizaci√≥n cargada');
          };
          img.src = `data:image/jpeg;base64,${result.imagen_visualizacion}`;
          console.log('[junta] üí° Haz click en la imagen para ver el overlay');
        } else {
          console.log('[junta] ‚ö†Ô∏è No se pudo generar la visualizaci√≥n');
        }
      } catch (e) {
        console.error('[junta] Error solicitando visualizaci√≥n:', e);
      }
    }
    
    // ============================================================
    // SISTEMA DE OVERLAY CON CANVAS
    // ============================================================
    
    // Inicializar canvas
    function inicializarCanvas() {
      canvas = document.getElementById('imagenCanvas');
      ctx = canvas.getContext('2d');
      console.log('[canvas] Canvas inicializado');
    }
    
    // Cargar imagen en el canvas
    function cargarImagenEnCanvas(imagen) {
      if (!canvas || !ctx || !imagen) return;
      
      // Configurar dimensiones del canvas
      canvas.width = imagen.naturalWidth;
      canvas.height = imagen.naturalHeight;
      
      // Dibujar imagen
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(imagen, 0, 0);
      
      console.log('[canvas] Imagen cargada:', imagen.src);
    }
    
    // Dibujar elementos del overlay (solo en imagen original)
    function dibujarElementosOverlay() {
      if (!canvas || !ctx || !datosAnalisis || !datosAnalisis.linea_referencia) {
        console.log('[overlay] No se pueden dibujar elementos - datos faltantes');
        return;
      }
      
      // Solo dibujar si estamos mostrando la imagen original
      if (mostrandoVisualizacion) {
        console.log('[overlay] No dibujar elementos - mostrando visualizaci√≥n');
        return;
      }
      
      console.log('[overlay] Dibujando elementos en imagen original...');
      
      // Obtener punto medio del segmento rojo (origen)
      const puntoMedio = datosAnalisis.linea_referencia.punto_medio_px;
      const origenX = puntoMedio[0];
      const origenY = puntoMedio[1];
      
      // Obtener escala mm_por_pixel
      let mm_por_pixel;
      let px_mm; // Tambi√©n necesitamos px_mm para el tama√±o del texto
      if (parametrosManager.junta && parametrosManager.estaParametrizada() && parametrosManager.px_mm > 0) {
        px_mm = parametrosManager.px_mm;
        mm_por_pixel = 1.0 / px_mm;
      } else {
        mm_por_pixel = datosAnalisis.parametros.mm_por_pixel;
        px_mm = 1.0 / mm_por_pixel;
      }
      
      console.log('[overlay] Origen:', origenX, origenY, 'mm_por_pixel:', mm_por_pixel);
      console.log('[overlay] parametrosManager.px_mm:', parametrosManager.px_mm);
      console.log('[overlay] datosAnalisis.parametros.mm_por_pixel:', datosAnalisis.parametros.mm_por_pixel);
      console.log('[overlay] px_mm usado:', px_mm);
      
      // Dibujar muescas
      const cantidadMuescas = parseInt(document.getElementById('cantidadMuescas').value) || 0;
      if (cantidadMuescas > 0) {
        const muescaX = parseFloat(document.getElementById('muescaX').value) || 0;
        const muescaY = parseFloat(document.getElementById('muescaY').value) || 0;
        const vertical = document.getElementById('muescasVertical').checked;
        
        console.log('[overlay] Muesca datos:', { cantidadMuescas, muescaX, muescaY, vertical });
        
        ctx.fillStyle = 'red';
        const radioMuesca = 2.0 / mm_por_pixel; // 2mm de radio
        const separacion = 7.0 / mm_por_pixel; // 7mm de separaci√≥n
        
        console.log('[overlay] Radio muesca:', radioMuesca, 'Separaci√≥n:', separacion);
        
        for (let i = 0; i < cantidadMuescas; i++) {
          let x, y;
          if (vertical) {
            x = origenX + (muescaX / mm_por_pixel);
            y = origenY + (muescaY / mm_por_pixel) + (i * separacion);
          } else {
            x = origenX + (muescaX / mm_por_pixel) + (i * separacion);
            y = origenY + (muescaY / mm_por_pixel);
          }
          
          console.log(`[overlay] Muesca ${i}: (${x.toFixed(1)}, ${y.toFixed(1)}) radio: ${radioMuesca.toFixed(1)}`);
          
          ctx.beginPath();
          ctx.arc(x, y, radioMuesca, 0, 2 * Math.PI);
          ctx.fill();
        }
        
        console.log('[overlay] Muescas dibujadas:', cantidadMuescas);
      }
      
      // Dibujar textos
      const textos = [
        { id: 'illinois', texto: 'ILLINOIS' },
        { id: 'codigo', texto: '123456' },
        { id: 'lote', texto: '23-45' }
      ];
      
      console.log('[overlay] Dibujando textos...');
      
      ctx.fillStyle = 'red';
      
      // Calcular tama√±o del texto: 6mm fijos
      const alturaTextoMm = 6.0; // 6mm de altura fija
      const tama√±oTextoPx = alturaTextoMm * px_mm; // Convertir a p√≠xeles: 6mm √ó px_mm
      
      ctx.font = `${tama√±oTextoPx}px Arial`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      
      console.log('[overlay] Font size:', tama√±oTextoPx.toFixed(2), 'px =', alturaTextoMm, 'mm √ó', px_mm.toFixed(4), 'px/mm');
      
      textos.forEach(tipo => {
        const x = parseFloat(document.getElementById(`${tipo.id}X`).value) || 0;
        const y = parseFloat(document.getElementById(`${tipo.id}Y`).value) || 0;
        const vertical = document.getElementById(`${tipo.id}Vertical`).checked;
        
        console.log(`[overlay] ${tipo.id}: (${x}, ${y}) vertical: ${vertical}`);
        
        if (x !== 0 || y !== 0) {
          const textX = origenX + (x / mm_por_pixel);
          const textY = origenY + (y / mm_por_pixel);
          
          console.log(`[overlay] ${tipo.id} posici√≥n: (${textX.toFixed(1)}, ${textY.toFixed(1)})`);
          
          if (vertical) {
            ctx.save();
            ctx.translate(textX, textY);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText(tipo.texto, 0, 0);
            ctx.restore();
          } else {
            ctx.fillText(tipo.texto, textX, textY);
          }
        }
      });
      
      console.log('[overlay] Elementos dibujados');
    }
    
    // Actualizar canvas completo
    function actualizarCanvas() {
      if (!canvas || !ctx) return;
      
      // Cargar la imagen correspondiente
      const imagenActual = mostrandoVisualizacion ? imagenVisualizacion : imagenOriginal;
      if (imagenActual) {
        cargarImagenEnCanvas(imagenActual);
        
        // Dibujar elementos solo si es imagen original
        if (!mostrandoVisualizacion) {
          dibujarElementosOverlay();
        }
      }
    }

    // Toggle entre imagen original y visualizaci√≥n
    function toggleImagen() {
      console.log('[toggle] Alternando imagen...');
      mostrandoVisualizacion = !mostrandoVisualizacion;
      
      console.log('[toggle] Mostrando visualizaci√≥n:', mostrandoVisualizacion);
      
      // Actualizar canvas con la imagen correspondiente
      actualizarCanvas();
      
      if (mostrandoVisualizacion) {
        console.log('[toggle] ‚úì Mostrando imagen de visualizaci√≥n');
      } else {
        console.log('[toggle] ‚úì Mostrando imagen original con elementos');
      }
    }
    
    // Event listener para toggle con click en el canvas
    document.getElementById('imagenCanvas').addEventListener('click', function(e) {
      console.log('[debug] Click detectado en canvas - button:', e.button);
      
      // Si estamos en modo VIEW, no permitir edici√≥n
      if (mode === 'view' && !imagenVisualizacion) {
        console.log('[canvas] No hay visualizaci√≥n disponible para mostrar');
        return;
      }
      
      // Si estamos en modo EDIT y no hay rueda presionada, alternar imagen
      if (!e.button || e.button === 0) {
        // Click izquierdo normal - alternar entre original y visualizaci√≥n
        console.log('[canvas] Procesando click izquierdo para toggle');
        
        if (imagenVisualizacion) {
          toggleImagen();
        } else {
          console.log('[canvas] ‚ÑπÔ∏è No hay imagen de visualizaci√≥n disponible');
        }
      } else {
        console.log('[canvas] Click no es izquierdo, ignorando');
      }
    });
    
    // Event listener para click de rueda (middle mouse button) - mover muescas
    const imagenElement = document.getElementById('imagenCanvas');
    if (imagenElement) {
      console.log('[debug] ‚úì Event listener registrado para imagenCanvas');
      
      // Evento de prueba para todos los botones del mouse
      imagenElement.addEventListener('mousedown', function(e) {
        console.log(`[debug] mousedown event detectado - button: ${e.button}, which: ${e.which}, buttons: ${e.buttons}`);
        console.log(`[debug] Tipo de evento: ${e.type}, target: ${e.target.id}`);
      });
      
      imagenElement.addEventListener('mousedown', function(e) {
        console.log(`[debug] mousedown event detectado - button: ${e.button}, which: ${e.which}, buttons: ${e.buttons}`);
      
      // Bot√≥n de rueda = button 1 (tambi√©n verificar e.which para compatibilidad)
      if (e.button === 1 || e.which === 2) {
        console.log('[debug] ‚úì Es click de rueda (button 1 o which 2)');
        e.preventDefault();
        
        // Deshabilitar en modo "view"
        if (mode === 'view') {
          console.log('[elemento] Click de rueda deshabilitado en modo VIEW');
          return;
        }
        
        if (!datosAnalisis || !datosAnalisis.linea_referencia) {
          console.log('[muescas] No hay an√°lisis disponible para calcular posici√≥n');
          return;
        }
        
        // Obtener coordenadas del click relativas a la imagen
        const rect = this.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const clickY = e.clientY - rect.top;
        
        // Obtener dimensiones reales de la imagen
        const imgWidth = this.width;
        const imgHeight = this.height;
        const displayWidth = rect.width;
        const displayHeight = rect.height;
        
        // Convertir coordenadas de display a coordenadas de imagen real
        const scaleX = imgWidth / displayWidth;
        const scaleY = imgHeight / displayHeight;
        const imagenX = clickX * scaleX;
        const imagenY = clickY * scaleY;
        
        // Obtener punto medio del segmento rojo (origen)
        const puntoMedio = datosAnalisis.linea_referencia.punto_medio_px;
        
        if (!puntoMedio || !Array.isArray(puntoMedio) || puntoMedio.length < 2) {
          console.log('[elemento] ‚ùå Punto medio no disponible o inv√°lido:', puntoMedio);
          return;
        }
        
        const origenX = puntoMedio[0];
        const origenY = puntoMedio[1];
        
        // Calcular coordenadas relativas al origen en p√≠xeles
        const relX_px = imagenX - origenX;
        const relY_px = imagenY - origenY;  // Y positivo = arriba
        
        // Convertir a mil√≠metros usando px_mm del manager si est√° disponible
        let mm_por_pixel;
        if (parametrosManager.junta && parametrosManager.estaParametrizada() && parametrosManager.px_mm > 0) {
          // Usar px_mm del manager (p√≠xeles por mil√≠metro) y convertir a mm_por_pixel
          mm_por_pixel = 1.0 / parametrosManager.px_mm;
          console.log(`[elemento] Usando px_mm del manager: ${parametrosManager.px_mm} ‚Üí ${mm_por_pixel.toFixed(6)} mm/px`);
        } else {
          // Fallback al mm_por_pixel del an√°lisis
          mm_por_pixel = datosAnalisis.parametros.mm_por_pixel;
          console.log(`[elemento] Usando mm_por_pixel del an√°lisis: ${mm_por_pixel}`);
        }
        
        const relX_mm = relX_px * mm_por_pixel;
        const relY_mm = relY_px * mm_por_pixel;
        
        // Detectar qu√© elemento est√° seleccionado
        const elementoActivo = document.querySelector('input[name="elementoActivo"]:checked').value;
        
        console.log(`[elemento] ‚úì Click de rueda detectado - Elemento: ${elementoActivo}`);
        console.log(`[elemento]   Posici√≥n en imagen: (${imagenX.toFixed(0)}, ${imagenY.toFixed(0)}) px`);
        console.log(`[elemento]   Posici√≥n relativa: (${relX_px.toFixed(0)}, ${relY_px.toFixed(0)}) px`);
        console.log(`[elemento]   Posici√≥n en mm: (${relX_mm.toFixed(1)}, ${relY_mm.toFixed(1)}) mm`);
        
        
        // Actualizar campos X e Y del elemento seleccionado
        switch(elementoActivo) {
          case 'muescas':
            document.getElementById('muescaX').value = relX_mm.toFixed(1);
            document.getElementById('muescaY').value = relY_mm.toFixed(1);
            console.log('[muescas] ‚úì Posici√≥n actualizada');
            // Disparar actualizaci√≥n en tiempo real (incluye todos los elementos)
            actualizarMuescasEnTiempoReal();
            break;
            
          case 'illinois':
            document.getElementById('illinoisX').value = relX_mm.toFixed(1);
            document.getElementById('illinoisY').value = relY_mm.toFixed(1);
            console.log('[illinois] ‚úì Posici√≥n actualizada');
            // Disparar actualizaci√≥n en tiempo real
            actualizarMuescasEnTiempoReal();
            break;
            
          case 'codigo':
            document.getElementById('codigoX').value = relX_mm.toFixed(1);
            document.getElementById('codigoY').value = relY_mm.toFixed(1);
            console.log('[codigo] ‚úì Posici√≥n actualizada');
            // Disparar actualizaci√≥n en tiempo real
            actualizarMuescasEnTiempoReal();
            break;
            
          case 'lote':
            document.getElementById('loteX').value = relX_mm.toFixed(1);
            document.getElementById('loteY').value = relY_mm.toFixed(1);
            console.log('[lote] ‚úì Posici√≥n actualizada');
            // Disparar actualizaci√≥n en tiempo real
            actualizarMuescasEnTiempoReal();
            break;
        }
      }
    });
    } else {
      console.log('[debug] ‚ùå No se encontr√≥ elemento imagenCanvas');
    }
    
    // Event listener adicional para auxclick (bot√≥n del medio)
    if (imagenElement) {
      imagenElement.addEventListener('auxclick', function(e) {
      console.log(`[debug] auxclick event detectado - button: ${e.button}`);
      
      if (e.button === 1) {
        console.log('[debug] ‚úì Es auxclick de rueda (button 1)');
        e.preventDefault();
        
        // Deshabilitar en modo "view"
        if (mode === 'view') {
          console.log('[elemento] Click de rueda deshabilitado en modo VIEW');
          return;
        }
        
        if (!datosAnalisis || !datosAnalisis.linea_referencia) {
          console.log('[muescas] No hay an√°lisis disponible para calcular posici√≥n');
          return;
        }
        
        // Obtener coordenadas del click relativas a la imagen
        const rect = this.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const clickY = e.clientY - rect.top;
        
        // Obtener dimensiones reales de la imagen
        const imgWidth = this.width;
        const imgHeight = this.height;
        const displayWidth = rect.width;
        const displayHeight = rect.height;
        
        // Convertir coordenadas de display a coordenadas de imagen real
        const scaleX = imgWidth / displayWidth;
        const scaleY = imgHeight / displayHeight;
        const imagenX = clickX * scaleX;
        const imagenY = clickY * scaleY;
        
        // Obtener punto medio del segmento rojo (origen)
        const puntoMedio = datosAnalisis.linea_referencia.punto_medio_px;
        
        if (!puntoMedio || !Array.isArray(puntoMedio) || puntoMedio.length < 2) {
          console.log('[elemento] ‚ùå Punto medio no disponible o inv√°lido:', puntoMedio);
          return;
        }
        
        const origenX = puntoMedio[0];
        const origenY = puntoMedio[1];
        
        // Calcular coordenadas relativas al origen en p√≠xeles
        const relX_px = imagenX - origenX;
        const relY_px = imagenY - origenY;  // Y positivo = arriba
        
        // Convertir a mil√≠metros usando px_mm del manager si est√° disponible
        let mm_por_pixel;
        if (parametrosManager.junta && parametrosManager.estaParametrizada() && parametrosManager.px_mm > 0) {
          // Usar px_mm del manager (p√≠xeles por mil√≠metro) y convertir a mm_por_pixel
          mm_por_pixel = 1.0 / parametrosManager.px_mm;
          console.log(`[elemento] Usando px_mm del manager: ${parametrosManager.px_mm} ‚Üí ${mm_por_pixel.toFixed(6)} mm/px`);
        } else {
          // Fallback al mm_por_pixel del an√°lisis
          mm_por_pixel = datosAnalisis.parametros.mm_por_pixel;
          console.log(`[elemento] Usando mm_por_pixel del an√°lisis: ${mm_por_pixel}`);
        }
        
        const relX_mm = relX_px * mm_por_pixel;
        const relY_mm = relY_px * mm_por_pixel;
        
        // Detectar qu√© elemento est√° seleccionado
        const elementoActivo = document.querySelector('input[name="elementoActivo"]:checked').value;
        
        console.log(`[elemento] ‚úì Click de rueda detectado - Elemento: ${elementoActivo}`);
        console.log(`[elemento]   Posici√≥n en imagen: (${imagenX.toFixed(0)}, ${imagenY.toFixed(0)}) px`);
        console.log(`[elemento]   Posici√≥n relativa: (${relX_px.toFixed(0)}, ${relY_px.toFixed(0)}) px`);
        console.log(`[elemento]   Posici√≥n en mm: (${relX_mm.toFixed(1)}, ${relY_mm.toFixed(1)}) mm`);
        
        
        // Actualizar campos X e Y del elemento seleccionado
        switch(elementoActivo) {
          case 'muescas':
            document.getElementById('muescaX').value = relX_mm.toFixed(1);
            document.getElementById('muescaY').value = relY_mm.toFixed(1);
            console.log('[muescas] ‚úì Posici√≥n actualizada');
            // Disparar actualizaci√≥n en tiempo real (incluye todos los elementos)
            actualizarMuescasEnTiempoReal();
            break;
            
          case 'illinois':
            document.getElementById('illinoisX').value = relX_mm.toFixed(1);
            document.getElementById('illinoisY').value = relY_mm.toFixed(1);
            console.log('[illinois] ‚úì Posici√≥n actualizada');
            // Disparar actualizaci√≥n en tiempo real
            actualizarMuescasEnTiempoReal();
            break;
            
          case 'codigo':
            document.getElementById('codigoX').value = relX_mm.toFixed(1);
            document.getElementById('codigoY').value = relY_mm.toFixed(1);
            console.log('[codigo] ‚úì Posici√≥n actualizada');
            // Disparar actualizaci√≥n en tiempo real
            actualizarMuescasEnTiempoReal();
            break;
            
          case 'lote':
            document.getElementById('loteX').value = relX_mm.toFixed(1);
            document.getElementById('loteY').value = relY_mm.toFixed(1);
            console.log('[lote] ‚úì Posici√≥n actualizada');
            // Disparar actualizaci√≥n en tiempo real
            actualizarMuescasEnTiempoReal();
            break;
        }
      }
    });
    } else {
      console.log('[debug] ‚ùå No se encontr√≥ elemento imagenCanvas para auxclick');
    }
    
    // Funci√≥n para mostrar mensaje temporal
    function mostrarMensajeTemporal(mensaje, tipo = 'info') {
      // Crear elemento de mensaje
      const mensajeDiv = document.createElement('div');
      mensajeDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${tipo === 'success' ? '#d4edda' : '#d1ecf1'};
        color: ${tipo === 'success' ? '#155724' : '#0c5460'};
        border: 1px solid ${tipo === 'success' ? '#c3e6cb' : '#bee5eb'};
        border-radius: 4px;
        padding: 12px 16px;
        font-size: 14px;
        font-weight: 500;
        z-index: 9999;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        max-width: 300px;
      `;
      mensajeDiv.textContent = mensaje;
      
      // Agregar al DOM
      document.body.appendChild(mensajeDiv);
      
      // Remover despu√©s de 3 segundos
      setTimeout(() => {
        if (mensajeDiv.parentNode) {
          mensajeDiv.parentNode.removeChild(mensajeDiv);
        }
      }, 3000);
    }
    
    // Funci√≥n para actualizar par√°metros del motor
    function actualizarParametrosMotor(analisis) {
      console.log('[junta] actualizarParametrosMotor llamada con:', analisis);
      console.log('[junta] parametrosManager estado:', {
        inicializado: !!parametrosManager.junta,
        parametrizado: parametrosManager.estaParametrizada()
      });
      
      if (!analisis || !analisis.ok) {
        console.log('[junta] An√°lisis inv√°lido o no OK, ocultando par√°metros');
        ocultarParametrosMotor();
        return;
      }
      
      const agujeros = analisis.agujeros || [];
      const agujeros_grandes = agujeros.filter(a => a.clasificacion === 'Redondo Grande');
      
      console.log('[junta] Total agujeros:', agujeros.length);
      console.log('[junta] Agujeros grandes:', agujeros_grandes.length);
      
      // Calcular cantidad de cilindros (puede ser 0 si no hay agujeros)
      const cantidadCilindros = agujeros_grandes.length;
      
      // Mostrar par√°metros incluso si no hay agujeros (para dimensiones b√°sicas)
      console.log('[junta] Mostrando par√°metros con', cantidadCilindros, 'cilindros detectados');
      
      // Guardar par√°metros proporcionales usando el manager
      parametrosManager.guardarParametrosProporcionales(analisis);
      
      // Actualizar campos usando el manager
      document.getElementById('cantidadCilindros').value = cantidadCilindros;
      
      // El manager actualizar√° autom√°ticamente todos los valores
      parametrosManager.actualizarTodosLosValores();
      
      // Mostrar secci√≥n
      const seccionParametros = document.getElementById('seccion-parametros');
      if (seccionParametros) {
        seccionParametros.style.display = 'block';
        console.log('[junta] ‚úì Secci√≥n de par√°metros mostrada');
      } else {
        console.warn('[junta] ‚ö†Ô∏è Secci√≥n de par√°metros no encontrada');
      }
      
      console.log('[junta] ‚úì Par√°metros del motor actualizados usando ParametrosManager');
    }
    
    // Funci√≥n para ocultar par√°metros del motor
    function ocultarParametrosMotor() {
      document.getElementById('seccion-parametros').style.display = 'none';
      document.getElementById('cantidadCilindros').value = '';
      document.getElementById('diametroCilindro').value = '';
      document.getElementById('distanciaCilindrosExtremos').value = '';
      document.getElementById('anchoJunta').value = '';
      document.getElementById('altoJunta').value = '';
      
      // Deshabilitar controles si no est√° parametrizada
      if (!parametrosManager.estaParametrizada()) {
        parametrosManager.deshabilitarControlesEdicion();
      }
    }
    
    /**
     * SISTEMA DE RECALIBRACI√ìN MANUAL
     * 
     * Permite ajustar la escala mm/px forzando un valor conocido manualmente
     * y recalculando todos los dem√°s par√°metros en consecuencia.
     */
    function recalibrarEscala(tipoMedida, valorRealMm) {
      if (!datosAnalisis || !datosAnalisis.ok) {
        console.log('[calibraci√≥n] No hay an√°lisis disponible para recalibrar');
        return;
      }
      
      let valorPx = null;
      
      // Obtener el valor en p√≠xeles seg√∫n el tipo de medida
      switch(tipoMedida) {
        case 'diametro_cilindro':
          valorPx = valoresOriginales.diametro_cilindro_px;
          break;
        case 'distancia_extremos':
          valorPx = valoresOriginales.distancia_extremos_px;
          break;
        case 'ancho_junta':
          valorPx = valoresOriginales.ancho_junta_px;
          break;
        case 'alto_junta':
          valorPx = valoresOriginales.alto_junta_px;
          break;
        default:
          console.error('[calibraci√≥n] Tipo de medida desconocido:', tipoMedida);
          return;
      }
      
      if (!valorPx || valorPx <= 0) {
        console.error('[calibraci√≥n] Valor en p√≠xeles inv√°lido:', valorPx);
        return;
      }
      
      // Calcular nueva escala: mm/px = mm_real / px_medido
      const nuevaEscala = valorRealMm / valorPx;
      
      console.log(`[calibraci√≥n] Recalibrando usando ${tipoMedida}:`);
      console.log(`[calibraci√≥n]   Valor real ingresado: ${valorRealMm} mm`);
      console.log(`[calibraci√≥n]   Valor medido: ${valorPx.toFixed(2)} px`);
      console.log(`[calibraci√≥n]   Escala anterior: ${valoresOriginales.mm_por_pixel.toFixed(4)} mm/px`);
      console.log(`[calibraci√≥n]   Escala nueva: ${nuevaEscala.toFixed(4)} mm/px`);
      
      // Actualizar escala en los datos de an√°lisis
      datosAnalisis.parametros.mm_por_pixel = nuevaEscala;
      valoresOriginales.mm_por_pixel = nuevaEscala;
      
      // Recalcular TODOS los valores en mm con la nueva escala
      recalcularTodosLosParametros();
    }
    
    function recalcularTodosLosParametros() {
      if (!datosAnalisis || !datosAnalisis.ok) return;
      
      const nuevaEscala = datosAnalisis.parametros.mm_por_pixel;
      
      // Recalcular di√°metro de cilindro
      if (valoresOriginales.diametro_cilindro_px) {
        const diametroMm = valoresOriginales.diametro_cilindro_px * nuevaEscala;
        document.getElementById('diametroCilindro').value = diametroMm.toFixed(2);
      }
      
      // Recalcular distancia extremos
      if (valoresOriginales.distancia_extremos_px) {
        const distanciaMm = valoresOriginales.distancia_extremos_px * nuevaEscala;
        document.getElementById('distanciaCilindrosExtremos').value = distanciaMm.toFixed(2);
      }
      
      // Recalcular ancho de junta
      if (valoresOriginales.ancho_junta_px) {
        const anchoMm = valoresOriginales.ancho_junta_px * nuevaEscala;
        document.getElementById('anchoJunta').value = anchoMm.toFixed(2);
      }
      
      // Recalcular alto de junta
      if (valoresOriginales.alto_junta_px) {
        const altoMm = valoresOriginales.alto_junta_px * nuevaEscala;
        document.getElementById('altoJunta').value = altoMm.toFixed(2);
      }
      
      // Recalcular todos los datos del an√°lisis
      recalcularAnalisisCompleto(nuevaEscala);
      
      console.log('[calibraci√≥n] ‚úì Todos los par√°metros recalculados con nueva escala');
    }
    
    function recalcularAnalisisCompleto(nuevaEscala) {
      if (!datosAnalisis || !datosAnalisis.ok) return;
      
      // Recalcular contorno principal
      if (datosAnalisis.contorno_principal) {
        const cp = datosAnalisis.contorno_principal;
        cp.area_mm2 = cp.area_px * (nuevaEscala ** 2);
        cp.perimetro_mm = cp.perimetro_px * nuevaEscala;
        cp.centroide_mm = [cp.centroide_px[0] * nuevaEscala, cp.centroide_px[1] * nuevaEscala];
        cp.bbox_width_mm = cp.bbox_width_px * nuevaEscala;
        cp.bbox_height_mm = cp.bbox_height_px * nuevaEscala;
      }
      
      // Recalcular agujeros
      if (datosAnalisis.agujeros) {
        for (const agujero of datosAnalisis.agujeros) {
          agujero.area_mm2 = agujero.area_px * (nuevaEscala ** 2);
          agujero.perimeter_mm = agujero.perimeter_px * nuevaEscala;
        }
      }
      
      // Recalcular l√≠nea de referencia
      if (datosAnalisis.linea_referencia) {
        const lr = datosAnalisis.linea_referencia;
        lr.distancia_mm = lr.distancia_px * nuevaEscala;
      }
      
      console.log('[calibraci√≥n] ‚úì Datos de an√°lisis recalculados');
    }
    
    // Event listeners para campos ajustables
    document.getElementById('diametroCilindro').addEventListener('change', function() {
      const nuevoValor = parseFloat(this.value);
      if (!isNaN(nuevoValor) && nuevoValor > 0) {
        recalibrarEscala('diametro_cilindro', nuevoValor);
      }
    });
    
    document.getElementById('distanciaCilindrosExtremos').addEventListener('change', function() {
      const nuevoValor = parseFloat(this.value);
      if (!isNaN(nuevoValor) && nuevoValor > 0) {
        recalibrarEscala('distancia_extremos', nuevoValor);
      }
    });
    
    document.getElementById('anchoJunta').addEventListener('change', function() {
      const nuevoValor = parseFloat(this.value);
      if (!isNaN(nuevoValor) && nuevoValor > 0) {
        if (parametrosManager.estaParametrizada()) {
          parametrosManager.set_valor('ancho_junta', nuevoValor);
        } else {
        recalibrarEscala('ancho_junta', nuevoValor);
        }
      }
    });
    
    document.getElementById('altoJunta').addEventListener('change', function() {
      const nuevoValor = parseFloat(this.value);
      if (!isNaN(nuevoValor) && nuevoValor > 0) {
        if (parametrosManager.estaParametrizada()) {
          parametrosManager.set_valor('alto_junta', nuevoValor);
        } else {
        recalibrarEscala('alto_junta', nuevoValor);
        }
      }
    });
    
    document.getElementById('diametroCilindro').addEventListener('change', function() {
      const nuevoValor = parseFloat(this.value);
      if (!isNaN(nuevoValor) && nuevoValor > 0) {
        if (parametrosManager.estaParametrizada()) {
          parametrosManager.set_valor('diametro_cilindro', nuevoValor);
        } else {
          recalibrarEscala('diametro_cilindro', nuevoValor);
        }
      }
    });
    
    document.getElementById('distanciaCilindrosExtremos').addEventListener('change', function() {
      const nuevoValor = parseFloat(this.value);
      if (!isNaN(nuevoValor) && nuevoValor > 0) {
        if (parametrosManager.estaParametrizada()) {
          parametrosManager.set_valor('distancia_extremos', nuevoValor);
        } else {
          recalibrarEscala('distancia_extremos', nuevoValor);
        }
      }
    });
    
    // Funci√≥n para cargar imagen con muescas (con par√°metros opcionales para tiempo real)
    async function cargarImagenConMuescas(juntaId, parametrosCustom = null) {
      try {
        if (parametrosCustom) {
          console.log('[muescas] Actualizando muescas en tiempo real...', parametrosCustom);
        } else {
          console.log('[muescas] Cargando imagen con muescas...');
        }
        
        // Verificar que tengamos an√°lisis
        if (!datosAnalisis) {
          console.log('[muescas] ‚ö†Ô∏è No hay an√°lisis disponible a√∫n');
          return;
        }
        
        let response;
        
        if (parametrosCustom) {
          // POST con par√°metros personalizados (tiempo real)
          response = await fetch(`/api/juntas/${juntaId}/imagen_con_muescas`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(parametrosCustom)
          });
        } else {
          // GET con par√°metros de la BD
          response = await fetch(`/api/juntas/${juntaId}/imagen_con_muescas`);
        }
        
        const result = await response.json();
        
        console.log('[muescas] Respuesta del servidor:', result);
        
        if (result.ok) {
          
          console.log('[muescas] Estado del canvas:', {
            mostrandoVisualizacion: mostrandoVisualizacion,
            imagenVisualizacion: !!imagenVisualizacion
          });
          
          // Actualizar canvas con elementos
          if (!mostrandoVisualizacion) {
            actualizarCanvas();
            console.log('[muescas] ‚úì Canvas actualizado con elementos');
          } else {
            console.log('[muescas] ‚ÑπÔ∏è Mostrando visualizaci√≥n, no actualizar elementos');
          }
          
          if (parametrosCustom) {
            console.log('[muescas] ‚úì Muescas actualizadas en tiempo real');
          } else {
            console.log('[muescas] ‚úì Imagen con muescas cargada');
          }
        } else {
          console.log('[muescas] ‚ùå Error:', result.error);
        }
      } catch (e) {
        console.error('[muescas] ‚ùå Excepci√≥n:', e);
      }
    }
    
    // Event listeners para actualizaci√≥n en tiempo real de muescas
    let timeoutMuescas = null;
    
    function actualizarMuescasEnTiempoReal() {
      console.log('[muescas] actualizarMuescasEnTiempoReal llamada');
      if (!datosAnalisis) {
        console.log('[muescas] ‚ùå No se puede actualizar - datosAnalisis:', !!datosAnalisis);
        return;
      }
      
      // Debounce - esperar 500ms despu√©s del √∫ltimo cambio
      clearTimeout(timeoutMuescas);
      timeoutMuescas = setTimeout(() => {
        console.log('[muescas] Ejecutando actualizaci√≥n en tiempo real...');
        
        // Actualizar canvas si estamos mostrando la imagen original
        if (!mostrandoVisualizacion) {
          actualizarCanvas();
          console.log('[muescas] ‚úì Canvas actualizado con elementos');
        } else {
          console.log('[muescas] Mostrando visualizaci√≥n, no actualizar elementos');
        }
      }, 500);
    }
    
    // Funci√≥n para habilitar/deshabilitar campos de muescas seg√∫n la cantidad
    function actualizarEstadoCamposMuescas() {
      const cantidad = parseInt(document.getElementById('cantidadMuescas').value) || 0;
      const deshabilitado = cantidad === 0;
      
      document.getElementById('muescaX').disabled = deshabilitado;
      document.getElementById('muescaY').disabled = deshabilitado;
      document.getElementById('muescasVertical').disabled = deshabilitado;
      
      if (deshabilitado) {
        document.getElementById('muescaX').style.background = 'var(--bg-secondary)';
        document.getElementById('muescaY').style.background = 'var(--bg-secondary)';
      } else {
        document.getElementById('muescaX').style.background = 'var(--bg-primary)';
        document.getElementById('muescaY').style.background = 'var(--bg-primary)';
      }
    }
    
    // Event listeners para todos los elementos (muescas, illinois, codigo, lote)
    document.getElementById('cantidadMuescas').addEventListener('input', function() {
      actualizarEstadoCamposMuescas();
      actualizarMuescasEnTiempoReal();
    });
    document.getElementById('muescaX').addEventListener('input', actualizarMuescasEnTiempoReal);
    document.getElementById('muescaY').addEventListener('input', actualizarMuescasEnTiempoReal);
    document.getElementById('muescasVertical').addEventListener('change', actualizarMuescasEnTiempoReal);
    
    document.getElementById('illinoisX').addEventListener('input', actualizarMuescasEnTiempoReal);
    document.getElementById('illinoisY').addEventListener('input', actualizarMuescasEnTiempoReal);
    document.getElementById('illinoisVertical').addEventListener('change', actualizarMuescasEnTiempoReal);
    
    document.getElementById('codigoX').addEventListener('input', actualizarMuescasEnTiempoReal);
    document.getElementById('codigoY').addEventListener('input', actualizarMuescasEnTiempoReal);
    document.getElementById('codigoVertical').addEventListener('change', actualizarMuescasEnTiempoReal);
    
    document.getElementById('loteX').addEventListener('input', actualizarMuescasEnTiempoReal);
    document.getElementById('loteY').addEventListener('input', actualizarMuescasEnTiempoReal);
    document.getElementById('loteVertical').addEventListener('change', actualizarMuescasEnTiempoReal);
    
    // Funci√≥n para cargar an√°lisis guardado
    async function cargarAnalisis(juntaId) {
      try {
        console.log('[junta] Cargando an√°lisis guardado para junta ID:', juntaId);
        
        const response = await fetch(`/api/juntas/${juntaId}/analisis`);
        const result = await response.json();
        
        console.log('[junta] Respuesta del servidor:', result);
        
        if (result.ok && result.analisis) {
          datosAnalisis = result.analisis;
          console.log('[junta] ‚úì An√°lisis cargado desde archivo');
          console.log('[junta] Datos del an√°lisis:', datosAnalisis);
          
          // Actualizar par√°metros del motor
          console.log('[junta] Llamando a actualizarParametrosMotor...');
          actualizarParametrosMotor(datosAnalisis);
        } else {
          console.log('[junta] ‚ÑπÔ∏è No hay an√°lisis guardado o error:', result.error);
        }
      } catch (e) {
        console.error('[junta] Error cargando an√°lisis:', e);
      }
    }
    
    // Funci√≥n para cargar visualizaci√≥n guardada
    async function cargarVisualizacion(juntaId) {
      try {
        console.log('[junta] Cargando visualizaci√≥n guardada...');
        
        const response = await fetch(`/api/juntas/${juntaId}/visualizacion`);
        const result = await response.json();
        
        if (result.ok && result.imagen_visualizacion) {
          // Crear objeto Image desde los datos base64
          const img = new Image();
          img.onload = function() {
            imagenVisualizacion = img;
            console.log('[junta] ‚úì Visualizaci√≥n cargada desde archivo');
          };
          img.src = `data:image/jpeg;base64,${result.imagen_visualizacion}`;
          console.log('[junta] üí° Haz click en la imagen para ver el overlay');
        } else {
          console.log('[junta] ‚ÑπÔ∏è No hay visualizaci√≥n guardada');
        }
      } catch (e) {
        console.error('[junta] Error cargando visualizaci√≥n:', e);
      }
    }
    
    async function loadJunta() {
      if (!juntaId) {
        // Modo creaci√≥n
        updateTitulo();
        return;
      }
      
      try {
        const response = await fetch(`/api/juntas/${juntaId}`);
        const data = await response.json();
        
        if (data.ok) {
          const junta = data.junta;
          
          // Separar nombre compuesto
          const partes = junta.nombre.split('-');
          if (partes.length === 3) {
            document.getElementById('nombre').value = partes[0];
            document.getElementById('modelo').value = partes[1];
            document.getElementById('version').value = partes[2];
          }
          
          updateTitulo();
          
          // Cargar datos adicionales (muescas)
          if (junta.cantidad_muescas !== undefined) {
            document.getElementById('cantidadMuescas').value = junta.cantidad_muescas;
          }
          
          // Inicializar manager de par√°metros
          parametrosManager.inicializar(junta);
          
          // Controlar estado de los controles seg√∫n parametrizaci√≥n
          if (parametrosManager.estaParametrizada()) {
            // Junta parametrizada - habilitar controles y cargar datos
            parametrosManager.habilitarControlesEdicion();
            
            // Las coordenadas de muescas se cargan directamente desde junta.muesca_x/muesca_y
            // (comentado para evitar conflictos con la carga directa)
            /*
            const coordenadas = parametrosManager.getCoordenadasMuescas();
            if (coordenadas.length > 0) {
              document.getElementById('muescaX').value = coordenadas[0][0].toFixed(2);
              document.getElementById('muescaY').value = coordenadas[0][1].toFixed(2);
            }
            */
          } else {
            // Junta no parametrizada - deshabilitar controles
            parametrosManager.deshabilitarControlesEdicion();
            
            // Solo permitir fallback para coordenadas si existen
            if (junta.centros_muescas && junta.centros_muescas.length > 0) {
              const primerCentro = junta.centros_muescas[0].centro_mm;
              document.getElementById('muescaX').value = primerCentro[0];
              document.getElementById('muescaY').value = primerCentro[1];
            }
          }
          
          if (junta.muescas_vertical !== undefined) {
            document.getElementById('muescasVertical').checked = junta.muescas_vertical;
          }
          
          // Cargar coordenadas de muescas directamente desde la junta (como los labels)
          if (junta.muesca_x !== undefined && junta.muesca_x !== null) {
            document.getElementById('muescaX').value = junta.muesca_x;
          }
          if (junta.muesca_y !== undefined && junta.muesca_y !== null) {
            document.getElementById('muescaY').value = junta.muesca_y;
          }
          
          // Actualizar estado de campos de muescas
          actualizarEstadoCamposMuescas();
          
          // Cargar datos de ILLINOIS
          if (junta.illinois_x !== undefined && junta.illinois_x !== null) {
            document.getElementById('illinoisX').value = junta.illinois_x;
          }
          if (junta.illinois_y !== undefined && junta.illinois_y !== null) {
            document.getElementById('illinoisY').value = junta.illinois_y;
          }
          if (junta.illinois_vertical !== undefined) {
            document.getElementById('illinoisVertical').checked = junta.illinois_vertical;
          }
          
          // Cargar datos de C√≥digo
          if (junta.codigo_x !== undefined && junta.codigo_x !== null) {
            document.getElementById('codigoX').value = junta.codigo_x;
          }
          if (junta.codigo_y !== undefined && junta.codigo_y !== null) {
            document.getElementById('codigoY').value = junta.codigo_y;
          }
          if (junta.codigo_vertical !== undefined) {
            document.getElementById('codigoVertical').checked = junta.codigo_vertical;
          }
          
          // Cargar datos de Lote
          if (junta.lote_x !== undefined && junta.lote_x !== null) {
            document.getElementById('loteX').value = junta.lote_x;
          }
          if (junta.lote_y !== undefined && junta.lote_y !== null) {
            document.getElementById('loteY').value = junta.lote_y;
          }
          if (junta.lote_vertical !== undefined) {
            document.getElementById('loteVertical').checked = junta.lote_vertical;
          }
          
          // Cargar im√°genes para el sistema de canvas
          if (junta.nombre) {
            // Cargar imagen original
            const imagenOriginalUrl = `/juntas_analisis/${junta.nombre}/${junta.nombre}.jpg`;
            const imagenVisualizacionUrl = `/juntas_analisis/${junta.nombre}/${junta.nombre}_visualizacion.jpg`;
            
            // Cargar imagen original
            const imgOriginal = new Image();
            imgOriginal.onload = function() {
              imagenOriginal = imgOriginal;
              console.log('[canvas] ‚úì Imagen original cargada');
              
              // Inicializar canvas y mostrar imagen original
              inicializarCanvas();
              actualizarCanvas();
              
              document.getElementById('imagenPreview').style.display = 'block';
              document.getElementById('imagenPlaceholder').style.display = 'none';
            };
            imgOriginal.src = imagenOriginalUrl;
            
            // Cargar imagen de visualizaci√≥n (opcional)
            const imgVisualizacion = new Image();
            imgVisualizacion.onload = function() {
              imagenVisualizacion = imgVisualizacion;
              console.log('[canvas] ‚úì Imagen de visualizaci√≥n cargada');
            };
            imgVisualizacion.onerror = function() {
              console.log('[canvas] ‚ÑπÔ∏è Imagen de visualizaci√≥n no disponible');
              imagenVisualizacion = null;
            };
            imgVisualizacion.src = imagenVisualizacionUrl;
            
            // Mostrar bot√≥n Parametrizar si hay imagen y estamos en modo edici√≥n
            const parametrizarBtn = document.getElementById('parametrizarBtn');
            if (parametrizarBtn) {
              parametrizarBtn.style.display = mode === 'edit' ? 'flex' : 'none';
            }
            
            // Cargar visualizaci√≥n y an√°lisis si existe
            if (junta.tiene_analisis) {
              cargarVisualizacion(junta.id);
              
              // Cargar an√°lisis primero, luego SIEMPRE cargar imagen con elementos
              cargarAnalisis(junta.id).then(() => {
                // SIEMPRE cargar imagen con elementos (muescas + textos)
                console.log('[junta] Iniciando carga de imagen con elementos...');
                cargarImagenConMuescas(junta.id);
              });
            } else {
              console.log('[junta] No tiene an√°lisis, no se pueden cargar muescas');
            }
          } else {
            document.getElementById('imagenPreview').style.display = 'none';
            document.getElementById('imagenPlaceholder').style.display = 'flex';
          }
          
          // Deshabilitar TODOS los campos en modo ver
          if (mode === 'view') {
            // Datos b√°sicos
            document.getElementById('nombre').disabled = true;
            document.getElementById('modelo').disabled = true;
            document.getElementById('version').disabled = true;
            
            // Muescas
            document.getElementById('cantidadMuescas').disabled = true;
            document.getElementById('muescaX').disabled = true;
            document.getElementById('muescaY').disabled = true;
            document.getElementById('muescasVertical').disabled = true;
            
            // Illinois
            document.getElementById('illinoisX').disabled = true;
            document.getElementById('illinoisY').disabled = true;
            document.getElementById('illinoisVertical').disabled = true;
            
            // C√≥digo
            document.getElementById('codigoX').disabled = true;
            document.getElementById('codigoY').disabled = true;
            document.getElementById('codigoVertical').disabled = true;
            
            // Lote
            document.getElementById('loteX').disabled = true;
            document.getElementById('loteY').disabled = true;
            document.getElementById('loteVertical').disabled = true;
            
            // Par√°metros del motor (si est√°n visibles)
            document.getElementById('cantidadCilindros').disabled = true;
            document.getElementById('diametroCilindro').disabled = true;
            document.getElementById('distanciaCilindrosExtremos').disabled = true;
            document.getElementById('anchoJunta').disabled = true;
            document.getElementById('altoJunta').disabled = true;
            
            // Deshabilitar radiobuttons
            document.getElementById('radioMuescas').disabled = true;
            document.getElementById('radioIllinois').disabled = true;
            document.getElementById('radioCodigo').disabled = true;
            document.getElementById('radioLote').disabled = true;
            
            // Ocultar columna "Select" completa en la tabla de elementos
            const tablaElementos = document.querySelector('#seccion-elementos table');
            if (tablaElementos) {
              // Ocultar header "Select"
              const thSelect = tablaElementos.querySelector('thead tr th:first-child');
              if (thSelect) thSelect.style.display = 'none';
              
              // Ocultar todas las celdas de radiobuttons
              const tdsSelect = tablaElementos.querySelectorAll('tbody tr td:first-child');
              tdsSelect.forEach(td => td.style.display = 'none');
            }
            
            // Ocultar botones de acci√≥n
            document.getElementById('selectImageBtn').style.display = 'none';
            const parametrizarBtn = document.getElementById('parametrizarBtn');
            if (parametrizarBtn) {
              parametrizarBtn.style.display = 'none';
            }
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
              submitBtn.style.display = 'none';
            }
          }
        }
        
        // Controlar visibilidad del bot√≥n Parametrizar
        const parametrizarBtn = document.getElementById('parametrizarBtn');
        if (parametrizarBtn) {
          parametrizarBtn.style.display = mode === 'edit' ? 'flex' : 'none';
        }
      } catch (e) {
        console.error('Error cargando junta:', e);
        alert('Error al cargar la junta');
        volver();
      }
    }
    
    document.getElementById('juntaForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const nombre = document.getElementById('nombre').value.trim().toUpperCase();
      const modelo = document.getElementById('modelo').value.trim();
      const version = document.getElementById('version').value.trim();
      
      if (!nombre || !modelo || !version) {
        alert('Por favor completa todos los campos del nombre');
        return;
      }
      
      const nombreCompuesto = `${nombre}-${modelo}-${version}`;
      
      // Generar imagen de overlay desde el canvas (solo si estamos mostrando imagen original)
      let imagenOverlayBase64 = null;
      if (canvas && ctx && !mostrandoVisualizacion) {
        // Asegurarse de que el canvas tenga la imagen original + elementos
        actualizarCanvas();
        
        // Capturar el canvas como imagen
        imagenOverlayBase64 = canvas.toDataURL('image/jpeg', 0.9);
        console.log('[guardar] ‚úì Imagen de overlay capturada desde canvas');
      }
      
      // Crear FormData para enviar archivo
      const formData = new FormData();
      formData.append('nombre', nombreCompuesto);
      
      // Agregar imagen de overlay si se gener√≥
      if (imagenOverlayBase64) {
        // Convertir DataURL a Blob
        const base64Data = imagenOverlayBase64.split(',')[1]; // Extraer solo la parte base64
        const byteString = atob(base64Data);
        const ab = new ArrayBuffer(byteString.length);
        const ia = new Uint8Array(ab);
        for (let i = 0; i < byteString.length; i++) {
          ia[i] = byteString.charCodeAt(i);
        }
        const blob = new Blob([ab], { type: 'image/jpeg' });
        formData.append('imagen_overlay', blob, `${nombreCompuesto}_overlay.jpg`);
        console.log('[guardar] ‚úì Imagen de overlay preparada para enviar');
      }
      
      // Agregar datos adicionales (muescas y textos)
      const cantidadMuescas = document.getElementById('cantidadMuescas').value;
      const muescaX = document.getElementById('muescaX').value;
      const muescaY = document.getElementById('muescaY').value;
      const muescasVertical = document.getElementById('muescasVertical').checked;
      
      if (cantidadMuescas) formData.append('cantidadMuescas', cantidadMuescas);
      if (muescaX) formData.append('muescaX', muescaX);
      if (muescaY) formData.append('muescaY', muescaY);
      formData.append('muescasVertical', muescasVertical ? 'true' : 'false');
      
      // Agregar datos de ILLINOIS (SIEMPRE, incluso si est√°n vac√≠os)
      const illinoisX = document.getElementById('illinoisX').value;
      const illinoisY = document.getElementById('illinoisY').value;
      const illinoisVertical = document.getElementById('illinoisVertical').checked;
      
      formData.append('illinoisX', illinoisX || '0');
      formData.append('illinoisY', illinoisY || '0');
      formData.append('illinoisVertical', illinoisVertical ? 'true' : 'false');
      
      // Agregar datos de C√≥digo (SIEMPRE, incluso si est√°n vac√≠os)
      const codigoX = document.getElementById('codigoX').value;
      const codigoY = document.getElementById('codigoY').value;
      const codigoVertical = document.getElementById('codigoVertical').checked;
      
      formData.append('codigoX', codigoX || '0');
      formData.append('codigoY', codigoY || '0');
      formData.append('codigoVertical', codigoVertical ? 'true' : 'false');
      
      // Agregar datos de Lote (SIEMPRE, incluso si est√°n vac√≠os)
      const loteX = document.getElementById('loteX').value;
      const loteY = document.getElementById('loteY').value;
      const loteVertical = document.getElementById('loteVertical').checked;
      
      formData.append('loteX', loteX || '0');
      formData.append('loteY', loteY || '0');
      formData.append('loteVertical', loteVertical ? 'true' : 'false');
      
      // Usar la imagen original si hay archivo seleccionado, sino el servidor ya tiene la imagen
      const imagenFile = document.getElementById('imagen').files[0];
      if (imagenFile) {
        formData.append('imagen', imagenFile);
      }
      // Si no hay archivo nuevo, el servidor mantendr√° la imagen existente
      
      // Si hay datos de an√°lisis, incluirlos
      if (datosAnalisis) {
        formData.append('analisis', JSON.stringify(datosAnalisis));
        console.log('[junta] Incluyendo datos de an√°lisis en la junta');
      }
      
      // Agregar px_mm y parametros_proporcionales desde el manager
      if (parametrosManager.junta && parametrosManager.estaParametrizada()) {
        formData.append('px_mm', parametrosManager.px_mm.toString());
        if (parametrosManager.parametros_proporcionales) {
          formData.append('parametros_proporcionales', JSON.stringify(parametrosManager.parametros_proporcionales));
        }
        console.log('[junta] Incluyendo px_mm:', parametrosManager.px_mm);
      }
      
      try {
        let response;
        if (juntaId && mode === 'edit') {
          // Actualizar junta existente
          response = await fetch(`/api/juntas/${juntaId}`, {
            method: 'PUT',
            body: formData
          });
        } else {
          // Crear nueva junta
          response = await fetch('/api/juntas', {
            method: 'POST',
            body: formData
          });
        }
        
        const result = await response.json();
        if (result.ok) {
          // Mostrar mensaje de √©xito
          const mensaje = juntaId ? '‚úì Junta actualizada correctamente' : '‚úì Junta creada correctamente';
          alert(mensaje);
          
          // Si est√°bamos creando (sin ID), actualizar la URL para modo edici√≥n
          if (!juntaId && result.junta && result.junta.id) {
            console.log('[junta] Junta creada con ID:', result.junta.id);
            // Actualizar URL sin recargar (pasar a modo edici√≥n)
            const newUrl = `/templates/junta.html?id=${result.junta.id}&mode=edit`;
            window.history.pushState({}, '', newUrl);
            // Actualizar variables globales
            juntaId = result.junta.id;
            currentJuntaId = result.junta.id;
            mode = 'edit';
            // Actualizar t√≠tulo
            updateTitulo();
          }
          
          // NO volver, quedarse en la p√°gina
        } else {
          alert('Error al guardar la junta: ' + (result.message || 'Error desconocido'));
        }
      } catch (e) {
        console.error('Error guardando junta:', e);
        alert('Error de conexi√≥n');
      }
    });
    
    function volver() {
      window.location.href = '/templates/database.html';
    }
    
    function irAEditar() {
      const urlParams = new URLSearchParams(window.location.search);
      const id = urlParams.get('id');
      if (id) {
        window.location.href = `/templates/junta.html?id=${id}&mode=edit`;
      }
    }
    
    // Cargar datos si estamos editando o viendo
    loadJunta();
  </script>
</body>
</html>

