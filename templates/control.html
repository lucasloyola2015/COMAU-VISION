<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Control</title>
  <link rel="stylesheet" href="/static/styles.css">
  <script src="/static/common.js"></script>
  <script src="/static/js/parametros_manager.js"></script>
  <style>
    body {
      padding: 24px;
      background: var(--bg-primary);
    }
    
    .control-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: var(--space-lg);
      margin-top: var(--space-xl);
    }
    
    .control-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: var(--space-md);
      padding: 32px 24px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s ease;
    }
    
    .control-card:hover {
      background: var(--surface-hover);
      border-color: var(--border-light);
      box-shadow: 0 0 0 2px rgba(212, 20, 20, 0.2) inset;
      transform: translateY(-2px);
    }
    
    .control-card svg {
      width: 48px;
      height: 48px;
      color: var(--text-primary);
    }
    
    .control-card-title {
      font-size: var(--font-size-lg);
      font-weight: 600;
      color: var(--text-primary);
      text-align: center;
    }
    
    .control-card-subtitle {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      text-align: center;
    }
    
    .resultado-ok {
      color: #22c55e;
      font-size: 20px;
      font-weight: 600;
    }
    
    .resultado-error {
      color: #ef4444;
      font-size: 20px;
      font-weight: 600;
    }
    
    #selectorJunta:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(212, 20, 20, 0.1);
    }
    
    .sugerencia-item {
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.15s ease;
      border-bottom: 1px solid var(--border);
    }
    
    .sugerencia-item:last-child {
      border-bottom: none;
    }
    
    .sugerencia-item:hover {
      background: var(--surface-hover);
    }
    
    .sugerencia-item.selected {
      background: var(--bg-secondary);
    }
  </style>
</head>
<body>
  <h1 style="color: var(--text-primary); margin-bottom: 16px;">Panel de Control</h1>
  
  <div class="card">
    <h2 style="font-size: var(--font-size-xl); margin-bottom: 12px; font-weight: 600; color: var(--text-primary);">
      Junta de Referencia
    </h2>
    
    <!-- Grid: Buscador + Miniatura -->
    <div style="display: grid; grid-template-columns: 1fr auto; gap: 24px; align-items: start;">
      <!-- Columna 1: Buscador + Info -->
      <div>
        <div style="position: relative; margin-bottom: 16px;">
          <label for="selectorJunta" style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: var(--font-size-sm); font-weight: 500;">
            Buscar Junta
          </label>
          <div style="position: relative;">
            <input 
              type="text" 
              id="selectorJunta" 
              placeholder="Escribe para buscar..."
              autocomplete="off"
              style="
                width: 100%;
                padding: 10px 14px 10px 40px;
                border: 1px solid var(--border);
                border-radius: var(--radius-md);
                background: var(--surface);
                color: var(--text-primary);
                font-size: var(--font-size-md);
                transition: all 0.2s ease;
              "
            >
            <!-- Icono de lupa -->
            <div style="
              position: absolute;
              left: 12px;
              top: 50%;
              transform: translateY(-50%);
              color: var(--text-muted);
              font-size: 16px;
              pointer-events: none;
            ">üîç</div>
          </div>
          <div id="sugerenciasJuntas" style="
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--surface);
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 var(--radius-md) var(--radius-md);
            max-height: 180px;
            overflow-y: auto;
            display: none;
            z-index: 9999;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            pointer-events: auto;
          "></div>
        </div>
        
        <!-- Informaci√≥n de dimensiones y muescas -->
        <div id="infoDimensionesMuescas" style="display: none; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-md);">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div>
              <div style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-bottom: 4px;">Dimensiones (mm)</div>
              <div id="infoDimensiones" style="font-size: var(--font-size-md); font-weight: 600; color: var(--text-primary);">-</div>
            </div>
            <div>
              <div style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-bottom: 4px;">Cantidad de Muescas</div>
              <div id="infoCantidadMuescas" style="font-size: var(--font-size-md); font-weight: 600; color: var(--text-primary);">-</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Columna 2: Solo Miniatura -->
      <div id="miniaturaContainer" style="display: none; padding: 18px; background: var(--bg-secondary); border-radius: var(--radius-md);">
        <img id="miniaturaJunta" src="" alt="Junta" 
             style="width: 360px; height: 270px; object-fit: contain; border: 1px solid var(--border); border-radius: var(--radius-sm); background: #000; cursor: pointer; transition: transform 0.2s ease;"
             onmouseover="this.style.transform='scale(1.05)'"
             onmouseout="this.style.transform='scale(1)'">
      </div>
    </div>
    
    <div id="sinJunta" style="text-align: center; padding: 24px; color: var(--text-secondary); display: none;">
      Selecciona una junta desde el selector
    </div>
    
    <!-- Tabla Compacta -->
    <table id="tablaComparacion" style="width: 100%; border-collapse: collapse; margin-top: 12px; font-size: var(--font-size-sm);">
      <thead>
        <tr style="border-bottom: 2px solid var(--border);">
          <th style="text-align: left; padding: 6px 8px; color: var(--text-secondary); font-size: var(--font-size-xs); font-weight: 600;">Dato</th>
          <th style="text-align: center; padding: 6px 8px; color: var(--text-secondary); font-size: var(--font-size-xs); font-weight: 600;">Esperado</th>
          <th style="text-align: center; padding: 6px 8px; color: var(--text-secondary); font-size: var(--font-size-xs); font-weight: 600;">Obtenido</th>
          <th style="text-align: center; padding: 6px 8px; color: var(--text-secondary); font-size: var(--font-size-xs); font-weight: 600;">Acierto</th>
          <th style="text-align: center; padding: 6px 8px; color: var(--text-secondary); font-size: var(--font-size-xs); font-weight: 600;">Estado</th>
        </tr>
      </thead>
      <tbody style="font-size: var(--font-size-sm);">
        <tr style="border-bottom: 1px solid var(--border);">
          <td style="padding: 6px 8px; color: var(--text-primary);">Pistones</td>
          <td id="esperadoPistones" style="text-align: center; padding: 6px 8px; color: var(--text-primary);">-</td>
          <td id="obtenidoPistones" style="text-align: center; padding: 6px 8px; color: var(--text-primary);">-</td>
          <td id="aciertoPistones" style="text-align: center; padding: 6px 8px; color: var(--text-primary);">-</td>
          <td id="resultadoPistones" style="text-align: center; padding: 6px 8px; color: var(--text-primary);">-</td>
        </tr>
        <tr style="border-bottom: 1px solid var(--border);">
          <td style="padding: 6px 8px; color: var(--text-primary);">Distancia (mm)</td>
          <td id="esperadoDistancia" style="text-align: center; padding: 6px 8px; color: var(--text-primary);">-</td>
          <td id="obtenidoDistancia" style="text-align: center; padding: 6px 8px; color: var(--text-primary);">-</td>
          <td id="aciertoDistancia" style="text-align: center; padding: 6px 8px; color: var(--text-primary);">-</td>
          <td id="resultadoDistancia" style="text-align: center; padding: 6px 8px; color: var(--text-primary);">-</td>
        </tr>
      </tbody>
    </table>
    
    <!-- Muescas inline compacto -->
    <div id="muescasInfo" style="display: none; margin-top: 16px; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-md);">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span style="color: var(--text-secondary); font-size: var(--font-size-sm);">Muescas:</span>
        <span id="cantidadMuescas" style="color: var(--text-primary); font-weight: 600; font-size: var(--font-size-sm);">-</span>
      </div>
    </div>
    
    <!-- Offset Vector -->
    <div id="offsetInfo" style="display: none; margin-top: 12px; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-md);">
      <div style="margin-bottom: 8px;">
        <span style="color: var(--text-secondary); font-size: var(--font-size-sm);">Offset Vector (ArUco ‚Üí Primera Muesca):</span>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; font-size: var(--font-size-xs);">
        <div style="text-align: center;">
          <div style="color: var(--text-muted);">X (mm)</div>
          <div id="offsetX" style="color: var(--text-primary); font-weight: 600;">-</div>
        </div>
        <div style="text-align: center;">
          <div style="color: var(--text-muted);">Y (mm)</div>
          <div id="offsetY" style="color: var(--text-primary); font-weight: 600;">-</div>
        </div>
        <div style="text-align: center;">
          <div style="color: var(--text-muted);">M√≥dulo (mm)</div>
          <div id="offsetModulo" style="color: var(--text-primary); font-weight: 600;">-</div>
        </div>
      </div>
    </div>
    
    <div id="sinMuescas" style="text-align: center; padding: 12px; color: var(--text-secondary); font-size: var(--font-size-sm); display: none;">
      No hay muescas configuradas
    </div>
    
  </div>
  
  <!-- Card de Informaci√≥n Muescas -->
  <div class="card" id="infoAdicionalCard" style="margin-top: 16px; display: none;">
    <h2 style="font-size: var(--font-size-xl); margin-bottom: 12px; font-weight: 600; color: var(--text-primary);">
      Informaci√≥n Muescas
    </h2>
    
    <!-- Coordenadas de Muescas -->
    <div id="infoMuescasContainer" style="display: none;">
      <table id="tablaMuescas" style="width: 100%; border-collapse: collapse; font-size: var(--font-size-sm);">
        <thead>
          <tr style="border-bottom: 2px solid var(--border);">
            <th style="text-align: center; padding: 6px 8px; color: var(--text-secondary); font-size: var(--font-size-xs); font-weight: 600;">ID</th>
            <th style="text-align: center; padding: 6px 8px; color: var(--text-secondary); font-size: var(--font-size-xs); font-weight: 600;">X</th>
            <th style="text-align: center; padding: 6px 8px; color: var(--text-secondary); font-size: var(--font-size-xs); font-weight: 600;">Y</th>
            <th style="text-align: center; padding: 6px 8px; color: var(--text-secondary); font-size: var(--font-size-xs); font-weight: 600;">Offset_x</th>
            <th style="text-align: center; padding: 6px 8px; color: var(--text-secondary); font-size: var(--font-size-xs); font-weight: 600;">Offset_y</th>
          </tr>
        </thead>
        <tbody id="bodyTablaMuescas">
          <!-- Las filas se insertar√°n aqu√≠ din√°micamente -->
        </tbody>
      </table>
    </div>
    <div id="noMuescasAdicional" style="display: none; text-align: center; padding: 12px; color: var(--text-secondary); font-size: var(--font-size-sm);">
      Esta junta no tiene muescas configuradas.
    </div>
  </div>
  
  <script>
    const selectorJunta = document.getElementById('selectorJunta');
    const sugerenciasDiv = document.getElementById('sugerenciasJuntas');
    
    // Junta seleccionada
    let juntaSeleccionada = null;
    let todasLasJuntas = [];
    let sugerenciaSeleccionadaIndex = -1;
    
    // ============================================================
    // CONFIGURACI√ìN DEL SERVIDOR DE VISI√ìN
    // ============================================================
    
    async function configurarServidorVision(junta) {
      try {
        console.log('[control] üîß Configurando servidor de visi√≥n para junta:', junta.nombre);
        
        // Inicializar el manager de par√°metros
        parametrosManager.inicializar(junta);
        
        // Preparar lista de muescas usando el manager
        let listaMuescas = [];
        if (parametrosManager.estaParametrizada()) {
          const coordenadas = parametrosManager.getCoordenadasMuescas();
          listaMuescas = coordenadas.map(coord => ({
            x: Math.round(-coord[0]),  // Redondear a entero y cambiar signo
            y: Math.round(-coord[1])   // Redondear a entero y cambiar signo
          }));
        }
        
        // Preparar ROI usando el manager
        const dimensiones = parametrosManager.getDimensionesROI();
        
        console.log('[control] üîç DEBUG - Dimensiones calculadas:', dimensiones);
        
        // Cargar configuraci√≥n de ROI desde el sistema de visi√≥n
        let roiOffsetX = 0;
        let roiOffsetY = 10; // Valor por defecto
        let roiZoomX = 100;  // 100% por defecto
        let roiZoomY = 100;  // 100% por defecto
        
        try {
          const configResponse = await fetch('/api/vision/config');
          const config = await configResponse.json();
          
          if (config.vision) {
            roiOffsetX = config.vision.roi_offset_x_mm || 0;
            roiOffsetY = config.vision.roi_offset_y_mm || 10;
            roiZoomX = config.vision.roi_zoom_x_percent || 100;
            roiZoomY = config.vision.roi_zoom_y_percent || 100;
            
            console.log('[control] üìê Configuraci√≥n ROI cargada:', {
              offset_x: roiOffsetX,
              offset_y: roiOffsetY,
              zoom_x: roiZoomX,
              zoom_y: roiZoomY
            });
          }
        } catch (e) {
          console.warn('[control] ‚ö†Ô∏è No se pudo cargar configuraci√≥n ROI, usando valores por defecto');
        }
        
        // Calcular dimensiones finales aplicando zoom
        const widthFinal = Math.round((roiZoomX * dimensiones.width_mm) / 100);
        const heightFinal = Math.round((roiZoomY * dimensiones.height_mm) / 100);
        
        const roiConfig = {
          x_mm: roiOffsetX,
          y_mm: roiOffsetY,
          width_mm: widthFinal,
          height_mm: heightFinal,
          rotation: 0
        };
        
        console.log('[control] üìç Muescas a enviar:', listaMuescas.length);
        console.log('[control] üìê ROI a enviar:', roiConfig);
        console.log('[control] üîç Dimensiones originales:', dimensiones);
        console.log('[control] üîç Zoom aplicado:', { x: roiZoomX + '%', y: roiZoomY + '%' });
        
        // Enviar configuraci√≥n al servidor de visi√≥n
        const response = await fetch('/api/vision_server/configure', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            lista_muescas_mm: listaMuescas,
            roi_rectangulo: roiConfig
          })
        });
        
        const result = await response.json();
        
        if (result.ok) {
          console.log('[control] ‚úÖ Servidor de visi√≥n configurado exitosamente');
        } else {
          console.warn('[control] ‚ö†Ô∏è Error configurando servidor de visi√≥n:', result.error);
        }
        
        // Configurar ROI en el servidor de visi√≥n usando la nueva funci√≥n
        try {
          const roiResponse = await fetch('/api/vision_server/configure_roi', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          
          const roiResult = await roiResponse.json();
          
          if (roiResult.ok) {
            console.log('[control] ‚úÖ Configuraci√≥n de ROI aplicada en servidor de visi√≥n');
          } else {
            console.warn('[control] ‚ö†Ô∏è Error configurando ROI:', roiResult.mensaje);
          }
        } catch (e) {
          console.warn('[control] ‚ö†Ô∏è Error configurando ROI:', e);
        }
        
      } catch (e) {
        console.error('[control] ‚ùå Error configurando servidor de visi√≥n:', e);
      }
    }

    // Cargar junta seleccionada
    async function cargarJuntaSeleccionada() {
      try {
        console.log('[control] üöÄ Iniciando cargarJuntaSeleccionada...');
        const response = await fetch('/api/juntas/selected');
        console.log('[control] üì• Respuesta del fetch:', response);
        const result = await response.json();
        console.log('[control] üì¶ Datos JSON recibidos:', result);

        if (result.ok && result.junta) {
          console.log('[control] ‚úì Junta v√°lida recibida. Mostrando datos para:', result.junta.nombre);
          juntaSeleccionada = result.junta;
          await mostrarJunta(juntaSeleccionada, true); // <-- CORRECCI√ìN: A√±adido 'true'
        } else {
          // No hay junta seleccionada - estado inicial
          console.log('[control] ‚ö†Ô∏è No hay junta seleccionada o hubo un error en la respuesta:', result.error);
          ocultarJunta();
        }
      } catch (e) {
        console.error('[control] ‚ùå Error CR√çTICO en cargarJuntaSeleccionada:', e);
        ocultarJunta();
      }
    }
    
    async function mostrarJunta(junta, esSeleccionInicial = false) {
      // Mostrar miniatura y actualizar buscador con nombre
      document.getElementById('sinJunta').style.display = 'none';
      document.getElementById('miniaturaContainer').style.display = 'block';
      
      // Cargar imagen con overlay para control.html
      const overlayFilename = `${junta.nombre}_overlay.jpg`;
      const overlayUrl = `/juntas_analisis/${junta.nombre}/${overlayFilename}`;
      
      // Intentar cargar imagen con overlay
      const img = new Image();
      img.onload = function() {
        // Overlay existe, usarlo
        document.getElementById('miniaturaJunta').src = overlayUrl;
        console.log('[control] ‚úì Imagen con overlay cargada:', overlayFilename);
      };
      img.onerror = function() {
        // Overlay no existe, usar imagen original como fallback
        document.getElementById('miniaturaJunta').src = `/juntas_analisis/${junta.nombre}/${junta.imagen}`;
        console.log('[control] ‚ö†Ô∏è Overlay no encontrado, usando imagen original');
      };
      img.src = overlayUrl;
      
      // Mostrar nombre de la junta seleccionada en el buscador
      if (esSeleccionInicial) selectorJunta.value = junta.nombre;
      selectorJunta.style.fontWeight = '600';
      selectorJunta.style.color = 'var(--primary)';
      
      // Cargar an√°lisis detallado
      try {
        const response = await fetch(`/api/juntas/${junta.id}/analisis`);
        const result = await response.json();
        
        if (result.ok && result.analisis && result.analisis.ok) {
          const analisis = result.analisis;
          
          // Valores esperados
          const cantidadPistones = junta.resumen_analisis?.redondos_grandes || 0;
          const distanciaEsperada = analisis.linea_referencia?.distancia_mm || 0;
          
          document.getElementById('esperadoPistones').textContent = cantidadPistones;
          document.getElementById('esperadoDistancia').textContent = distanciaEsperada ? distanciaEsperada.toFixed(1) : '-';

          console.log('[control] ‚úì Junta cargada:', junta.nombre);
        }
      } catch (e) {
        console.error('[control] Error cargando an√°lisis:', e);
      }
      
      // Mostrar informaci√≥n de muescas
      mostrarInfoAdicional(junta);
      
      // Configurar servidor de visi√≥n con los datos de la junta
      await configurarServidorVision(junta);
    }
    
    function mostrarMuescas(junta) {
      const cantidadMuescas = junta.cantidad_muescas || 0;
      
      if (cantidadMuescas > 0) {
        // Mostrar secci√≥n de muescas compacta
        document.getElementById('sinMuescas').style.display = 'none';
        document.getElementById('muescasInfo').style.display = 'block';
        
        // Actualizar cantidad
        document.getElementById('cantidadMuescas').textContent = `${cantidadMuescas} muesca${cantidadMuescas !== 1 ? 's' : ''}`;
        
        console.log(`[control] ‚úì Mostrando ${cantidadMuescas} muescas`);
      } else {
        // No hay muescas
        document.getElementById('sinMuescas').style.display = 'block';
        document.getElementById('muescasInfo').style.display = 'none';
      }
    }
    
    function mostrarInfoAdicional(junta) {
      const infoCard = document.getElementById('infoAdicionalCard');
      infoCard.style.display = 'block';

      // Mostrar informaci√≥n de dimensiones y muescas en la columna izquierda
      const infoDimensionesMuescas = document.getElementById('infoDimensionesMuescas');
      infoDimensionesMuescas.style.display = 'block';

      // 1. Dimensiones de la junta (usando manager de par√°metros)
      parametrosManager.inicializar(junta);
      if (parametrosManager.estaParametrizada()) {
        const ancho = parametrosManager.get_valor('ancho_junta');
        const alto = parametrosManager.get_valor('alto_junta');
        document.getElementById('infoDimensiones').textContent = `${ancho.toFixed(1)} x ${alto.toFixed(1)} mm`;
      } else {
        document.getElementById('infoDimensiones').textContent = 'No parametrizada';
      }

      // 2. Cantidad de muescas
      const cantidadMuescas = junta.cantidad_muescas || 0;
      document.getElementById('infoCantidadMuescas').textContent = cantidadMuescas;

      // 3. Coordenadas de muescas
      const muescasContainer = document.getElementById('infoMuescasContainer');
      const noMuescasMsg = document.getElementById('noMuescasAdicional');
      const tablaBody = document.getElementById('bodyTablaMuescas');
      tablaBody.innerHTML = ''; // Limpiar tabla

      if (cantidadMuescas > 0 && junta.centros_muescas) {
        muescasContainer.style.display = 'block';
        noMuescasMsg.style.display = 'none';

        // Usar coordenadas calculadas din√°micamente
        const coordenadasMuescas = parametrosManager.getCoordenadasMuescas();
        coordenadasMuescas.forEach((coord, index) => {
          const [x, y] = coord;
          const muesca = junta.centros_muescas[index];
          // Obtener offsets si est√°n disponibles, sino mostrar 0.0
          const offset_x = muesca?.offset_x !== undefined ? muesca.offset_x : 0.0;
          const offset_y = muesca.offset_y !== undefined ? muesca.offset_y : 0.0;
          
          const row = `
            <tr style="border-bottom: 1px solid var(--border);">
              <td style="text-align: center; padding: 6px 8px;">${muesca.id}</td>
              <td style="text-align: center; padding: 6px 8px;">${x.toFixed(1)}</td>
              <td style="text-align: center; padding: 6px 8px;">${y.toFixed(1)}</td>
              <td style="text-align: center; padding: 6px 8px;">${offset_x.toFixed(1)}</td>
              <td style="text-align: center; padding: 6px 8px;">${offset_y.toFixed(1)}</td>
            </tr>`;
          tablaBody.innerHTML += row;
        });
      } else {
        muescasContainer.style.display = 'none';
        noMuescasMsg.style.display = 'block';
      }
    }

    function ocultarJunta() {
      document.getElementById('miniaturaContainer').style.display = 'none';
      document.getElementById('sinJunta').style.display = 'block';
      
      // Limpiar buscador
      selectorJunta.value = '';
      selectorJunta.style.fontWeight = 'normal';
      selectorJunta.style.color = 'var(--text-primary)';
      
      // Limpiar tabla
      const campos = ['Pistones', 'Distancia'];
      campos.forEach(campo => {
        document.getElementById(`esperado${campo}`).textContent = '-';
        document.getElementById(`obtenido${campo}`).textContent = '-';
        document.getElementById(`acierto${campo}`).textContent = '-';
        document.getElementById(`resultado${campo}`).textContent = '-';
      });
      
      
      // Ocultar secci√≥n de muescas
      document.getElementById('muescasInfo').style.display = 'none';
      document.getElementById('sinMuescas').style.display = 'block';
      document.getElementById('sinMuescas').textContent = 'Selecciona una junta para ver sus muescas';

      // Ocultar informaci√≥n de dimensiones y muescas
      document.getElementById('infoDimensionesMuescas').style.display = 'none';

      // Ocultar card de informaci√≥n adicional
      document.getElementById('infoAdicionalCard').style.display = 'none';
    }
    
    // ============================================================
    // SELECTOR DE JUNTA CON AUTOCOMPLETADO
    // ============================================================
    
    // Cargar todas las juntas
    async function cargarTodasLasJuntas() {
      try {
        const response = await fetch('/api/juntas');
        const result = await response.json();
        
        if (result.ok) {
          todasLasJuntas = result.juntas || [];
        }
      } catch (e) {
        console.error('[control] Error cargando juntas:', e);
      }
    }
    
    // Filtrar y mostrar sugerencias
    function mostrarSugerencias() {
      const filtro = selectorJunta.value.toLowerCase().trim();
      
      if (filtro === '') {
        sugerenciasDiv.style.display = 'none';
        sugerenciaSeleccionadaIndex = -1;
        return;
      }
      
      const juntasFiltradas = todasLasJuntas.filter(junta => 
        junta.nombre.toLowerCase().includes(filtro)
      );
      
      if (juntasFiltradas.length === 0) {
        sugerenciasDiv.innerHTML = '<div style="padding: 12px 16px; color: var(--text-secondary);">No se encontraron juntas</div>';
        sugerenciasDiv.style.display = 'block';
        return;
      }
      
      const html = juntasFiltradas.map((junta, index) => `
        <div class="sugerencia-item" data-junta-id="${junta.id}" data-junta-nombre="${junta.nombre}" data-index="${index}">
          <div style="font-weight: 500; color: var(--text-primary);">${junta.nombre}</div>
        </div>
      `).join('');
      
      sugerenciasDiv.innerHTML = html;
      sugerenciasDiv.style.display = 'block';
      sugerenciaSeleccionadaIndex = -1;
      
      console.log('[control] Sugerencias renderizadas:', juntasFiltradas.length, 'juntas');
      console.log('[control] HTML generado:', html.substring(0, 200));
    }
    
    // Seleccionar junta
    async function seleccionarJunta(juntaId) {
      try {
        console.log('[control] Seleccionando junta ID:', juntaId);
        
        // Marcar como seleccionada en el servidor
        const response = await fetch('/api/juntas/select', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: juntaId })  // ‚≠ê Cambiar 'junta_id' a 'id'
        });
        
        const result = await response.json();
        console.log('[control] Respuesta del servidor:', result);
        
        if (result.ok) {
          // Actualizar el input con el nombre PRIMERO
          const junta = todasLasJuntas.find(j => j.id === juntaId);
          if (junta) {
            selectorJunta.value = junta.nombre;
            console.log('[control] Input actualizado con:', junta.nombre);
          }
          
          // Ocultar sugerencias
          sugerenciasDiv.style.display = 'none';
          sugerenciaSeleccionadaIndex = -1;
          
          // Cargar y mostrar la junta
          await mostrarJunta(junta); // Usar la 'junta' del bucle, no 'result.junta'
          
          // Notificar al dashboard que cambi√≥ la junta
          window.parent.postMessage({ type: 'JUNTA_CHANGED', juntaId: juntaId }, '*');
          
          console.log('[control] ‚úì Junta seleccionada completamente:', juntaId);
        } else {
          console.error('[control] Error en respuesta del servidor:', result);
        }
      } catch (e) {
        console.error('[control] Error seleccionando junta:', e);
      }
    }
    
    // Event listeners del selector
    selectorJunta.addEventListener('input', mostrarSugerencias);
    
    // Event listener en el contenedor de sugerencias (delegaci√≥n de eventos)
    sugerenciasDiv.addEventListener('click', (e) => {
      console.log('[control] Click detectado en sugerenciasDiv, target:', e.target);
      
      const item = e.target.closest('.sugerencia-item');
      console.log('[control] Item encontrado:', item);
      
      if (item) {
        const juntaId = parseInt(item.dataset.juntaId);
        console.log('[control] juntaId:', juntaId);
        
        if (!isNaN(juntaId)) {
          console.log('[control] ‚úì Seleccionando junta ID:', juntaId);
          seleccionarJunta(juntaId);
        } else {
          console.error('[control] ‚úó juntaId inv√°lido:', item.dataset.juntaId);
        }
      } else {
        console.log('[control] ‚úó No se encontr√≥ .sugerencia-item');
      }
    });
    
    selectorJunta.addEventListener('keydown', (e) => {
      const items = document.querySelectorAll('.sugerencia-item');
      
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        sugerenciaSeleccionadaIndex = Math.min(sugerenciaSeleccionadaIndex + 1, items.length - 1);
        actualizarSeleccionVisual(items);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        sugerenciaSeleccionadaIndex = Math.max(sugerenciaSeleccionadaIndex - 1, -1);
        actualizarSeleccionVisual(items);
      } else if (e.key === 'Enter' && sugerenciaSeleccionadaIndex >= 0) {
        e.preventDefault();
        const juntaId = parseInt(items[sugerenciaSeleccionadaIndex].dataset.juntaId);
        seleccionarJunta(juntaId);
      } else if (e.key === 'Escape') {
        sugerenciasDiv.style.display = 'none';
        sugerenciaSeleccionadaIndex = -1;
      }
    });
    
    function actualizarSeleccionVisual(items) {
      items.forEach((item, index) => {
        if (index === sugerenciaSeleccionadaIndex) {
          item.classList.add('selected');
          item.scrollIntoView({ block: 'nearest' });
        } else {
          item.classList.remove('selected');
        }
      });
    }
    
    // Cerrar sugerencias al hacer click fuera (pero no cuando se hace click en una sugerencia)
    document.addEventListener('click', (e) => {
      const clickEnSugerencia = e.target.closest('.sugerencia-item');
      
      if (!selectorJunta.contains(e.target) && !sugerenciasDiv.contains(e.target) && !clickEnSugerencia) {
        sugerenciasDiv.style.display = 'none';
        sugerenciaSeleccionadaIndex = -1;
      }
    });
    
    // Doble click en miniatura ‚Üí ir a vista de junta
    document.getElementById('miniaturaJunta').addEventListener('dblclick', () => {
      if (juntaSeleccionada) {
        window.location.href = `/templates/junta.html?id=${juntaSeleccionada.id}&mode=view`;
      }
    });
    
    // Cargar al iniciar
    cargarTodasLasJuntas();
    cargarJuntaSeleccionada();
    
    // Escuchar mensajes del dashboard con resultados del an√°lisis
    window.addEventListener('message', async (event) => {
      console.log('[control] üîî MENSAJE RECIBIDO:', event.data.type, event.data);
      
      // NO MOSTRAR BANNERS - SOLO ACTUALIZAR TABLA
      
      // Manejar resultados de cada intento
      if (event.data.type === 'ANALYSIS_READY') {
        console.log('[control] ‚úÖ RECIBI√ì ANALYSIS_READY');
        console.log('[control] üì• Datos recibidos:', event.data.data);
        if (event.data.data) {
          console.log('[control] ‚úÖ TIENE DATOS');
        } else {
          console.log('[control] ‚ùå NO TIENE DATOS');
        }
      }
      
      // Manejar datos de trayectoria del servidor de procesamiento
      if (event.data.type === 'TRAJECTORY_DATA') {
        console.log('[control] ‚úÖ RECIBI√ì TRAJECTORY_DATA');
        console.log('[control] üì• Datos completos recibidos:', event.data);
        console.log('[control] üì• Datos de trayectoria:', event.data.data);
        console.log('[control] üì• centros_muescas:', event.data.data?.centros_muescas);
        console.log('[control] üì• trajectory_vectors:', event.data.data?.trajectory_vectors);
        actualizarTablaConTrayectoria(event.data.data);
      }
      
      if (event.data.type === 'ANALYSIS_READY' && event.data.data) {
        const data = event.data.data;
        const intento = event.data.intento || 1;
        const maxIntentos = event.data.max_intentos || 3;
        
        console.log(`[control] ========================================`);
        console.log(`[control] ACTUALIZANDO TABLA - INTENTO ${intento}/${maxIntentos}`);
        console.log(`[control] ========================================`);
        
        // Obtener configuraci√≥n de umbrales
        let umbralDistanciaTol = 98.0;
        try {
          const configResponse = await fetch('/api/vision/config');
          const config = await configResponse.json();
          umbralDistanciaTol = config.vision?.umbral_distancia_tolerancia || 98.0;
        } catch (e) {
          console.warn('[control] No se pudo cargar umbral, usando default 98%');
        }
        
        // ACTUALIZAR TABLA DE COMPARACI√ìN
        console.log('[control] Junta seleccionada:', juntaSeleccionada ? 'S√ç' : 'NO');
        console.log('[control] Datos holes:', data.holes ? 'S√ç' : 'NO');
        
        // Verificar que los elementos de la tabla existen
        const elemObtenidoPistones = document.getElementById('obtenidoPistones');
        const elemObtenidoDistancia = document.getElementById('obtenidoDistancia');
        console.log('[control] Elemento obtenidoPistones:', elemObtenidoPistones ? 'EXISTE' : 'NO EXISTE');
        console.log('[control] Elemento obtenidoDistancia:', elemObtenidoDistancia ? 'EXISTE' : 'NO EXISTE');
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ACTUALIZAR TABLA (incluso con datos parciales)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        if (juntaSeleccionada) {
          // CANTIDAD DE PISTONES (siempre disponible)
          if (data.holes && data.holes.total_detected !== undefined) {
            const esperadoPistones = parseInt(document.getElementById('esperadoPistones').textContent) || 0;
            const obtenidoPistones = data.holes.total_detected;
            
            console.log(`[control] ‚Üí Pistones: esperado=${esperadoPistones}, obtenido=${obtenidoPistones}`);
            document.getElementById('obtenidoPistones').textContent = obtenidoPistones;
            
            // C√°lculo: debe ser EXACTO (100%)
            const aciertoPistones = (esperadoPistones === obtenidoPistones) ? 100 : 0;
            document.getElementById('aciertoPistones').textContent = aciertoPistones + '%';
            
            // Resultado visual
            const resultPistonesCell = document.getElementById('resultadoPistones');
            if (aciertoPistones === 100) {
              resultPistonesCell.innerHTML = '<span class="resultado-ok">‚úì</span>';
            } else {
              resultPistonesCell.innerHTML = '<span class="resultado-error">‚úó</span>';
            }
            
            console.log(`[control] ‚úì Tabla actualizada: Pistones ${aciertoPistones}% ${aciertoPistones === 100 ? '‚úì' : '‚úó'}`);
          }
          
          // DISTANCIA ENTRE PISTONES (puede no estar disponible en early returns)
          if (data.holes && data.holes.distancia_extremos_mm !== undefined && data.holes.distancia_extremos_mm !== null) {
            const esperadoDistancia = parseFloat(document.getElementById('esperadoDistancia').textContent) || 0;
            const obtenidoDistancia = data.holes.distancia_extremos_mm;
            
            console.log(`[control] ‚Üí Distancia: esperado=${esperadoDistancia}, obtenido=${obtenidoDistancia}`);
            document.getElementById('obtenidoDistancia').textContent = obtenidoDistancia.toFixed(1);
            
            if (esperadoDistancia > 0 && obtenidoDistancia > 0) {
              // C√°lculo: tolerancia configurable
              const aciertoDistancia = 100 - Math.abs((obtenidoDistancia - esperadoDistancia) / esperadoDistancia * 100);
              document.getElementById('aciertoDistancia').textContent = aciertoDistancia.toFixed(1) + '%';
              
              // Resultado visual
              const resultDistanciaCell = document.getElementById('resultadoDistancia');
              if (aciertoDistancia >= umbralDistanciaTol) {
                resultDistanciaCell.innerHTML = '<span class="resultado-ok">‚úì</span>';
              } else {
                resultDistanciaCell.innerHTML = '<span class="resultado-error">‚úó</span>';
              }
              
              console.log(`[control] ‚úì Tabla actualizada: Distancia ${aciertoDistancia.toFixed(1)}% ${aciertoDistancia >= umbralDistanciaTol ? '‚úì' : '‚úó'}`);
            }
          } else {
            // Si no hay distancia (validaci√≥n temprana de cantidad), mostrar "Pendiente"
            if (data.validacion_temprana === 'cantidad_pistones') {
              document.getElementById('obtenidoDistancia').textContent = 'Pendiente';
              document.getElementById('aciertoDistancia').textContent = '-';
              document.getElementById('resultadoDistancia').innerHTML = '<span style="color: var(--text-muted);">‚è∏</span>';
              console.log(`[control] ‚ö†Ô∏è Distancia pendiente (validaci√≥n temprana de cantidad fall√≥)`);
            }
          }
        } else {
          console.warn('[control] ‚ö†Ô∏è No hay junta seleccionada, no se actualiza tabla');
        }
        
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ACTUALIZAR MUESCAS Y OFFSET VECTOR
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        if (data.muescas && data.muescas.length > 0) {
          document.getElementById('muescasInfo').style.display = 'block';
          document.getElementById('sinMuescas').style.display = 'none';
          document.getElementById('cantidadMuescas').textContent = data.muescas.length;
          console.log(`[control] ‚úì Muescas actualizadas: ${data.muescas.length}`);
        } else {
          document.getElementById('muescasInfo').style.display = 'none';
          document.getElementById('sinMuescas').style.display = 'block';
          console.log(`[control] ‚ö†Ô∏è No hay muescas disponibles`);
        }
        
        // ACTUALIZAR OFFSET VECTOR
        if (data.offset_vector) {
          document.getElementById('offsetInfo').style.display = 'block';
          document.getElementById('offsetX').textContent = data.offset_vector.x_mm.toFixed(2);
          document.getElementById('offsetY').textContent = data.offset_vector.y_mm.toFixed(2);
          document.getElementById('offsetModulo').textContent = data.offset_vector.modulo_mm.toFixed(2);
          console.log(`[control] ‚úì Offset vector: X=${data.offset_vector.x_mm.toFixed(2)}mm, Y=${data.offset_vector.y_mm.toFixed(2)}mm, M√≥dulo=${data.offset_vector.modulo_mm.toFixed(2)}mm`);
        } else {
          document.getElementById('offsetInfo').style.display = 'none';
          console.log(`[control] ‚ö†Ô∏è No hay offset vector disponible`);
        }
        
        // NO MOSTRAR BANNER - SOLO ACTUALIZAR TABLA
        
        console.log(`[control] ========================================`);
      }
    });
    
    // Funci√≥n para actualizar tabla con datos de trayectoria del servidor
    function actualizarTablaConTrayectoria(data) {
      console.log('[control] üîÑ Actualizando tabla con datos de trayectoria...');
      
      const centrosMuescas = data.centros_muescas || [];
      const trajectoryVectors = data.trajectory_vectors || [];
      const junta_segment_length_mm = data.junta_segment_length_mm;
      const holes_detectados = data.holes_detectados;
      
      console.log('[control] üìä Datos recibidos:', {
        centrosMuescas: centrosMuescas.length,
        trajectoryVectors: trajectoryVectors.length,
        junta_segment_length_mm: junta_segment_length_mm,
        holes_detectados: holes_detectados
      });
      
      // Actualizar valores en la tabla de validaci√≥n si est√°n disponibles
      if (junta_segment_length_mm !== undefined) {
        console.log('[control] üìè Actualizando distancia obtenida:', junta_segment_length_mm);
        document.getElementById('obtenidoDistancia').textContent = junta_segment_length_mm.toFixed(1);
        
        // Calcular acierto de distancia
        const esperadoDistancia = parseFloat(document.getElementById('esperadoDistancia').textContent) || 0;
        if (esperadoDistancia > 0) {
          const diferencia = Math.abs(esperadoDistancia - junta_segment_length_mm);
          const tolerancia = esperadoDistancia * 0.02; // 2% de tolerancia
          const aciertoDistancia = (diferencia <= tolerancia) ? 100 : Math.max(0, 100 - (diferencia / esperadoDistancia * 100));
          
          document.getElementById('aciertoDistancia').textContent = aciertoDistancia.toFixed(1) + '%';
          
          // Resultado visual
          const resultDistanciaCell = document.getElementById('resultadoDistancia');
          if (aciertoDistancia >= 98) {
            resultDistanciaCell.innerHTML = '<span class="resultado-ok">‚úì</span>';
          } else {
            resultDistanciaCell.innerHTML = '<span class="resultado-error">‚úó</span>';
          }
          
          console.log(`[control] ‚úì Distancia actualizada: ${aciertoDistancia.toFixed(1)}% ${aciertoDistancia >= 98 ? '‚úì' : '‚úó'}`);
        }
      }
      
      if (holes_detectados !== undefined) {
        console.log('[control] üîò Actualizando pistones obtenidos:', holes_detectados);
        document.getElementById('obtenidoPistones').textContent = holes_detectados;
        
        // Calcular acierto de pistones
        const esperadoPistones = parseInt(document.getElementById('esperadoPistones').textContent) || 0;
        const aciertoPistones = (esperadoPistones === holes_detectados) ? 100 : 0;
        
        document.getElementById('aciertoPistones').textContent = aciertoPistones + '%';
        
        // Resultado visual
        const resultPistonesCell = document.getElementById('resultadoPistones');
        if (aciertoPistones === 100) {
          resultPistonesCell.innerHTML = '<span class="resultado-ok">‚úì</span>';
        } else {
          resultPistonesCell.innerHTML = '<span class="resultado-error">‚úó</span>';
        }
        
        console.log(`[control] ‚úì Pistones actualizados: ${aciertoPistones}% ${aciertoPistones === 100 ? '‚úì' : '‚úó'}`);
      }
      
      if (centrosMuescas.length > 0) {
        // Actualizar cantidad de muescas
        document.getElementById('infoCantidadMuescas').textContent = centrosMuescas.length;
        
        // Mostrar contenedor de muescas
        const muescasContainer = document.getElementById('infoMuescasContainer');
        const noMuescasMsg = document.getElementById('noMuescasAdicional');
        const tablaBody = document.getElementById('bodyTablaMuescas');
        
        muescasContainer.style.display = 'block';
        noMuescasMsg.style.display = 'none';
        tablaBody.innerHTML = ''; // Limpiar tabla
        
        // Llenar tabla con datos de trayectoria (usando coordenadas calculadas)
        const coordenadasMuescas = parametrosManager.getCoordenadasMuescas();
        centrosMuescas.forEach((muesca, index) => {
          const [x, y] = coordenadasMuescas[index] || [0, 0];
          const offset_x = muesca.offset_x || 0.0;
          const offset_y = muesca.offset_y || 0.0;
          
          const row = `
            <tr style="border-bottom: 1px solid var(--border);">
              <td style="text-align: center; padding: 6px 8px;">${muesca.id}</td>
              <td style="text-align: center; padding: 6px 8px;">${x.toFixed(1)}</td>
              <td style="text-align: center; padding: 6px 8px;">${y.toFixed(1)}</td>
              <td style="text-align: center; padding: 6px 8px;">${offset_x.toFixed(1)}</td>
              <td style="text-align: center; padding: 6px 8px;">${offset_y.toFixed(1)}</td>
            </tr>`;
          tablaBody.innerHTML += row;
        });
        
        console.log(`[control] ‚úÖ Tabla actualizada con ${centrosMuescas.length} muescas`);
        console.log('[control] üìä Datos de trayectoria:', trajectoryVectors);
        
      } else {
        console.log('[control] ‚ö†Ô∏è No hay datos de muescas para mostrar');
        document.getElementById('infoCantidadMuescas').textContent = '0';
        document.getElementById('infoMuescasContainer').style.display = 'none';
        document.getElementById('noMuescasAdicional').style.display = 'block';
      }
    }
  </script>
</body>
</html>
